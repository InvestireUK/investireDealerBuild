import{r as d,h as Ht,m as e,b4 as mt,b5 as Qt,t as Xt,s as Zt,a2 as Jt,u as ce,b6 as qt,b7 as He,b8 as de,b9 as ye,ba as er,bb as tr,bc as rr,bd as ar,be as sr,bf as ir,bg as nr}from"./index-C1l7Vm-F.js";import{l as pe}from"./lodash-ConlO1gX.js";import{C as xt}from"./index-DN0_usIr.js";import{b as lr}from"./index-BrzRrm2t.js";import{X as or}from"./x-Dw9u67Uc.js";const J="/assets/aiii-qzy6FebL.webp";function cr({show:ae,onClose:z,avatars:W,onSelect:S,VideoScenes:y,activeBlock:K,videoVariables:ue}){const[G,M]=d.useState(null),[D,U]=d.useState([]),[$,Y]=d.useState(!1),[se,B]=d.useState(!1),[b,F]=d.useState(!1),[I,L]=d.useState(null),[N,ie]=d.useState("all");if(!ae)return null;const V=async w=>{var k;F(!0);try{const O=`https://api.heygen.com/v2/avatar_group/${w.id}/avatars`,ne=await fetch(O,{method:"GET",headers:{"X-Api-Key":"NmFhN2IxYTRkM2I0NDg5YThjOWExZDcwNjQ5NjdhMmMtMTc1Mzk5NzExNQ==","Content-Type":"application/json"}});if(!ne.ok)throw new Error(`HTTP ${ne.status}`);const ee=await ne.json();U(((k=ee.data)==null?void 0:k.avatar_list)||[]),M(w),Y(!0),B(!1)}catch(O){console.error("[AvatarModal] fetch error:",O)}finally{F(!1)}},q=()=>{Y(!1),M(null),U([]),L(null),B(!1)},me=()=>{B(!1),L(null)},H=w=>{L(w),B(!0)},le=W.filter(w=>{var k,O;return N==="all"?!0:N==="male"?((k=w.gender)==null?void 0:k.toLowerCase())==="male":N==="female"?((O=w.gender)==null?void 0:O.toLowerCase())==="female":!0}),Q=()=>{if(!I){console.warn("[AvatarModal] No avatar selected");return}if(!S){console.error("[AvatarModal] onSelect prop missing");return}if(!K){console.error("[AvatarModal] activeBlock (scene ID) missing");return}const w={avatar_id:I.avatar_id||I.id,preview_image_url:I.image_url||I.preview_image_url,...I};S(w,K),B(!1),L(null),Y(!1),M(null),U([])},xe=()=>{if(!I||!S||!Array.isArray(y)){console.warn("[AvatarModal] Invalid state for Apply to All");return}const w={avatar_id:I.avatar_id||I.id,preview_image_url:I.image_url||I.preview_image_url,...I};S(w,"ALL"),B(!1),L(null),Y(!1),M(null),U([])};return Ht.createPortal(e.jsxs(e.Fragment,{children:[!$&&!se&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[9999] bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-5xl relative flex flex-col max-h-[80vh] m-5 md:m-0",children:[e.jsx("button",{onClick:z,className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black z-10",children:"X"}),e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-lg font-semibold",children:"Choose an Avatar Group"})}),e.jsx("div",{className:"p-4 overflow-y-auto",children:b?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"})}):e.jsx("div",{className:"select-ai-voice-grid-wrap",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:le.length>0?le.map(w=>e.jsxs("div",{className:"cursor-pointer flex flex-col p-2 border rounded-md hover:border-blue-500 transition-colors",onClick:()=>V(w),children:[e.jsx("img",{src:w.preview_image||J,alt:w.name,className:"w-full h-32 object-contain rounded-md border",onError:k=>k.currentTarget.src=J}),e.jsxs("div",{className:"flex justify-between items-center mt-2 px-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:w.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[w.num_looks," looks"]})]})]},w.id)):e.jsx("p",{className:"col-span-full text-gray-500 text-center",children:"No avatar groups available"})})})}),e.jsx("div",{className:"flex justify-start p-4 border-t",children:e.jsx("button",{onClick:z,className:"px-4 py-2 bg-gray-300 rounded hover:bg-gray-400",children:"Back"})})]})}),$&&!se&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[9999] bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-5xl relative flex flex-col max-h-[80vh] m-5 md:m-0",children:[e.jsx("button",{onClick:z,className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black z-10",children:"X"}),e.jsx("div",{className:"p-4 border-b",children:e.jsxs("h2",{className:"text-lg font-semibold",children:[(G==null?void 0:G.name)||"Avatar"," - Select a Look"]})}),e.jsx("div",{className:"p-4 overflow-y-auto",children:b?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"})}):e.jsx("div",{className:"select-ai-voice-grid-wrap",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:D.length>0?D.map((w,k)=>e.jsxs("div",{className:"cursor-pointer flex flex-col items-center p-2 border rounded-md hover:border-purple-500 transition-colors",onClick:()=>H(w),children:[e.jsx("img",{src:w.image_url||w.preview_image_url||J,alt:w.avatar_name||`Avatar ${k+1}`,className:"w-full h-32 object-contain rounded-md border",onError:O=>O.currentTarget.src=J}),w.avatar_name&&e.jsx("p",{className:"mt-2 text-xs font-medium truncate max-w-full",children:w.avatar_name})]},w.avatar_id||w.id||k)):e.jsx("p",{className:"col-span-full text-gray-500 text-center",children:"No looks available"})})})}),e.jsx("div",{className:"flex justify-start p-4 border-t",children:e.jsx("button",{onClick:q,className:"px-4 py-2 bg-gray-300 rounded hover:bg-gray-400",children:"Back"})})]})}),se&&I&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[9999] bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-xl relative flex flex-col m-5 md:m-0",children:[e.jsx("button",{onClick:z,className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black z-10",children:"X"}),e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-lg font-semibold",children:"Confirm Avatar"})}),e.jsxs("div",{className:"p-6 flex flex-col items-center",children:[e.jsx("div",{className:"relative w-40 h-40 rounded-full overflow-hidden border-4 border-purple-500 ring-4 ring-purple-200 mb-4",children:e.jsx("img",{src:I.image_url||I.preview_image_url||J,alt:"Selected",className:"w-full h-full object-cover",onError:w=>w.currentTarget.src=J})}),e.jsx("p",{className:"text-lg font-medium text-gray-900",children:I.avatar_name||I.name||"Avatar"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Ready to apply"})]}),e.jsxs("div",{className:"p-4 border-t flex gap-3",children:[e.jsx("button",{onClick:me,className:"flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300",children:"Back"}),e.jsxs("button",{onClick:Q,className:"flex-1 px-4 py-2 bg-[#6C5DD3] text-white rounded-md hover:bg-purple-700 flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),"Apply One"]}),e.jsxs("button",{onClick:xe,className:"flex-1 px-4 py-2 bg-[#6C5DD3] text-white rounded-md flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),"Apply to All"]})]})]})}),e.jsx("style",{jsx:!0,children:`
        .loader {
          border-top-color: #3498db;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }
      `})]}),document.body)}function dr({isModalOpen:ae,setIsModalOpen:z,voices:W,selectedVoice:S,voiceKey:y,playingAudioId:K,handlePlayAudio:ue,handleVoiceSelect:G,loading:M,videoVariables:D}){const[U,$]=d.useState("all"),se=(()=>{var me,H,le,Q,xe,w,k,O;const N=y==null?void 0:y.match(/scene_(\d+)_script/);if(!N)return(me=S==null?void 0:S[y])==null?void 0:me.voice_id;const V=`voice_id_${N[1]}`;return((le=(H=D==null?void 0:D[V])==null?void 0:H.voice)==null?void 0:le.voice_id)||((xe=(Q=D==null?void 0:D[V])==null?void 0:Q.properties)==null?void 0:xe.voice_id)||((k=(w=D==null?void 0:D[V])==null?void 0:w.voice)==null?void 0:k.name)||((O=S==null?void 0:S[y])==null?void 0:O.voice_id)})(),[B,b]=d.useState(null),[F,I]=d.useState(!1),L=d.useMemo(()=>W?U==="male"?W.filter(N=>N.gender==="male"):U==="female"?W.filter(N=>N.gender==="female"):W:[],[W,U]);return ae?e.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0",onClick:()=>z(!1)}),e.jsxs("div",{className:"relative bg-white dark:bg-gray-900 w-full max-w-4xl flex flex-col max-h-[85vh] rounded-lg shadow-lg mx-5 md:mx-0",children:[e.jsx("button",{onClick:()=>z(!1),className:"absolute top-3 right-3 text-2xl text-gray-600 hover:text-black dark:text-gray-300 dark:hover:text-white",children:"âœ•"}),e.jsx("h2",{className:"text-xl font-semibold p-6 pb-3 text-black dark:text-white",children:"ðŸŽ™ï¸ Select AI Voice"}),e.jsx("div",{className:"flex justify-center gap-4 px-6 pb-4 border-b border-gray-200 dark:border-gray-700",children:["all","male","female"].map(N=>e.jsx("button",{onClick:()=>$(N),className:`px-4 py-2 rounded-md text-sm font-medium capitalize transition 
                ${U===N?"bg-[#6C5DD3] text-white":"bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700"}`,children:N},N))}),M?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx("div",{className:"w-10 h-10 border-4 border-[#6C5DD3] border-t-transparent rounded-full animate-spin"})}):e.jsx("div",{className:"overflow-y-auto px-6 pb-4 select-ai-voice-grid-wrap",children:L.length===0?e.jsx("div",{className:"text-center py-10 text-gray-500",children:"No voices available."}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:L.map(N=>e.jsx("div",{onClick:()=>b(N),className:`flex flex-col items-center justify-between p-2 rounded-lg border transition shadow-sm text-sm cursor-pointer
                        ${se===N.voice_id?"bg-[#EDF4FF] text-black/[1] border-[#6C5DD3]":"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:shadow-md"}`,children:e.jsxs("div",{className:"flex items-center gap-2 w-full min-w-0",children:[e.jsx("button",{onClick:ie=>{ie.stopPropagation(),ue(N)},className:`p-1 rounded-full transition text-sm 
                            ${se===N.voice_id?"bg-white text-[#6C5DD3]":"bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-purple-600"}`,children:K===N.voice_id?e.jsx(mt,{className:"text-base"}):e.jsx(xt,{className:"text-base"})}),e.jsx("span",{className:`font-medium truncate ${se===N.voice_id?"text-black":"text-gray-800 dark:text-gray-200"}`,children:N.name}),e.jsx("div",{className:"ml-1 flex gap-[2px] items-end flex-shrink-0",children:[...Array(5)].map((ie,V)=>e.jsx("span",{className:`w-[2px] h-2 bg-[#6C5DD3] rounded ${K===N.voice_id?"animate-pulse":"opacity-50"}`,style:{animationDelay:`${V*.1}s`}},V))})]})},N.voice_id))})}),B&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[10000] bg-black/50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg w-full max-w-xl relative flex flex-col m-5 md:m-0",children:[e.jsx("button",{onClick:()=>b(null),className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black dark:text-gray-300 dark:hover:text-white",children:"âœ•"}),e.jsx("div",{className:"p-4 border-b dark:border-gray-700",children:e.jsx("h2",{className:"text-lg font-semibold text-black dark:text-white",children:"Confirm Voice"})}),e.jsxs("div",{className:"p-6 flex flex-col items-center text-center",children:[e.jsx("div",{className:"w-24 h-24 bg-[#6C5DD3] rounded-full flex items-center justify-center text-white text-2xl font-bold mb-4",children:"ðŸŽ™ï¸"}),e.jsx("p",{className:"text-lg font-medium text-gray-900 dark:text-white",children:B.name}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Ready to apply voice"})]}),e.jsxs("div",{className:"p-4 border-t dark:border-gray-700 flex gap-3",children:[e.jsx("button",{onClick:()=>b(null),className:"flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-white",children:"Cancel"}),e.jsx("button",{disabled:F,onClick:async()=>{I(!0),await new Promise(N=>setTimeout(N,100));try{await Promise.resolve(G(B,"current")),b(null),z(!1)}finally{I(!1)}},className:"flex-1 px-4 py-2 bg-[#6C5DD3] text-white rounded-md hover:bg-purple-700 disabled:opacity-60 disabled:cursor-not-allowed",children:F?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Applying..."]}):"Apply One"}),e.jsx("button",{disabled:F,onClick:async()=>{I(!0),await new Promise(N=>setTimeout(N,100));try{await Promise.resolve(G(B,"all")),b(null),z(!1)}finally{I(!1)}},className:"flex-1 px-4 py-2 bg-[#6C5DD3] text-white rounded-md hover:bg-purple-700 disabled:opacity-60 disabled:cursor-not-allowed",children:F?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Applying..."]}):"Apply to All"})]})]})}),e.jsx("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end",children:e.jsx("button",{onClick:()=>z(!1),className:"px-5 py-2 rounded-lg bg-gray-300 hover:bg-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 transition",children:"Cancel"})})]})]}):null}function pr({show:ae,onClose:z,modalTitle:W,modalMessage:S,showProgress:y}){return ae?e.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50",onClick:z}),e.jsxs("div",{className:"absolute top-20 right-8 bg-white dark:bg-gray-900 w-full max-w-md rounded-2xl shadow-lg p-6 text-center z-50",children:[e.jsx("button",{onClick:z,className:"absolute top-3 right-3 text-2xl text-gray-600 hover:text-black dark:text-gray-300 dark:hover:text-white",children:"âœ•"}),e.jsxs("div",{className:"flex items-start gap-4",children:[y&&e.jsx(Qt,{className:"text-black animate-spin text-3xl"}),e.jsxs("div",{className:"text-start",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 dark:text-white",children:W}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mt-1",children:S})]})]}),y&&e.jsx("div",{className:"mt-6 w-full bg-gray-200 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"h-2 bg-[#6C5DD3] rounded-full animate-progress"})})]})]}):null}function jr(){const ae=Xt(),z=Zt(),W=Jt(),{templateId:S}=W.state,y=ce(t=>t.deal.VideoScenes||[]),K=ce(t=>t.deal.AiAvatars||[]),ue=ce(t=>t.deal.AiAvatarGroups||[]),G=ce(t=>t.deal.VideoVariables),M=ce(t=>t.deal.deal),{user:D}=ce(t=>t),U=Object.entries(G).filter(([t,r])=>r.type==="character").map(([t,r])=>({id:t,...r})),[$,Y]=d.useState([]),[se,B]=d.useState(null),[b,F]=d.useState(G),[I,L]=d.useState(!1),[N,ie]=d.useState(null),[V,q]=d.useState(!1),[me,H]=d.useState(""),[le,Q]=d.useState(""),[xe,w]=d.useState(!1),[k,O]=d.useState([]),[ne,ee]=d.useState(0),[ur,mr]=d.useState(""),[ht,Qe]=d.useState({}),[Xe,Se]=d.useState(!1),[ft,we]=d.useState(null),[Pe,Re]=d.useState(0),gt=150,je=5,he=ce(t=>t.deal.AiVoices||[]),[Ve,Ze]=d.useState({}),[Le,Ee]=d.useState(null),[vt,Ie]=d.useState(!1),[Je,Ne]=d.useState({}),[fe,oe]=d.useState(null),[P,ge]=d.useState(null),[ve,ze]=d.useState([]);console.log("scriptInputs",ve);const[De,qe]=d.useState(!1),[bt,et]=d.useState(),[xr,yt]=d.useState({}),wt=t=>{q(!0),Ie(!0),ie(t),setTimeout(()=>{q(!1)},1e3)},jt=["PUBLIC_PHOTO","PUBLIC","COMMUNITY_PHOTO"],Nt=ue.filter(t=>{var r;return jt.includes((r=t.group_type)==null?void 0:r.trim().toUpperCase())}),tt=t=>{if(!t||typeof t!="object")return t;const r=Array.isArray(t)?[]:{};for(const a in t){const c=t[a];if(c!=null)if(typeof c=="object"){const n=tt(c);n&&(Array.isArray(n)?n.length:Object.keys(n).length)&&(r[a]=n)}else c!==""&&(r[a]=c)}return r},_t=async(t,r)=>{try{let a=[];return{cleanedVariables:Object.fromEntries(Object.entries(r).filter(([n,i])=>{var E,A,g,m;const s=(E=i==null?void 0:i.properties)==null?void 0:E.content,l=((A=i==null?void 0:i.properties)==null?void 0:A.url)||bt,p=(g=i==null?void 0:i.properties)==null?void 0:g.character_id,x=(m=i==null?void 0:i.properties)==null?void 0:m.voice_id,u=p!=null&&String(p).trim()!==""&&String(p)!=="undefined",o=typeof s=="string"&&s.trim()!=="",f=l&&String(l).trim()!=="",h=x&&String(x).trim()!=="",_=o||f||u||h;return _||a.push(n),_})),emptyKeys:a}}catch(a){return console.error("API error:",a),{cleanedVariables:{},emptyKeys:[]}}},Oe=async(t,r,a)=>{var c;try{await ye({template_id:S,user_id:(c=D.user)==null?void 0:c.id,deal_id:M.id,variables:{...a,[t]:{...a[t],properties:{...a[t].properties,content:r}}}})}catch(n){console.error("Error saving to API",n)}};d.useEffect(()=>{fe||ge(null)},[fe]);const Be=(t="")=>t.trim()===""?0:t.trim().split(/\s+/).length,kt=async()=>{var t;try{if(Object.values(Me).some(l=>l)){Q("Word limit exceeded"),H("Please reduce words before generating the video."),L(!0);return}const{cleanedVariables:a,emptyKeys:c}=await _t(S,b);if(c.length>0){Q("Missing Fields"),H("Some fields are still missing:"),w(!1),L(!0);return}if(!a||Object.keys(a).length===0){Q("No Variables"),H("All fields are empty. Please fill them before generating."),w(!1),L(!0);return}Q("Generatingâ€¦"),H(""),w(!0),L(!0);const n=await fetch(`https://api.heygen.com/v2/template/${S}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":"NmFhN2IxYTRkM2I0NDg5YThjOWExZDcwNjQ5NjdhMmMtMTc1Mzk5NzExNQ=="},body:JSON.stringify({test:!0,variables:a,dimension:{width:1280,height:720}})});if(!n.ok)throw new Error("Failed to generate video");const i=await n.json();await er(),console.log("Credit deducted!");const s=await tr({deal:M.id,ai_video_id:(t=i==null?void 0:i.data)==null?void 0:t.video_id});if(s!=null&&s.status)sessionStorage.setItem(`video_generated_${M.id}`,"true"),ae(`/deals/deal-view/${M.id}`);else throw new Error("Failed to save generated video")}catch(r){console.error("Error during video generation:",r),w(!1),Q("Error"),H("There is some error please contact admin or try again in some time"),L(!0)}};d.useEffect(()=>{y&&y.length>0&&O(y)},[y]);const At=async()=>{var t,r,a,c,n;if(console.log("=== handlereset called ==="),!S){console.log("No template ID, exiting.");return}q(!0),console.log("Loading set to true");try{console.log("Fetching template from API...",{templateId:S,userId:(t=D.user)==null?void 0:t.id,dealId:M.id});let i;try{i=await rr({template_id:S,user_id:(r=D.user)==null?void 0:r.id,deal_id:M.id}),console.log("API response received:",i)}catch(x){console.error("API call failed:",x);return}let s=((a=i==null?void 0:i.data)==null?void 0:a.variables)??((n=(c=i==null?void 0:i.data)==null?void 0:c.data)==null?void 0:n.variables)??(i==null?void 0:i.variables)??{};console.log("Fresh variables extracted:",s);const l={};Object.keys(s).forEach(x=>{const u=s[x],o=x.replace(/_+/g,"_");u!=null&&u.properties?l[o]=u:typeof u=="string"?l[o]={properties:{content:u}}:u&&typeof u=="object"?l[o]={properties:u}:l[o]={properties:{}}}),console.log("Normalized variables:",l),console.log("Script variable names:",y.flatMap(x=>x.variables.map(u=>u.name)));let p;try{p=tt(l),console.log("Cleaned variables:",p)}catch(x){console.error("Failed to clean variables:",x),p=l}try{z(de(p)),F(p),console.log("Redux + local state updated")}catch(x){console.error("Failed to update state:",x)}console.log("Cleaned variable keys:",Object.keys(p));try{const x=y.map(u=>({id:u.id,scripts:u.variables.filter(o=>o.type==="text"&&o.name.endsWith("_script")).map(o=>{var f,h;return{name:o.name,value:((h=(f=p[o.name])==null?void 0:f.properties)==null?void 0:h.content)||""}})}));ze(x),console.log("Script inputs reset:",x)}catch(x){console.error("Failed to reset script inputs:",x)}yt({}),et(null),Ze({}),rt({}),ie(null),Ee(null),Ne({}),oe(null),Y([]),ge(null),console.log("Other states reset"),console.log("Reset successful! Back to original template.")}catch(i){console.error("Reset failed:",i)}finally{q(!1),console.log("Loading set to false")}};d.useEffect(()=>{console.log("videoVariables state updated (local):",b),console.log("Redux VideoVariables (from selector):",G)},[b,G]),d.useEffect(()=>{if(y&&y.length>0){const t=y.map(r=>{const a=r.variables.filter(c=>c.type==="text"&&c.name.endsWith("_script")).map(c=>{var n,i;return{name:c.name,value:((i=(n=b[c.name])==null?void 0:n.properties)==null?void 0:i.content)||""}});return{id:r.id,scripts:a}});ze(t)}},[y]);const Ct=d.useRef({}),_e=d.useRef({}),[Me,rt]=d.useState({}),ke=40,St=(t,r,a)=>{const n=Be(a)>ke;if(ze(i=>i.map(s=>s.id===t?{...s,scripts:s.scripts.map(l=>l.name===r?{...l,value:a}:l)}:s)),rt(i=>({...i,[r]:n?`Maximum ${ke} words allowed`:""})),n){_e.current[r]&&clearTimeout(_e.current[r]);return}_e.current[r]&&clearTimeout(_e.current[r]),_e.current[r]=setTimeout(async()=>{var u;const i=ve.find(o=>o.id===t),s=i==null?void 0:i.scripts.find(o=>o.name===r),l=(s==null?void 0:s.value)||"";if(l.trim().split(/\s+/).filter(Boolean).length>ke){console.warn("Blocked: Exceeded 40 words");return}const x=pe.cloneDeep(b);x[r]||(x[r]={properties:{}}),x[r].properties.content=l,F(x),z(de(x));try{await ye({template_id:S,user_id:(u=D.user)==null?void 0:u.id,deal_id:M.id,variables:x})}catch(o){console.error("Error saving script",o)}setTimeout(()=>{Ct.current[r]=!1},500)},800)};d.useEffect(()=>{if(b&&Object.keys(b).length>0){const t={};Object.entries(b).forEach(([r,a])=>{var c;(c=a==null?void 0:a.properties)!=null&&c.content&&(t[r]=a.properties.content)}),Object.keys(t).length>0&&Qe(r=>({...t,...r}))}},[b]);function Et(t){const r=t.name,{name:a,type:c}=t||{};if(!a||!c||!a.includes("__")||a.endsWith("_script"))return null;const n=a.split("__").filter(Boolean),i=n[0],s=n.slice(1);let l=null,p=null,x=null,u={},o=[];const f=[];let h=null,_=!1,E=!1,A=!1;for(const g of s)if(g==="FI")l="1 / -1",p="1 / -1",x="FI";else if(g.startsWith("P_")){const m=g.split("_");if(m.length===5){const j=+m[1],v=+m[2],C=+m[3],T=+m[4];[j,v,C,T].every(Number.isFinite)&&(l=`${j} / ${C+1}`,p=`${v} / ${T+1}`,x=`${j}-${v}-${C}-${T}`)}}else if(g.startsWith("BG_")){const m=g.replace("BG_","").trim();/^[0-9a-fA-F]{6}$/.test(m)&&(u.background=`#${m}`)}else if(g.startsWith("JL"))u.justifyContent="left";else if(g.startsWith("JR"))u.justifyContent="right";else if(g.startsWith("JC"))u.justifyContent="center";else if(g.startsWith("FR_C"))o.push("circle-frame");else if(g.startsWith("PD_")){const m=g.split("_");if(m.length===5){const j=+m[1],v=+m[2],C=+m[3],T=+m[4];[j,v,C,T].every(Number.isFinite)&&(u.padding=`${j}px ${T}px ${C}px ${v}px`)}}else if(g.startsWith("Z_")){const m=+g.split("_")[1];Number.isFinite(m)&&(u.zIndex=m)}else if(g.startsWith("AL_")||g.startsWith("BL_")){const m=g.split("_");if(m.length===5){const j=+m[1],v=+m[2],C=+m[3],T=+m[4];[j,v,C,T].every(Number.isFinite)&&f.push({kind:g.startsWith("AL_")?"AL":"BL",sc:j,sr:v,ec:C,er:T,gridCol:`${j} / ${C+1}`,gridRow:`${v} / ${T+1}`,raw:g})}}else if(g.startsWith("F_")){const m=g.split("_");if(m.length>=2){const j=+m[1];Number.isFinite(j)&&(h=j);const v=m[2]||"";_=v.includes("B"),E=v.includes("I"),A=v.includes("U")}}return!l&&f.length===0?null:{id:i,type:c,gridCol:l,gridRow:p,key:x,elStyle:u,classes:o,lines:f,sceneId:r,fontSize:h,bold:_,italic:E,underline:A}}function It(t){const r=(t||"").toLowerCase();return r.startsWith("header")?"header":r.startsWith("subtitle")?"subtitle":r.startsWith("title")?"title":r.startsWith("callout")?"callout":""}function zt(t){if(!t)return"Enter text...";let r=t;return r.includes("__")&&(r=r.split("__")[0]),r=r.replace(/_P_\d+_\d+_\d+_\d+.*$/,""),r=r.replace(/_FI.*$/,""),r=r.replace(/_BG_[a-fA-F0-9]+.*$/,""),r=r.replace(/_FR_C.*$/,""),r=r.replace(/_PD_\d+_\d+_\d+_\d+.*$/,""),r=r.replace(/_Z_\d+.*$/,""),r=r.replace(/_AL_\d+_\d+_\d+_\d+.*$/,""),r=r.replace(/_BL_\d+_\d+_\d+_\d+.*$/,""),r||t}const $e=new Map,Ae=new Map,Dt=async(t,r)=>{if($e.has(t))return $e.get(t);if(Ae.has(t))return Ae.get(t);r(a=>({...a,[t]:!0}));try{const a=fetch(`https://api.heygen.com/v2/avatar/${t}/details`,{method:"GET",headers:{"X-API-KEY":"NmFhN2IxYTRkM2I0NDg5YThjOWExZDcwNjQ5NjdhMmMtMTc1Mzk5NzExNQ==","Content-Type":"application/json"}}).then(n=>{if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return n.json()});Ae.set(t,a);const c=await a;return $e.set(t,c),Ae.delete(t),c}catch(a){return console.error("Error fetching avatar details:",a),Ae.delete(t),null}finally{r(a=>({...a,[t]:!1}))}},[Te,Mt]=d.useState({}),[$t,Tt]=d.useState({}),We=d.useRef(new Set),Ge=d.useRef(!0);d.useEffect(()=>()=>{Ge.current=!1},[]);const at=d.useMemo(()=>{const t=new Set;return y.forEach(r=>{var c,n;const a=r.variables.find(i=>i.type==="character");if(a){const i=(n=(c=b[a.name])==null?void 0:c.properties)==null?void 0:n.character_id;i&&t.add(i)}}),Array.from(t)},[y,b]);d.useEffect(()=>{at.forEach(t=>{!$e.has(t)&&!Te[t]&&!We.current.has(t)&&(We.current.add(t),Dt(t,Tt).then(r=>{Ge.current&&r&&Mt(a=>({...a,[t]:r}))}).catch(r=>{Ge.current&&(console.error("Failed to fetch avatar details:",r),We.current.delete(t))}))})},[at]);function Ft({sceneId:t,elStyle:r,classes:a,videoVariables:c,setVideoVariables:n,dispatch:i,isThumbnail:s}){var _,E,A,g;const l=d.useRef(null),[p,x]=d.useState({}),u=/^cc_bgimg\d+_cc__FI__Z_0$/.test(t),o="https://investier.visionvivante.in/storage/deal_images/GJO5G81JE5jkAtseXrJjUyphnBjEc3QvTOj2bwVO.jpg?text="+encodeURIComponent(t),f=p[t]||((E=(_=c[t])==null?void 0:_.properties)==null?void 0:E.url)||((g=(A=c[t])==null?void 0:A.properties)==null?void 0:g.image)||o,h=async(m,j,v)=>{var C;try{await ye({template_id:S,user_id:(C=D.user)==null?void 0:C.id,deal_id:M.id,variables:{...j,[m]:{...j[m],properties:{...j[m].properties,url:v}}}})}catch(T){console.error("Error saving image",T)}};return e.jsxs("div",{className:"sceneblock",style:{padding:r==null?void 0:r.padding,zIndex:r==null?void 0:r.zIndex},children:[e.jsx("div",{className:`image ${a!=null&&a.includes("circle-frame")?"circle-frame":""}`,onClick:()=>{var m;!s&&!u&&((m=l.current)==null||m.click())},style:{cursor:s?"default":"pointer"},children:e.jsx("img",{alt:t,src:f,className:a!=null&&a.includes("circle-frame")?"circle-frame":""})}),!s&&!u&&e.jsx("input",{type:"file",accept:"image/*",ref:l,style:{display:"none"},onChange:async m=>{const j=m.target.files[0];if(!j)return;const v=new FormData;v.append("image",j);let C;try{C=await nr(v)}catch(be){console.log(be)}const T=new FileReader;T.onload=be=>{be.target.result;const R=pe.cloneDeep(c);R[t]||(R[t]={properties:{}}),R[t].properties.url=C.data.url,n(R),i(de(R)),x(te=>({...te,[t]:C.data.url})),et(C.data.url),h(t,R,C.data.url)},T.readAsDataURL(j)}})]},t)}function Pt(t,r=!1){var m,j,v,C,T,be;const{id:a,type:c,elStyle:n={},classes:i=[],sceneId:s,fontSize:l,bold:p,italic:x,underline:u}=t;if(c==="image")return n.background?e.jsx("div",{className:"sceneblock",style:{padding:n.padding,zIndex:n.zIndex},children:e.jsx("div",{className:"image",style:{background:n.background}})},a):e.jsx(Ft,{sceneId:s,elStyle:n,classes:i,videoVariables:b,setVideoVariables:F,dispatch:z,templateId:S,user:D,deal:M},a);if(c==="character"){const R=y.find(Z=>Z.id===s),te=R==null?void 0:R.variables.find(Z=>Z.type==="character"),re=(te==null?void 0:te.name)||s,X=(j=(m=b[re])==null?void 0:m.properties)==null?void 0:j.character_id,Ce=(C=(v=b[re])==null?void 0:v.properties)==null?void 0:C.image,Ke=K.find(Z=>Z.avatar_id===X)||K.find(Z=>{const ut=U.find(Kt=>Kt.id===s);return ut&&Z.avatar_id===ut.properties.character_id}),Ut=Ce||((be=(T=Te[X])==null?void 0:T.data)==null?void 0:be.preview_image_url)||(Ke==null?void 0:Ke.preview_image_url)||`https://investier.visionvivante.in/storage/profile/images/default-avatar.png?text=${encodeURIComponent(a)}`,Yt=$t[X];return e.jsx("div",{className:"sceneblock",style:{padding:n==null?void 0:n.padding,zIndex:n==null?void 0:n.zIndex},children:e.jsx("div",{className:`avatar ${i!=null&&i.includes("circle-frame")?"circle-frame":""}`,children:Yt?e.jsx("div",{className:"loading-placeholder",children:"Loading..."}):e.jsx("img",{alt:a,src:Ut,className:`cursor-pointer ${i!=null&&i.includes("circle-frame")?"circle-frame":""} w-100 h-100 object-cover`,onClick:()=>{we(s),Se(!0)},onError:Z=>{Z.target.src.includes("default-avatar.png")||(Z.target.src=`https://investier.visionvivante.in/storage/profile/images/default-avatar.png?text=${encodeURIComponent(a)}`)}})})},a)}const[o,f]=d.useState({}),h=R=>{const te=R.currentTarget.textContent,re=R.currentTarget.id,X=pe.cloneDeep(b);X[re]||(X[re]={properties:{}}),X[re].properties.content=te,F(X),z(de(X)),Qe(Ce=>({...Ce,[re]:te})),Oe(re,te,X),f(Ce=>({...Ce,[re]:!0}))},_=["cc_titleplaceholder","cc_hero_cc","cc_img","cc_ds_name_cc","cc_phone_cc","cc_email_cc"],E=/^cc_plh\d+_cc/.test(s),A=!r&&(E||_.some(R=>s.startsWith(R))||!s.startsWith("cc_")),g=r&&l?l*.5:l;return e.jsx("div",{contentEditable:A,suppressContentEditableWarning:!0,id:s,className:`text ${It(s)} ${r?"thumbnail-text":""}`,style:{...n,fontSize:g?`${g}px`:void 0,fontWeight:p?"bold":"normal",fontStyle:x?"italic":"normal",textDecoration:u?"underline":"none",cursor:A?"text":"not-allowed"},onFocus:()=>{A&&f(R=>({...R,[s]:!0}))},onBlur:h,children:ht[s]||zt(s)},s)}function st(t){const r=t.match(/__VP_(\d+)$/);return r?parseInt(r[1],10):1/0}function it({scene:t,index:r,isThumbnail:a=!1}){const c=d.useMemo(()=>(t.variables||[]).map(Et).filter(Boolean),[t]),n=d.useMemo(()=>{const i=new Map;for(const s of c)s.key&&(i.has(s.key)||i.set(s.key,[]),i.get(s.key).push(s));for(const[s,l]of i.entries())l.sort((p,x)=>{const u=st(p.sceneId),o=st(x.sceneId);return u-o});return i},[c]);return e.jsxs("div",{className:"scene-root",children:[!a&&e.jsxs("div",{className:"scene-badge",children:["Scene ",r+1]}),e.jsxs("div",{className:"grid",children:[[...n.entries()].map(([i,s])=>e.jsx("div",{className:"area-wrapper",style:{gridColumn:s[0].gridCol,gridRow:s[0].gridRow},children:s.map(l=>Pt(l,!1))},i)),c.flatMap(i=>(i.lines||[]).map((s,l)=>{const p=s.sc===s.ec,x=s.sr===s.er,u={gridColumn:s.gridCol,gridRow:s.gridRow,display:"flex",width:"100%",height:"100%",boxSizing:"border-box",pointerEvents:"none",zIndex:30};return p?e.jsx("div",{className:"line-wrapper",style:{...u,justifyContent:s.kind==="BL"?"flex-start":"flex-end",alignItems:"stretch"},children:e.jsx("div",{style:{width:2,height:"100%",background:s.kind==="AL"?"#0b1220":"#6b7280",opacity:s.kind==="AL"?1:.9}})},`${s.raw}-${l}`):x?e.jsx("div",{className:"line-wrapper",style:{...u,alignItems:s.kind==="BL"?"flex-start":"flex-end",justifyContent:"stretch"},children:e.jsx("div",{style:{height:3,width:"100%",background:s.kind==="AL"?"#0b1220":"transparent",borderTop:s.kind==="BL"?"2px dashed #6b7280":void 0}})},`${s.raw}-${l}`):e.jsx("div",{className:"line-wrapper",style:{...u,alignItems:"center",justifyContent:"center"},children:e.jsx("div",{style:{height:2,width:"100%",background:"#0b1220"}})},`${s.raw}-${l}`)}))]})]})}d.useEffect(()=>{const t=r=>{k.length&&(r.key==="ArrowLeft"&&ee(a=>(a-1+k.length)%k.length),r.key==="ArrowRight"&&ee(a=>(a+1)%k.length))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[k.length]);const Rt=async t=>{try{const a=await(await fetch("https://api.heygen.com/v2/voices",{method:"GET",headers:{"Content-Type":"application/json","X-API-KEY":"NmFhN2IxYTRkM2I0NDg5YThjOWExZDcwNjQ5NjdhMmMtMTc1Mzk5NzExNQ=="}})).json();z(ar(a.data.voices))}catch(r){console.error("API error:",r)}finally{}};d.useEffect(()=>{Rt()},[]);const Fe=d.useRef(null),nt=t=>{if(Le===t.voice_id){Fe.current.pause(),Ee(null);return}Fe.current&&Fe.current.pause();const r=new Audio(t.preview_audio);Fe.current=r,r.play(),Ee(t.voice_id),r.onended=()=>Ee(null)};d.useEffect(()=>{const t={};ve.forEach(r=>{r.scripts.forEach(a=>{const c=`${r.id}-${a.name}`;!Ve[c]&&he.length>0&&(t[c]=he[0])})}),Object.keys(t).length>0&&Ze(r=>({...r,...t}))},[ve,he]);const Vt=(t,r)=>{Ne(a=>({...a,[t]:!a[t]})),ie(r),oe(null)},lt=t=>{oe(r=>r===t?null:t),Ne({})},Ue=d.useRef(null),ot=d.useRef({});d.useEffect(()=>{function t(r){const a=document.querySelectorAll("[data-avatar-button]"),c=Array.from(a).some(p=>p.contains(r.target)),n=document.querySelectorAll("[data-voice-button]"),i=Array.from(n).some(p=>p.contains(r.target));c||i||Ue.current&&Ue.current.contains(r.target)||Object.values(ot.current).some(p=>p&&p.contains(r.target))||r.target.closest(".right, .slider, .thumbnail-slider")||(Ne({}),oe(null))}return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[]);const Lt=async(t,r=null)=>{var i,s;const a=r||fe;if(!a){console.error("No scene to update");return}const c=y.find(l=>l.id===a),n=c==null?void 0:c.variables.find(l=>l.type==="character");if(n){const l=pe.cloneDeep(b);l[n.name]={...l[n.name],properties:{...(i=l[n.name])==null?void 0:i.properties,character_id:t.avatar_id||t.id,image:t.image_url||t.preview_image_url}},F(l),z(de(l));try{await ye({template_id:S,user_id:(s=D.user)==null?void 0:s.id,deal_id:M.id,variables:l})}catch(p){console.error("Error saving avatar",p)}}},Ot=t=>{if(!(t>=Pe&&t<Pe+je)){const a=Math.max(0,t-Math.floor(je/2)),c=Math.max(0,k.length-je),n=Math.min(a,c);Re(n)}};d.useEffect(()=>{Ot(ne)},[ne,je,k.length]),d.useEffect(()=>{console.log("videoVariables updated",b)},[b]);const Bt=async t=>{try{const a=await(await fetch("https://api.heygen.com/v2/avatar_group.list?include_public=true",{method:"GET",headers:{"Content-Type":"application/json","X-API-KEY":"NmFhN2IxYTRkM2I0NDg5YThjOWExZDcwNjQ5NjdhMmMtMTc1Mzk5NzExNQ=="}})).json();z(sr(a.data.avatar_group_list))}catch(r){console.error("API error:",r)}finally{}};d.useEffect(()=>{Bt()},[]);const[hr,ct]=d.useState(!1),[fr,dt]=d.useState(null),Wt=async t=>{var r;try{ct(!0),dt(null);const a=await fetch(`https://api.heygen.com/v2/avatar_group/${t}/avatars`,{method:"GET",headers:{"X-Api-Key":"NmFhN2IxYTRkM2I0NDg5YThjOWExZDcwNjQ5NjdhMmMtMTc1Mzk5NzExNQ=="}});if(!a.ok)throw new Error(`API call failed: ${a.status}`);const n=((r=(await a.json()).data)==null?void 0:r.avatar_list)||[];Y(n)}catch(a){console.error("Error fetching avatar group:",a),dt(a.message)}finally{ct(!1)}},pt=async()=>{var t,r;try{q(!0);const a={userId:(t=D.user)==null?void 0:t.id,dealId:M.id},n=(r=(await ir(a)).data)==null?void 0:r.data;if(!n)return;ze(i=>i.map(s=>{const l=s.scripts.map(p=>({...p,value:n[p.name]||p.value}));return{...s,scripts:l}}))}catch(a){console.error("Error fetching scripts:",a)}finally{q(!1)}},[Ye,Gt]=d.useState([]);return d.useEffect(()=>{if(fe){const t=["PUBLIC_PHOTO","PUBLIC","COMMUNITY_PHOTO"],a=ue.filter(c=>{var n;return t.includes((n=c.group_type)==null?void 0:n.trim().toUpperCase())}).sort(()=>Math.random()-.5).slice(0,4);Gt(a)}},[fe,ue]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between bg-white dark:bg-[#121212] text-white px-4 py-3 shadow-md rounded-lg mb-1 container mx-auto hide-in-landscape",children:[e.jsxs("button",{onClick:()=>ae("/deal-view-ai-video-generator"),className:"flex items-center gap-2 text-lg font-semibold text-black dark:text-white  transition",children:[e.jsx(lr,{className:"text-xl"}),e.jsx("span",{children:"Back"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-around gap-3 md:gap-8 relative",children:[e.jsx(qt,{}),e.jsx("button",{className:"bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition",onClick:At,children:"Reset"}),e.jsx("button",{className:"bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition",onClick:kt,children:"Generate"}),e.jsx(pr,{show:I,onClose:()=>L(!1),modalTitle:le,modalMessage:me,showProgress:xe})]})]}),e.jsxs("div",{className:"app-root",children:[e.jsx("style",{children:`
            :root{
          --slide-radius: 18px;
          --gap: 10px;
          --card-bg: #ffffff;
          --app-bg: #0f1220;
          --shadow: 0 10px 30px rgba(0,0,0,.35);
          --text-soft:#6b7280;
          --text-strong:#111827;
        }
        .app-root{ min-height:60vh;  align-items:center; justify-content:center; padding:24px; box-sizing:border-box; background: #FDFDFD; }
       
        .dark .app-root{
        background:#121212
        }
          font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
          color:var(--text-strong);
        }
           .app-root {
          var(--app-bg);
          font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
          color:var(--text-strong);
          }
        .layout{ width:100%; max-width:1200px; display:flex; background-color:#FDFDFD }
        textarea{ width: 100%; }
        // .left{ color:#fff; width: 100%; min-width: 400px; background:white; box-shadow: var(--shadow); border-radius:15px; }
          .left{ color:#fff; width: 100%; min-width: 400px;}
        .right{ flex:1; display:flex; align-items:center; justify-content:center; }
        .slider{ position:relative; width: min(92vw, 700px); aspect-ratio: 12 / 6; background: var(--card-bg); border-radius: var(--slide-radius); overflow:hidden; margin: auto; }
        .scene-root{height:100% ; background: #F3F3F3; }
        .slide{ position:absolute; inset:0; opacity:0; pointer-events:none; transition: opacity .45s ease;  box-sizing:border-box; }
        .slide.active{ opacity:1; pointer-events:auto; }
        .grid{ display:grid; grid-template-columns: repeat(12, 1fr); grid-template-rows: repeat(6, 1fr);  width:100%; height:100%; }
        .area-wrapper{ display:grid; grid-auto-rows: 1fr; width:100%; height:100%; border-radius: 12px; overflow:hidden; position:relative; }
        .sceneblock{ display:flex; align-items:center; justify-content:center; width:100%; height:100%; box-sizing:border-box; position:relative; margin:4px; max-width: 100%; max-height: 100%; overflow: hidden; text-align: center; z-index: 9; }
        .text{ padding: 12px 14px; color: var(--text-strong); width: calc(100% - 4px); height: calc(100% - 4px); margin: 2px; display:flex; align-items:center; justify-content:center; text-align:center; font-size: 14px; line-height: 1.4; color: #222; word-wrap: break-word; word-break: break-word; white-space: normal; overflow: hidden; text-overflow: ellipsis; max-width: 100%; max-height: 100%; }
        .text:focus { outline: none; border: none;}
        .text.header{ font-weight: 800; font-size: clamp(16px, 2vw, 22px); }
        .text.subtitle{ font-weight: 600; font-size: clamp(14px, 1.6vw, 18px); color: var(--text-soft); }
        .text.title{ font-weight: 700; font-size: clamp(15px, 1.8vw, 20px); }
        .text.callout{ font-weight: 700; font-size: clamp(14px, 1.6vw, 18px); border-color:#ffe6b3; }
        .image{ width:100%; height:100%; overflow:hidden; border-radius: 12px; }
        .image > img{ width:100%; height:100%; object-fit: cover; display:block; }
        .avatar{ width: 100%; display: contents; }
        .avatar img{ height: 100%; }
        .circle-frame, .circle-frame > img{ border-radius: 50% !important; width: 100%; height: 100%; object-position: top; background-color: #fff; object-fit: cover; }
       .nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 50%;
    background: rgba(0, 0, 0, .55);
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    z-index: 20;
}
        .nav.prev{ left:14px; }
        .nav.next{ right:14px; }
        .scene-badge{ position:absolute; right:16px; top:14px; background: rgba(17,24,39,.75); color:#fff; font-size:12px; padding:6px 10px; border-radius:999px; z-index: 20; }
        .line-wrapper { display:flex; align-items:center; justify-content:stretch; pointer-events:none; z-index:20; }
        .error{ color:#fecaca; background:#7f1d1d; border:1px solid #fecaca33; padding:8px 10px; margin:8px 0; border-radius:8px; font-size:12px; }
        .controls{ display:flex; gap:8px; align-items:center; margin-top:8px; }
        .btn{ background:#111827; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; box-shadow: 0 6px 16px rgba(0,0,0,.25); }
        .btn:active{ transform: translateY(1px); }
        textarea{color:#000}
        .thumbnail .avatar img { pointer-events: none; cursor: default; }
 .thumbnail .image,
.thumbnail .image img {
  pointer-events: none;
  cursor: default;
}
  /* Add these new rules to your existing CSS */
.thumbnail .text {
  padding: 6px 7px;
  font-size: 7px;
  line-height: 1.2;
}

.thumbnail .text.header {
  font-size: clamp(8px, 1vw, 11px);
}

.thumbnail .text.subtitle {
  font-size: clamp(7px, 0.8vw, 9px);
}

.thumbnail .text.title {
  font-size: clamp(7.5px, 0.9vw, 10px);
}

.thumbnail .text.callout {
  font-size: clamp(7px, 0.8vw, 9px);
}

.thumbnail .sceneblock {
  margin: 2px;
}
  @media (max-width: 768px) {
    .layout {
      flex-direction: column;
    }
    .left {
      min-width: 100%;
      margin-bottom: 20px;
    }
    .right {
      width: 100%;
      margin-top: 20px;
    }
  } 
    @media(max-width:579px){
    .app-root {
    padding: 94px}
    }
     @media(max-width:768px){
    .app-root {
    padding: 94px}
    }

    @media (orientation: landscape) and (max-width:579px) {
  .hide-in-landscape {
    display: none;
  }


}
  @media (max-width: 820px) {
  .app-root {
   padding: 147px 24px;
  }

  @media (max-width: 768px) {
  .scene-root {
    font-size: 13px;
  }

}

 @media (max-width:579px) {
  .scene-root {
    font-size: 7px;
  }

  .scene-badge {
    font-size: 7px;
    padding: 4px 8px;
  }

  .slider .text {
  padding: 6px 7px;
  font-size: 7px;
  line-height: 1.2;
}
}


@media (max-width: 768px) {
  /* General text inside the main scene */
  .slider .text {
    font-size: 10px;
    line-height: 1.3;
    padding: 8px 10px;
  }


  .slider .text.header {
    font-size: clamp(11px, 2vw, 14px);
  }

  .slider .text.subtitle {
    font-size: clamp(10px, 1.8vw, 13px);
  }

  .slider .text.title {
    font-size: clamp(10.5px, 1.9vw, 13.5px);
  }

  .slider .text.callout {
    font-size: clamp(10px, 1.8vw, 12.5px);
  }

  .scene-badge {
    font-size: 10px;
    padding: 4px 8px;
  }
}


@media (max-width: 579px) {
  .slider .text {
    font-size: 8.5px;
    line-height: 1.3;
  }

  .slider .text.header {
    font-size: clamp(9px, 2.2vw, 12px);
  }

  .slider .text.subtitle,
  .slider .text.title,
  .slider .text.callout {
    font-size: clamp(8px, 2vw, 11px);
  }

  .scene-badge {
    font-size: 8px;
  }
}


      `}),e.jsxs("div",{className:"layout container mx-auto",children:[e.jsx("button",{onClick:()=>qe(!De),className:"lg:hidden fixed bottom-6 right-6 z-50 bg-[#6C5DD3] text-white p-3 px-5 rounded-md shadow-lg hover:bg-[#5a4bc4] transition-all duration-200","aria-label":"Toggle Script Panel",children:De?e.jsx(or,{className:"w-6 h-6"}):"Scripts"}),e.jsxs("div",{className:`
        lg:hidden fixed inset-x-0 bottom-0 w-full h-full max-h-[85vh]
        bg-white dark:bg-gray-900 rounded-t-3xl shadow-2xl z-40 overflow-y-auto
        transform transition-transform duration-300 ease-in-out
        ${De?"translate-y-0":"translate-y-full"}
      `,children:[e.jsx("div",{className:"sticky top-0 pt-4 pb-3 flex justify-center bg-inherit z-10",children:e.jsx("div",{className:"w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full"})}),e.jsxs("div",{className:"p-4 pb-24",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h4",{className:"text-black font-semibold text-lg",children:"Script"}),e.jsx("button",{onClick:pt,disabled:V,className:`bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition flex items-center gap-2 ${V?"opacity-70 cursor-not-allowed":"hover:bg-[#5a4bc4]"}`,children:V?"Generating...":"Generate Scripts"})]}),e.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"62vh"},children:ve.map((t,r)=>e.jsx("div",{className:"mb-6 border border-gray-200 dark:border-gray-700 rounded-xl p-4 shadow-sm bg-white dark:bg-gray-800",children:t.scripts.map(a=>{const c=`${t.id}-${a.name}`;return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex gap-3 items-start flex-col",children:[(()=>{var x,u,o,f;const n=y.find(h=>h.id===t.id),i=n==null?void 0:n.variables.find(h=>h.type==="character");if(!i)return null;const s=b[i.name],l=(x=s==null?void 0:s.properties)==null?void 0:x.character_id,p=((o=(u=Te[l])==null?void 0:u.data)==null?void 0:o.preview_image_url)||((f=K.find(h=>h.avatar_id===l))==null?void 0:f.preview_image_url)||J;return e.jsxs("button",{onClick:()=>lt(t.id),className:"flex items-center gap-2 px-3 py-2 border rounded-lg hover:shadow-md transition",children:[e.jsx("img",{src:p,alt:"Avatar",className:"w-8 h-8 rounded-full object-cover"}),e.jsx(He,{className:"text-sm"})]})})(),e.jsx("div",{className:"flex-1 space-y-3 w-full"})]})},c)})},t.id))})]})]}),e.jsx("div",{className:`
  hidden lg:block lg:relative h-full lg:w-auto w-full left fixed
  bg-white dark:bg-[#121212] z-40
  overflow-y-auto
`,children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h4",{className:"text-black dark:text-[#F8F8F8]",children:"Script"}),e.jsx("button",{className:`bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition flex items-center justify-center gap-2 mb-4 ${V?"opacity-70 cursor-not-allowed":""}`,onClick:pt,disabled:V,children:V?"Generating...":"Generate Scripts"})]}),e.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"70vh",padding:"10px"},children:ve.map((t,r)=>{var c;return(((c=y[r])==null?void 0:c.variables)||[]).filter(n=>n.type==="character"),e.jsx("div",{onFocus:()=>ee(r),className:"mb-6 border border-gray-200 dark:border-gray-700 rounded-xl p-4 shadow-sm bg-white dark:bg-gray-900 focus-within:ring-2 focus-within:ring-[#6C5DD3] focus-within:outline-none",children:t.scripts.map((n,i)=>{const s=`${t.id}-${n.name}`,l=Ve[s];return Je[s],e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 justify-start",children:[(()=>{const p=y.find(o=>o.id===t.id),x=p==null?void 0:p.variables.find(o=>o.type==="character");return x&&b[x.name]?e.jsxs("div",{className:"relative inline-block",children:[e.jsxs("button",{"data-avatar-button":"true",onClick:()=>lt(t.id),className:"flex items-center justify-between px-4 py-2 border border-gray-300 bg-white text-black font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 w-auto",children:[(()=>{var g,m,j;const o=y.find(v=>v.id===t.id),f=o==null?void 0:o.variables.find(v=>v.type==="character");if(!f)return e.jsx("span",{className:"text-sm",children:"No Character"});const h=b[f.name],_=(g=h==null?void 0:h.properties)==null?void 0:g.character_id,E=K.find(v=>v.avatar_id===_),A=((j=(m=Te[_])==null?void 0:m.data)==null?void 0:j.preview_image_url)||(E==null?void 0:E.preview_image_url)||J;return e.jsx("img",{src:A,alt:"Avatar",className:"w-6 h-6 rounded-full object-cover",onError:v=>{v.target.src=J}})})(),e.jsx(He,{className:"ml-2 text-black flex-shrink-0"})]}),fe===t.id&&e.jsxs("div",{ref:Ue,className:"absolute left-0 mt-2 w-80 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl z-50",children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-200 dark:border-gray-700",children:$&&$.length>0?e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>{P?ge(null):Y([])},className:"flex items-center gap-1 text-sm font-medium text-purple-600 hover:text-purple-800 transition-colors duration-200",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"Back"]})}):e.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Select Avatar"})}),e.jsx("div",{className:"flex items-center justify-center my-4",children:e.jsx("div",{className:`flex justify-center gap-3 ${$&&$.length>0&&!P?"overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent":""}`,children:$&&$.length>0&&P?e.jsxs("div",{className:"flex flex-col items-center justify-center w-full px-4",children:[e.jsx("div",{className:"relative w-24 h-24 rounded-full overflow-hidden border-2 border-purple-500 ring-2 ring-purple-200",children:e.jsx("img",{src:P.preview_image_url??P.image_url??P.image,alt:"Selected avatar",className:"w-full h-full object-cover",onError:o=>o.currentTarget.src=J})}),e.jsxs("div",{className:"mt-3 text-center",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:P.name||P.avatar_name||`Avatar ${P.avatar_id??P.id}`}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Ready to apply"})]})]}):$&&$.length>0?$.map((o,f)=>{const h=y.find(A=>A.id===t.id);if(!(h==null?void 0:h.variables.find(A=>A.type==="character")))return null;const E=(o==null?void 0:o.image_url)||(o==null?void 0:o.preview_image_url);return e.jsx("div",{className:"flex flex-col items-center flex-shrink-0",children:e.jsx("button",{onClick:()=>{ge(o)},className:"relative w-16 h-16 rounded-full overflow-hidden border-2 border-gray-200 hover:border-purple-300 hover:ring-2 hover:ring-purple-100 transition-all duration-200 flex-shrink-0",children:E?e.jsx("img",{src:E,alt:`Avatar ${f+1}`,className:"w-full h-full object-cover",onError:()=>console.error("Failed to load avatar image:",E)}):e.jsx("div",{className:"w-full h-full bg-gray-100 flex items-center justify-center text-gray-400",children:e.jsx("svg",{className:"w-8 h-8",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z",clipRule:"evenodd"})})})})},`modal_${f}`)}):Ye&&Ye.length>0?Ye.map((o,f)=>{var j;const h=y.find(v=>v.id===t.id),_=h==null?void 0:h.variables.find(v=>v.type==="character");if(!_)return null;const E=b[_.name],A=(j=E==null?void 0:E.properties)==null?void 0:j.character_id,g=o.preview_image||o.image,m=A===o.avatar_id;return e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("button",{onClick:async()=>{const v=o.id||o.avatar_id;try{await Wt(v)}catch(C){console.error("Error fetching avatars:",C)}},className:`relative w-16 h-16 rounded-full overflow-hidden border-2 transition-all duration-200 flex-shrink-0 ${m?"border-purple-500 ring-2 ring-purple-200":"border-gray-200 hover:border-purple-300 hover:ring-2 hover:ring-purple-100"}`,children:g?e.jsx("img",{src:g,alt:o.name||`Avatar ${f+1}`,className:"w-full h-full object-cover",onError:()=>console.error("Failed to load avatar image:",g)}):e.jsx("div",{className:"w-full h-full bg-gray-100 flex items-center justify-center text-gray-400",children:e.jsx("svg",{className:"w-8 h-8",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z",clipRule:"evenodd"})})})})},o.avatar_id||o.id||f)}):e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:[e.jsx("div",{className:"text-2xl mb-2",children:"ðŸ‘¤"}),e.jsx("p",{className:"text-sm",children:"No avatars available"})]})})}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 p-3",children:$&&$.length>0&&P?e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:async()=>{await Lt(P,t.id),oe(null),Y([]),ge(null)},className:"flex-1 px-4 py-2 text-sm font-medium text-[#6C5DD3] bg-white rounded-md transition-colors duration-200 border border-purple-200 hover:border-purple-300 flex items-center justify-center gap-2",children:"Apply One"}),e.jsx("button",{onClick:async()=>{var h,_;if(!P)return;const o={avatar_id:P.avatar_id??P.id,preview_image_url:P.preview_image_url??P.image_url},f=pe.cloneDeep(b);for(const E of y){const A=E.variables.find(g=>g.type==="character");A&&(f[A.name]={...f[A.name],properties:{...(h=f[A.name])==null?void 0:h.properties,character_id:o.avatar_id,image:o.preview_image_url}})}F(f),z(de(f)),await ye({template_id:S,user_id:(_=D.user)==null?void 0:_.id,deal_id:M.id,variables:f}),oe(null),Y([]),ge(null)},className:"flex-1 px-4 py-2 text-sm font-medium text-white bg-[#6C5DD3] rounded-md transition-colors duration-200 flex items-center justify-center gap-2",children:"Apply to All"})]}):$&&$.length>0?e.jsx("p",{className:"text-xs text-center text-gray-500 dark:text-gray-400 py-2",children:"Select an avatar above to continue"}):e.jsx("button",{onClick:()=>{const o=y.find(h=>h.id===t.id),f=o==null?void 0:o.variables.find(h=>h.type==="character");we(f?f.name:t.id),Se(!0),oe(null)},className:"w-full px-4 py-2 text-sm font-medium text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-md transition-colors duration-200 border border-purple-200 hover:border-purple-300",children:"View All Avatars"})})]})]}):null})(),(()=>{var f,h;const p=s.match(/scene_(\d+)_script/);if(!p)return null;const u=`voice_id_${p[1]}`;return((h=(f=b[u])==null?void 0:f.properties)==null?void 0:h.voice_id)?e.jsxs("div",{className:"relative inline-block w-1/2",children:[e.jsxs("button",{"data-voice-button":"true",onClick:()=>Vt(s,s),className:"flex items-center justify-between px-4 py-2 border dark:border-gray-600 rounded-lg dark:bg-gray-800 shadow-md hover:bg-gray-200 dark:hover:bg-gray-700 transition text-left text-black w-full",children:[e.jsx("span",{className:"truncate max-w-[70%]",children:(()=>{var j,v;const _=s.match(/scene_(\d+)_script/);if(!_)return(l==null?void 0:l.name)||"Select AI Voice";const A=`voice_id_${_[1]}`,g=(v=(j=b[A])==null?void 0:j.properties)==null?void 0:v.voice_id,m=he.find(C=>C.voice_id===g)||l;return(m==null?void 0:m.name)||"Select AI Voice"})()}),e.jsx(He,{className:"ml-2 text-gray-500 shrink-0"})]}),Je[s]&&l&&e.jsxs("div",{ref:_=>ot.current[s]=_,className:"absolute mt-2 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg z-50 p-2 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center justify-around my-1",children:[e.jsx("button",{onClick:()=>nt(l),className:"px-3 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg transition flex items-center justify-center",children:Le===(l==null?void 0:l.voice_id)?e.jsx(mt,{className:"text-lg text-purple-600"}):e.jsx(xt,{className:"text-lg text-purple-600"})}),e.jsx("span",{className:"text-sm text-center text-black font-medium",children:(()=>{var j,v;const _=s.match(/scene_(\d+)_script/);if(!_)return l==null?void 0:l.name;const A=`voice_id_${_[1]}`,g=(v=(j=b[A])==null?void 0:j.properties)==null?void 0:v.voice_id,m=he.find(C=>C.voice_id===g)||l;return(m==null?void 0:m.name)||"Select AI Voice"})()})]}),e.jsx("button",{onClick:()=>{wt(s),Ne(_=>({..._,[s]:!1}))},className:"w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition",children:"View All"})]})]}):null})(),e.jsx(dr,{isModalOpen:vt,setIsModalOpen:Ie,voices:he,selectedVoice:Ve,voiceKey:N,playingAudioId:Le,handlePlayAudio:nt,loading:V,videoVariables:b,handleVoiceSelect:async(p,x)=>{const u=pe.cloneDeep(b);if(x==="current"){const o=N.match(/scene_(\d+)_script/);if(!o)return;const h=`voice_id_${o[1]}`;u[h]={name:h,properties:{voice_id:p.voice_id},type:"voice"},F(u),Ie(!1),await Oe(h,p.voice_id,u)}if(x==="all"){Object.keys(u).forEach(o=>{o.startsWith("voice_id_")&&(u[o].properties.voice_id=p.voice_id)}),F(u),Ie(!1);for(const o of Object.keys(u))o.startsWith("voice_id_")&&await Oe(o,p.voice_id,u)}}})]}),(()=>{var p;return(p=n.value)!=null&&p.trim().split(/\s+/).filter(Boolean).length,e.jsxs(e.Fragment,{children:[e.jsx("textarea",{rows:4,value:n.value,onFocus:()=>ee(r),onChange:x=>St(t.id,n.name,x.target.value),placeholder:"Write your script here...",className:`w-full p-3 rounded-lg shadow-sm resize-none focus:outline-none transition
          dark:border-gray-600 dark:bg-gray-800 text-black dark:text-white
          ${Me[n.name]?"border border-red-500":""}`}),Me[n.name]&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:Me[n.name]}),e.jsxs("p",{className:`text-xs mt-1 ${Be(n.value)>ke?"text-red-500":"text-gray-400"}`,children:[Be(n.value)," / ",ke," words"]})]})})()]},s)})},t.id)})})]})}),De&&e.jsx("div",{className:"lg:hidden fixed inset-0 bg-black bg-opacity-50 z-30",onClick:()=>qe(!1)}),e.jsx("div",{className:"right",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsx("div",{className:"flex-1 flex items-center justify-center lg:block",children:e.jsx("div",{className:"w-full px-4 lg:px-0",children:e.jsxs("div",{className:"slider",children:[e.jsx("button",{className:"nav prev",onClick:()=>k.length&&ee(t=>(t-1+k.length)%k.length),"aria-label":"Previous",children:"â®"}),e.jsx("button",{className:"nav next",onClick:()=>k.length&&ee(t=>(t+1)%k.length),"aria-label":"Next",children:"â¯"}),k.map((t,r)=>e.jsx("div",{className:`slide ${r===ne?"active":""}`,children:e.jsx(it,{scene:t,index:r})},t.id||r))]})})}),e.jsx("div",{className:"fixed bottom-20 left-0 right-0 lg:relative lg:bottom-auto lg:left-auto lg:right-auto lg:mt-3 hide-in-landscape",children:e.jsxs("div",{className:"thumbnail-slider flex items-center justify-center relative px-4 lg:px-0 bg-white dark:bg-[#121212] lg:py-0 lg:bg-transparent",children:[e.jsx("button",{className:"thumb-nav prev",onClick:()=>Re(t=>Math.max(t-1,0)),children:"â®"}),e.jsx("div",{className:"thumbnails-wrapper overflow-hidden w-full sm:w-[750px]",children:e.jsx("div",{className:"thumbnails-track flex transition-transform duration-300",style:{transform:`translateX(-${Pe*gt}px)`},children:k.map((t,r)=>e.jsx("div",{className:`thumbnail ${r===ne?"active":""} 
                w-[100px] h-[60px] sm:w-[140px] sm:h-[80px] mr-2`,onClick:a=>{var c;a.stopPropagation(),ee(r),(c=document.getElementById(`textarea-${t.id}`))==null||c.scrollIntoView({behavior:"smooth",block:"center"})},children:e.jsx(it,{scene:t,index:r,isThumbnail:!0})},t.id||r))})}),e.jsx("button",{className:"thumb-nav next",onClick:()=>Re(t=>Math.min(t+1,k.length-je)),children:"â¯"})]})})]})})]}),Xe&&e.jsx(cr,{show:Xe,onClose:()=>{Se(!1),we(null)},avatars:Nt,VideoScenes:y,activeBlock:ft,videoVariables:b,onSelect:async(t,r)=>{var n;const a=pe.cloneDeep(b),c=i=>{var u,o;const s=i==null?void 0:i.trim();let l=y.find(f=>f.id===s);if(l||(l=y.find(f=>f.variables.some(h=>h.name===s||h.name.startsWith(s)))),!l){if(console.warn(`[Parent] Scene ${s} not found in VideoScenes`),console.warn("[Parent] Trying to find character variable directly in videoVariables..."),b[s]){a[s]={...a[s],properties:{...(u=a[s])==null?void 0:u.properties,character_id:t.avatar_id,image:t.preview_image_url}};return}console.error("[Parent] Could not find scene or variable for:",s);return}const p=l.variables.find(f=>f.type==="character");if(!p){console.warn(`[Parent] No character variable in scene ${l.id}`);return}const x=p.name;a[x]={...a[x],properties:{...(o=a[x])==null?void 0:o.properties,character_id:t.avatar_id,image:t.preview_image_url}}};r==="ALL"?y.forEach(i=>{i.variables.find(l=>l.type==="character")&&c(i.id)}):r&&c(r),F(a),z(de(a));try{await ye({template_id:S,user_id:(n=D.user)==null?void 0:n.id,deal_id:M.id,variables:a})}catch(i){console.error("[Parent] Error saving avatar to API",i)}Se(!1),we(null)}})]})]})}export{jr as default};
