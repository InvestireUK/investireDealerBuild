import{r as l,h as fr,m as e,b3 as Dt,b4 as hr,t as gr,s as br,a1 as vr,q as wr,u as be,b5 as yr,b6 as pt,b7 as we,b8 as Se,b9 as jr,ba as _r,bb as kr,bc as Nr,bd as Cr,be as Ar,bf as Sr,bg as Er,bh as Vr}from"./index-2LN8UDRv.js";import{l as ye}from"./lodash-GrI9hJIf.js";import{C as It}from"./index-BRaOa30v.js";import{b as $r}from"./index-0-uAL9_4.js";import{u as Dr}from"./useRefreshUser-54vPAET6.js";import{X as Ir}from"./x-CsOnEqEx.js";const me="/assets/aiii-qzy6FebL.webp";function zr({show:ne,onClose:I,avatars:ee,onSelect:q,VideoScenes:z,activeBlock:xe,videoVariables:C}){const[ie,te]=l.useState(null),[oe,O]=l.useState([]),[P,F]=l.useState(!1),[Z,V]=l.useState(!1),[Y,Re]=l.useState(!1),[R,v]=l.useState(null),[W,_]=l.useState("all");if(!ne)return null;const A=async j=>{var L;Re(!0);try{const ce=`https://api.heygen.com/v2/avatar_group/${j.id}/avatars`,de=await fetch(ce,{method:"GET",headers:{"X-Api-Key":"sk_V2_hgu_kFHRWykcXEd_oisfR7mnYitgiX8vwtraF2NoDtg3J73V","Content-Type":"application/json"}});if(!de.ok)throw new Error(`HTTP ${de.status}`);const Qe=await de.json();O(((L=Qe.data)==null?void 0:L.avatar_list)||[]),te(j),F(!0),V(!1)}catch(ce){console.error("[AvatarModal] fetch error:",ce)}finally{Re(!1)}},U=()=>{F(!1),te(null),O([]),v(null),V(!1)},T=()=>{V(!1),v(null)},G=j=>{v(j),V(!0)},le=ee.filter(j=>{var L,ce;return W==="all"?!0:W==="male"?((L=j.gender)==null?void 0:L.toLowerCase())==="male":W==="female"?((ce=j.gender)==null?void 0:ce.toLowerCase())==="female":!0}),je=()=>{if(!R){console.warn("[AvatarModal] No avatar selected");return}if(!q){console.error("[AvatarModal] onSelect prop missing");return}if(!xe){console.error("[AvatarModal] activeBlock (scene ID) missing");return}const j={avatar_id:R.avatar_id||R.id,preview_image_url:R.image_url||R.preview_image_url,...R};q(j,xe),V(!1),v(null),F(!1),te(null),O([])},Te=()=>{if(!R||!q||!Array.isArray(z)){console.warn("[AvatarModal] Invalid state for Apply to All");return}const j={avatar_id:R.avatar_id||R.id,preview_image_url:R.image_url||R.preview_image_url,...R};q(j,"ALL"),V(!1),v(null),F(!1),te(null),O([])};return fr.createPortal(e.jsxs(e.Fragment,{children:[!P&&!Z&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[9999] bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-5xl relative flex flex-col max-h-[80vh] m-5 md:m-0",children:[e.jsx("button",{onClick:I,className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black z-10",children:"X"}),e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-lg font-semibold",children:"Choose an Avatar Group"})}),e.jsx("div",{className:"p-4 overflow-y-auto",children:Y?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"})}):e.jsx("div",{className:"select-ai-voice-grid-wrap",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:le.length>0?le.map(j=>e.jsxs("div",{className:"cursor-pointer flex flex-col p-2 border rounded-md hover:border-blue-500 transition-colors",onClick:()=>A(j),children:[e.jsx("img",{src:j.preview_image||me,alt:j.name,className:"w-full h-32 object-contain rounded-md border",onError:L=>L.currentTarget.src=me}),e.jsxs("div",{className:"flex justify-between items-center mt-2 px-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:j.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[j.num_looks," looks"]})]})]},j.id)):e.jsx("p",{className:"col-span-full text-gray-500 text-center",children:"No avatar groups available"})})})}),e.jsx("div",{className:"flex justify-start p-4 border-t",children:e.jsx("button",{onClick:I,className:"px-4 py-2 bg-gray-300 rounded hover:bg-gray-400",children:"Back"})})]})}),P&&!Z&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[9999] bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-5xl relative flex flex-col max-h-[80vh] m-5 md:m-0",children:[e.jsx("button",{onClick:I,className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black z-10",children:"X"}),e.jsx("div",{className:"p-4 border-b",children:e.jsxs("h2",{className:"text-lg font-semibold",children:[(ie==null?void 0:ie.name)||"Avatar"," - Select a Look"]})}),e.jsx("div",{className:"p-4 overflow-y-auto",children:Y?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"})}):e.jsx("div",{className:"select-ai-voice-grid-wrap",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:oe.length>0?oe.map((j,L)=>e.jsxs("div",{className:"cursor-pointer flex flex-col items-center p-2 border rounded-md hover:border-purple-500 transition-colors",onClick:()=>G(j),children:[e.jsx("img",{src:j.image_url||j.preview_image_url||me,alt:j.avatar_name||`Avatar ${L+1}`,className:"w-full h-32 object-contain rounded-md border",onError:ce=>ce.currentTarget.src=me}),j.avatar_name&&e.jsx("p",{className:"mt-2 text-xs font-medium truncate max-w-full",children:j.avatar_name})]},j.avatar_id||j.id||L)):e.jsx("p",{className:"col-span-full text-gray-500 text-center",children:"No looks available"})})})}),e.jsx("div",{className:"flex justify-start p-4 border-t",children:e.jsx("button",{onClick:U,className:"px-4 py-2 bg-gray-300 rounded hover:bg-gray-400",children:"Back"})})]})}),Z&&R&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[9999] bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-xl relative flex flex-col m-5 md:m-0",children:[e.jsx("button",{onClick:I,className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black z-10",children:"X"}),e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-lg font-semibold",children:"Confirm Avatar"})}),e.jsxs("div",{className:"p-6 flex flex-col items-center",children:[e.jsx("div",{className:"relative w-40 h-40 rounded-full overflow-hidden border-4 border-purple-500 ring-4 ring-purple-200 mb-4",children:e.jsx("img",{src:R.image_url||R.preview_image_url||me,alt:"Selected",className:"w-full h-full object-cover",onError:j=>j.currentTarget.src=me})}),e.jsx("p",{className:"text-lg font-medium text-gray-900",children:R.avatar_name||R.name||"Avatar"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Ready to apply"})]}),e.jsxs("div",{className:"p-4 border-t flex gap-3",children:[e.jsx("button",{onClick:T,className:"flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300",children:"Back"}),e.jsxs("button",{onClick:je,className:"flex-1 px-4 py-2 bg-[#6C5DD3] text-white rounded-md hover:bg-purple-700 flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),"Apply One"]}),e.jsxs("button",{onClick:Te,className:"flex-1 px-4 py-2 bg-[#6C5DD3] text-white rounded-md flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),"Apply to All"]})]})]})}),e.jsx("style",{jsx:!0,children:`
        .loader {
          border-top-color: #3498db;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }
      `})]}),document.body)}function Fr({isModalOpen:ne,setIsModalOpen:I,voices:ee=[],heygenVoiceIds:q=new Set,voiceKey:z,videoVariables:xe,playingAudioId:C,handlePlayAudio:ie,handleVoiceSelect:te,loading:oe=!1}){const[O,P]=l.useState("all"),[F,Z]=l.useState(null),[V,Y]=l.useState(!1);console.log("VoiceModal voices prop:",ee);const R=(()=>{var G,le,je;const _=z==null?void 0:z.match(/scene_(\d+)_script/);if(!_)return null;const U=`voice_id_${_[1]}`,T=xe==null?void 0:xe[U];return((G=T==null?void 0:T.properties)==null?void 0:G.voice_id)||((le=T==null?void 0:T.voice)==null?void 0:le.Voice_id)||((je=T==null?void 0:T.voice)==null?void 0:je.voice_id)||null})(),v=l.useMemo(()=>{if(!Array.isArray(ee)||ee.length===0)return[];const _=ee.filter(A=>(A==null?void 0:A.voice_id)&&q.has(A.voice_id));return O==="male"?_.filter(A=>A.gender==="male"):O==="female"?_.filter(A=>A.gender==="female"):_},[ee,O,q]);console.log("filteredVoices",v);const W=_=>q.has(_);return ne?e.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0",onClick:()=>I(!1)}),e.jsxs("div",{className:"relative bg-white dark:bg-gray-900 w-full max-w-4xl max-h-[85vh] overflow-hidden rounded-lg shadow-xl flex flex-col mx-4",children:[e.jsx("button",{onClick:()=>I(!1),className:"absolute top-4 right-4 text-2xl z-10 text-gray-600 hover:text-black dark:text-gray-300",children:"X"}),e.jsx("h2",{className:"text-xl font-semibold p-6 pb-3 text-black dark:text-white",children:"ðŸŽ™ï¸ Select AI Voice"}),e.jsx("div",{className:"flex justify-center gap-4 px-6 border-b pb-4",children:["all","male","female"].map(_=>e.jsx("button",{onClick:A=>{A.stopPropagation(),P(_),Z(null)},className:`px-6 py-2 rounded-lg font-medium transition ${O===_?"bg-purple-600 text-white":"bg-gray-200 dark:bg-gray-700"}`,children:_.charAt(0).toUpperCase()+_.slice(1)},_))}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:oe?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx("div",{className:"w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin"})}):v.length===0?e.jsx("p",{className:"text-center text-gray-500 py-10",children:oe?"Loading voices...":O==="all"?"No supported voices available":`No supported ${O} voices available`}):e.jsx("div",{className:"select-ai-voice-grid-wrap",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4",children:v.map(_=>{const A=W(_.voice_id),U=R===_.voice_id;return e.jsx("div",{onClick:()=>A&&Z(_),className:`
                      flex flex-col items-center justify-between p-2 rounded-lg border transition shadow-sm text-sm
                      ${U?"bg-[#EDF4FF] text-black/[1] border-[#6C5DD3]":"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:shadow-md"}
                    
                    `,children:e.jsxs("div",{className:"flex items-center gap-2 w-full min-w-0",children:[e.jsx("button",{onClick:T=>{T.stopPropagation(),A&&ie(_)},disabled:!A,className:`
                          p-1 rounded-full transition text-sm
                          ${U?"bg-white text-[#6C5DD3]":"bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-purple-600"}
                          ${A?"":"opacity-50 cursor-not-allowed"}
                        `,children:C===_.voice_id?e.jsx(Dt,{className:"text-base"}):e.jsx(It,{className:"text-base"})}),e.jsx("span",{className:`font-medium truncate ${U?"text-black":"text-gray-800 dark:text-gray-200"}`,children:_.name}),e.jsx("div",{className:"ml-1 flex gap-[2px] items-end flex-shrink-0",children:[...Array(5)].map((T,G)=>e.jsx("span",{className:`w-[2px] h-2 bg-[#6C5DD3] rounded ${C===_.voice_id&&A?"animate-pulse":"opacity-50"}`,style:{animationDelay:`${G*.1}s`}},G))})]})},_.voice_id)})})})}),F&&e.jsx("div",{className:"fixed inset-0 z-[10000] flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg w-full max-w-xl relative flex flex-col m-5 md:m-0 shadow-2xl",children:[e.jsx("button",{onClick:()=>Z(null),className:"absolute top-3 right-3 text-2xl text-gray-600 hover:text-black dark:text-gray-300 dark:hover:text-white z-10",children:"X"}),e.jsx("div",{className:"p-6 pb-4 border-b border-gray-200 dark:border-gray-700 text-center",children:e.jsx("h2",{className:"text-2xl font-bold text-black dark:text-white",children:"Confirm Voice"})}),e.jsxs("div",{className:"p-8 flex flex-col items-center text-center",children:[e.jsx("div",{className:"w-28 h-28 bg-[#6C5DD3] rounded-full flex items-center justify-center text-white text-5xl font-bold mx-auto mb-6 shadow-lg",children:"ðŸŽ™ï¸"}),e.jsx("p",{className:"text-2xl font-semibold text-gray-900 dark:text-white mb-2",children:F.name}),e.jsx("p",{className:"text-base text-gray-500 dark:text-gray-400",children:"Ready to apply voice"})]}),e.jsxs("div",{className:"p-6 border-t border-gray-200 dark:border-gray-700 flex gap-4",children:[e.jsx("button",{onClick:()=>Z(null),className:"flex-1 px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition font-medium",children:"Cancel"}),e.jsx("button",{disabled:V,onClick:async()=>{Y(!0),await new Promise(_=>setTimeout(_,100));try{await te(F,"current")}finally{Y(!1),Z(null),I(!1)}},className:"flex-1 px-6 py-3 bg-[#6C5DD3] text-white rounded-lg hover:bg-purple-700 disabled:opacity-60 disabled:cursor-not-allowed transition font-medium flex items-center justify-center gap-3",children:V?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Applying..."]}):"Apply One"}),e.jsx("button",{disabled:V,onClick:async()=>{Y(!0),await new Promise(_=>setTimeout(_,100));try{await te(F,"all")}finally{Y(!1),Z(null),I(!1)}},className:"flex-1 px-6 py-3 bg-[#6C5DD3] text-white rounded-lg hover:bg-purple-700 disabled:opacity-60 disabled:cursor-not-allowed transition font-medium flex items-center justify-center gap-3",children:V?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Applying..."]}):"Apply to All"})]})]})})]})]}):null}function Rr({show:ne,onClose:I,modalTitle:ee,modalMessage:q,showProgress:z}){return ne?e.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50",onClick:I}),e.jsxs("div",{className:"absolute top-20 right-8 bg-white dark:bg-gray-900 w-full max-w-md rounded-2xl shadow-lg p-6 text-center z-50",children:[e.jsx("button",{onClick:I,className:"absolute top-3 right-3 text-2xl text-gray-600 hover:text-black dark:text-gray-300 dark:hover:text-white",children:"âœ•"}),e.jsxs("div",{className:"flex items-start gap-4",children:[z&&e.jsx(hr,{className:"text-black animate-spin text-3xl"}),e.jsxs("div",{className:"text-start",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 dark:text-white",children:ee}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mt-1",children:q})]})]}),z&&e.jsx("div",{className:"mt-6 w-full bg-gray-200 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"h-2 bg-[#6C5DD3] rounded-full animate-progress"})})]})]}):null}function Tr({loading:ne}){return ne?e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm",children:e.jsxs("div",{className:"flex flex-col items-center gap-4 p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl",children:[e.jsxs("div",{className:"relative w-16 h-16",children:[e.jsx("div",{className:"absolute inset-0 border-4 border-purple-200 dark:border-purple-900 rounded-full"}),e.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-purple-600 rounded-full animate-spin"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-1",children:"Resetting..."}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Please wait while we restore the original template"})]})]})}):null}function ea(){const ne=gr(),I=br(),ee=vr(),q=Dr(),{templateId:z}=ee.state,{showSnackbar:xe}=wr(),C=be(t=>t.deal.VideoScenes||[]),ie=be(t=>t.deal.AiAvatars||[]),te=be(t=>t.deal.AiAvatarGroups||[]),oe=be(t=>t.deal.VideoVariables),O=be(t=>t.deal.VideoValidations),P=be(t=>t.deal.deal),{user:F}=be(t=>t),Z=Object.entries(oe).filter(([t,r])=>r.type==="character").map(([t,r])=>({id:t,...r})),[V,Y]=l.useState([]),[Re,R]=l.useState(null),[v,W]=l.useState(oe),[_,A]=l.useState(!1),[U,T]=l.useState(null),[G,le]=l.useState(!1),[je,Te]=l.useState(!1),[j,L]=l.useState(""),[ce,de]=l.useState(""),[Qe,Pe]=l.useState(!1),[k,zt]=l.useState([]),[_e,re]=l.useState(0),[Pr,Lr]=l.useState(""),[Ft,Le]=l.useState({}),[mt,Me]=l.useState(!1),[Rt,Ee]=l.useState(null),[Mr,Br]=l.useState({}),[Or,Wr]=l.useState({}),[xt,Ur]=l.useState({}),[et,tt]=l.useState(0),Tt=150,Ve=5,$e=be(t=>t.deal.AiVoices||[]),[ft,Be]=l.useState({}),[rt,Oe]=l.useState(null),[Pt,at]=l.useState(!1),[ht,De]=l.useState({}),[ke,ve]=l.useState(null),[M,Ne]=l.useState(null),[We,Ue]=l.useState([]),[Ge,gt]=l.useState(!1),[Lt,bt]=l.useState(),[Gr,Mt]=l.useState({}),Bt=t=>{le(!0),at(!0),T(t),setTimeout(()=>{le(!1)},1e3)},Ot=l.useCallback(async(t,r="current")=>{if(t!=null&&t.voice_id){if(W(a=>{const i=ye.cloneDeep(a);if(r==="current"&&U){const n=U.match(/scene_(\d+)_script/);if(n){const s=`voice_id_${n[1]}`;i[s]||(i[s]={name:s,type:"voice",properties:{}}),i[s].properties.voice_id=t.voice_id}}return r==="all"&&Object.keys(i).forEach(n=>{n.startsWith("voice_id_")&&(i[n]||(i[n]={name:n,type:"voice",properties:{}}),i[n].properties.voice_id=t.voice_id)}),i}),r==="current"&&U&&Be(a=>({...a,[U]:t})),r==="all"){const a={};k.forEach(i=>{i.scripts.forEach(n=>{const o=`${i.id}-${n.name}`;a[o]=t})}),Be(a)}at(!1),T(null)}},[U,k]),Wt=["PUBLIC_PHOTO","PUBLIC","COMMUNITY_PHOTO"],Ut=te.filter(t=>{var r;return Wt.includes((r=t.group_type)==null?void 0:r.trim().toUpperCase())}),Gt=async(t,r)=>{try{let a=[];return{cleanedVariables:Object.fromEntries(Object.entries(r).filter(([n,o])=>{var $,S,f,p;const s=($=o==null?void 0:o.properties)==null?void 0:$.content,c=((S=o==null?void 0:o.properties)==null?void 0:S.url)||Lt,m=(f=o==null?void 0:o.properties)==null?void 0:f.character_id,g=(p=o==null?void 0:o.properties)==null?void 0:p.voice_id,b=m!=null&&String(m).trim()!==""&&String(m)!=="undefined",d=typeof s=="string"&&s.trim()!=="",u=c&&String(c).trim()!=="",x=g&&String(g).trim()!=="",w=d||u||b||x;return w||a.push(n),w})),emptyKeys:a}}catch(a){return console.error("API error:",a),{cleanedVariables:{},emptyKeys:[]}}},Xt=async(t,r,a)=>{var i;try{await Se({template_id:z,user_id:(i=F.user)==null?void 0:i.id,deal_id:P.id,variables:{...a,[t]:{...a[t],properties:{...a[t].properties,content:r}}}})}catch(n){console.error("Error saving to API",n)}};l.useEffect(()=>{ke||Ne(null)},[ke]);const st=(t="")=>t.trim()===""?0:t.trim().split(/\s+/).length,Kt=async()=>{var t,r;try{if(Object.values(Xe).some(b=>b)){de("Word limit exceeded"),L("Please reduce words before generating the video."),A(!0);return}const{cleanedVariables:i,emptyKeys:n}=await Gt(z,v);if(n.length>0){de("Missing Fields"),L("Some fields are still missing:"),Pe(!1),A(!0);return}if(!i||Object.keys(i).length===0){de("No Variables"),L("All fields are empty. Please fill them before generating."),Pe(!1),A(!0);return}de("Generatingâ€¦"),L(""),Pe(!0),A(!0);const o=await fetch(`https://api.heygen.com/v2/template/${z}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":"sk_V2_hgu_kFHRWykcXEd_oisfR7mnYitgiX8vwtraF2NoDtg3J73V"},body:JSON.stringify({test:!0,variables:i,dimension:{width:1280,height:720}})});if(!o.ok)throw new Error("Failed to generate video");const s=await o.json(),c=await jr({user_id:(t=F.user)==null?void 0:t.id}),m=await _r({deal:P.id,ai_video_id:(r=s==null?void 0:s.data)==null?void 0:r.video_id}),g=await q();if(m!=null&&m.status)sessionStorage.setItem(`video_generated_${P.id}`,"true"),ne(`/deals/deal-view/${P.id}`);else throw new Error("Failed to save generated video")}catch(a){console.error("Error during video generation:",a),Pe(!1),de("Error"),L("There is some error please contact admin or try again in some time"),A(!0)}};l.useEffect(()=>{C&&C.length>0&&zt(C)},[C]);const Ht=async()=>{var t,r,a,i,n;if(z){Te(!0);try{const o={template_id:z,user_id:(t=F.user)==null?void 0:t.id,deal_id:P.id};await kr(o,z);const s=await Nr({template_id:z,user_id:(r=F.user)==null?void 0:r.id,deal_id:P.id});let c=((a=s==null?void 0:s.data)==null?void 0:a.variables)??((n=(i=s==null?void 0:s.data)==null?void 0:i.data)==null?void 0:n.variables)??(s==null?void 0:s.variables)??{};I(we(c)),W(c);const m={};Object.entries(c).forEach(([b,d])=>{var u;((u=d==null?void 0:d.properties)==null?void 0:u.content)!==void 0&&(m[b]=d.properties.content)}),Le(m);const g=C.map(b=>({id:b.id,scripts:b.variables.filter(d=>d.type==="text"&&d.name.endsWith("_script")).map(d=>{var x,w;const u=((w=(x=c[d.name])==null?void 0:x.properties)==null?void 0:w.content)||"";return{name:d.name,value:u}})}));Ue(g),Mt({}),bt(null),Be({}),nt({}),T(null),Oe(null),De({}),ve(null),Y([]),Ne(null),Object.keys(fe.current).forEach(b=>{fe.current[b]&&clearTimeout(fe.current[b])}),fe.current={},Yt.current={},setTimeout(()=>{Object.keys(c).forEach(b=>{var u,x;const d=document.getElementById(b);if(d&&d.contentEditable==="true"){const w=((x=(u=c[b])==null?void 0:u.properties)==null?void 0:x.content)||wt(b);d.textContent!==w&&(d.textContent=w)}})},100)}catch(o){console.error("âŒ Reset failed:",o),de("Reset Failed"),L("Unable to reset. Please try again."),A(!0)}finally{Te(!1)}}};l.useEffect(()=>{const t={};Object.entries(v).forEach(([r,a])=>{var i;((i=a==null?void 0:a.properties)==null?void 0:i.content)!==void 0&&(t[r]=a.properties.content)}),Le(t)},[v]),l.useEffect(()=>{console.log("videoVariables state updated (local):",v),console.log("Redux VideoVariables (from selector):",oe)},[v,oe]),l.useEffect(()=>{if(C&&C.length>0){const t=C.map(r=>{const a=r.variables.filter(i=>i.type==="text"&&i.name.endsWith("_script")).map(i=>{var n,o;return{name:i.name,value:((o=(n=v[i.name])==null?void 0:n.properties)==null?void 0:o.content)||""}});return{id:r.id,scripts:a}});Ue(t)}},[C]);const Yt=l.useRef({}),fe=l.useRef({}),[Xe,nt]=l.useState({}),Ce=40,it=l.useRef(new Map),vt=(t,r,a)=>{const n=st(a)>Ce;if(Ue(o=>o.map(s=>s.id===t?{...s,scripts:s.scripts.map(c=>c.name===r?{...c,value:a}:c)}:s)),nt(o=>({...o,[r]:n?`Maximum ${Ce} words allowed`:""})),n){nt(o=>({...o,[r]:`Maximum ${Ce} words allowed`})),xe(`Maximum ${Ce} words allowed for this script`,"error"),fe.current[r]&&clearTimeout(fe.current[r]);return}it.current.set(r,a),fe.current[r]&&clearTimeout(fe.current[r]),fe.current[r]=setTimeout(()=>{var c;const o=it.current.get(r)||a,s=ye.cloneDeep(v);s[r]||(s[r]={name:r,type:"text",properties:{}}),s[r].properties.content=o,W(s),I(we(s)),Se({template_id:z,user_id:(c=F.user)==null?void 0:c.id,deal_id:P.id,variables:s}).catch(console.error)},800)};l.useEffect(()=>()=>{it.current.clear()},[]),l.useEffect(()=>{if(v&&Object.keys(v).length>0){const t={};Object.entries(v).forEach(([r,a])=>{var i;(i=a==null?void 0:a.properties)!=null&&i.content&&(t[r]=a.properties.content)}),Object.keys(t).length>0&&Le(r=>({...t,...r}))}},[v]);function Jt(t){const r=t.name,{name:a,type:i}=t||{};if(!a||!i||!a.includes("__")||a.endsWith("_script"))return null;const n=a.split("__").filter(Boolean),o=n[0],s=n.slice(1);let c=null,m=null,g=null,b={},d=[];const u=[];let x=null,w=!1,$=!1,S=!1;for(const f of s)if(f==="FI")c="1 / -1",m="1 / -1",g="FI";else if(f.startsWith("P_")){const p=f.split("_");if(p.length===5){const y=+p[1],h=+p[2],D=+p[3],B=+p[4];[y,h,D,B].every(Number.isFinite)&&(c=`${y} / ${D+1}`,m=`${h} / ${B+1}`,g=`${y}-${h}-${D}-${B}`)}}else if(f.startsWith("BG_")){const p=f.replace("BG_","").trim();/^[0-9a-fA-F]{6}$/.test(p)&&(b.background=`#${p}`)}else if(f.startsWith("JL"))b.justifyContent="left";else if(f.startsWith("JR"))b.justifyContent="right";else if(f.startsWith("JC"))b.justifyContent="center";else if(f.startsWith("FR_C"))d.push("circle-frame");else if(f.startsWith("PD_")){const p=f.split("_");if(p.length===5){const y=+p[1],h=+p[2],D=+p[3],B=+p[4];[y,h,D,B].every(Number.isFinite)&&(b.padding=`${y}px ${B}px ${D}px ${h}px`)}}else if(f.startsWith("Z_")){const p=+f.split("_")[1];Number.isFinite(p)&&(b.zIndex=p)}else if(f.startsWith("AL_")||f.startsWith("BL_")){const p=f.split("_");if(p.length===5){const y=+p[1],h=+p[2],D=+p[3],B=+p[4];[y,h,D,B].every(Number.isFinite)&&u.push({kind:f.startsWith("AL_")?"AL":"BL",sc:y,sr:h,ec:D,er:B,gridCol:`${y} / ${D+1}`,gridRow:`${h} / ${B+1}`,raw:f})}}else if(f.startsWith("F_")){const p=f.split("_");if(p.length>=2){const y=+p[1];Number.isFinite(y)&&(x=y);const h=p[2]||"";w=h.includes("B"),$=h.includes("I"),S=h.includes("U")}}return!c&&u.length===0?null:{id:o,type:i,gridCol:c,gridRow:m,key:g,elStyle:b,classes:d,lines:u,sceneId:r,fontSize:x,bold:w,italic:$,underline:S}}function qt(t){const r=(t||"").toLowerCase();return r.startsWith("header")?"header":r.startsWith("subtitle")?"subtitle":r.startsWith("title")?"title":r.startsWith("callout")?"callout":""}function wt(t){if(!t)return"Enter text...";let r=t;return r.includes("__")&&(r=r.split("__")[0]),r=r.replace(/_P_\d+_\d+_\d+_\d+.*$/,""),r=r.replace(/_FI.*$/,""),r=r.replace(/_BG_[a-fA-F0-9]+.*$/,""),r=r.replace(/_FR_C.*$/,""),r=r.replace(/_PD_\d+_\d+_\d+_\d+.*$/,""),r=r.replace(/_Z_\d+.*$/,""),r=r.replace(/_AL_\d+_\d+_\d+_\d+.*$/,""),r=r.replace(/_BL_\d+_\d+_\d+_\d+.*$/,""),r||t}const Ke=new Map,Ie=new Map,Zt=async(t,r)=>{if(Ke.has(t))return Ke.get(t);if(Ie.has(t))return Ie.get(t);r(a=>({...a,[t]:!0}));try{const a=fetch(`https://api.heygen.com/v2/avatar/${t}/details`,{method:"GET",headers:{"X-API-KEY":"sk_V2_hgu_kFHRWykcXEd_oisfR7mnYitgiX8vwtraF2NoDtg3J73V","Content-Type":"application/json"}}).then(n=>{if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return n.json()});Ie.set(t,a);const i=await a;return Ke.set(t,i),Ie.delete(t),i}catch(a){return console.error("Error fetching avatar details:",a),Ie.delete(t),null}finally{r(a=>({...a,[t]:!1}))}},[He,Qt]=l.useState({}),[er,tr]=l.useState({}),ot=l.useRef(new Set),lt=l.useRef(!0);l.useEffect(()=>()=>{lt.current=!1},[]);const yt=l.useMemo(()=>{const t=new Set;return C.forEach(r=>{var i,n;const a=r.variables.find(o=>o.type==="character");if(a){const o=(n=(i=v[a.name])==null?void 0:i.properties)==null?void 0:n.character_id;o&&t.add(o)}}),Array.from(t)},[C,v]);l.useEffect(()=>{yt.forEach(t=>{!Ke.has(t)&&!He[t]&&!ot.current.has(t)&&(ot.current.add(t),Zt(t,tr).then(r=>{lt.current&&r&&Qt(a=>({...a,[t]:r}))}).catch(r=>{lt.current&&(console.error("Failed to fetch avatar details:",r),ot.current.delete(t))}))})},[yt]);function rr({sceneId:t,elStyle:r,classes:a,videoVariables:i,setVideoVariables:n,dispatch:o,isThumbnail:s}){var S;const c=l.useRef(null),[m,g]=l.useState({}),b=/^cc_bgimg\d+_cc__FI__Z_0$/.test(t),d="https://investier.visionvivante.in/storage/deal_images/GJO5G81JE5jkAtseXrJjUyphnBjEc3QvTOj2bwVO.jpg?text="+encodeURIComponent(t),u=((S=i[t])==null?void 0:S.properties)||{},x=t.toLowerCase().includes("logo"),w=m[t]||(x?u.content||u.url||u.image:u.url||u.image||u.content)||d,$=async(f,p,y)=>{var h;try{await Se({template_id:z,user_id:(h=F.user)==null?void 0:h.id,deal_id:P.id,variables:{...p,[f]:{...p[f],properties:{...p[f].properties,url:y}}}})}catch(D){console.error("Error saving image",D)}};return e.jsxs("div",{className:"sceneblock",style:{padding:r==null?void 0:r.padding,zIndex:r==null?void 0:r.zIndex},children:[e.jsx("div",{className:`image ${a!=null&&a.includes("circle-frame")?"circle-frame":""}`,onClick:()=>{var f;!s&&!b&&((f=c.current)==null||f.click())},style:{cursor:s?"default":"pointer"},children:e.jsx("img",{alt:t,src:w,className:a!=null&&a.includes("circle-frame")?"circle-frame":""})}),!s&&!b&&e.jsx("input",{type:"file",accept:"image/*",ref:c,style:{display:"none"},onChange:async f=>{const p=f.target.files[0];if(!p)return;const y=new FormData;y.append("image",p);let h;try{h=await Vr(y)}catch(B){console.log(B)}const D=new FileReader;D.onload=B=>{B.target.result;const he=ye.cloneDeep(i);he[t]||(he[t]={properties:{}}),he[t].properties.url=h.data.url,n(he),o(we(he)),g(X=>({...X,[t]:h.data.url})),bt(h.data.url),$(t,he,h.data.url)},D.readAsDataURL(p)}})]},t)}function ar(t,r=!1){var p,y,h,D,B,he;const{id:a,type:i,elStyle:n={},classes:o=[],sceneId:s,fontSize:c,bold:m,italic:g,underline:b}=t;if(i==="image")return n.background?e.jsx("div",{className:"sceneblock",style:{padding:n.padding,zIndex:n.zIndex},children:e.jsx("div",{className:"image",style:{background:n.background}})},a):e.jsx(rr,{sceneId:s,elStyle:n,classes:o,videoVariables:v,setVideoVariables:W,dispatch:I,templateId:z,user:F,deal:P},a);if(i==="character"){const X=C.find(K=>K.id===s),Ae=X==null?void 0:X.variables.find(K=>K.type==="character"),Je=(Ae==null?void 0:Ae.name)||s,ze=(y=(p=v[Je])==null?void 0:p.properties)==null?void 0:y.character_id,ut=(D=(h=v[Je])==null?void 0:h.properties)==null?void 0:D.image,Fe=ie.find(K=>K.avatar_id===ze)||ie.find(K=>{const Ze=Z.find(N=>N.id===s);return Ze&&K.avatar_id===Ze.properties.character_id}),Q=ut||((he=(B=He[ze])==null?void 0:B.data)==null?void 0:he.preview_image_url)||(Fe==null?void 0:Fe.preview_image_url)||`https://investier.visionvivante.in/storage/profile/images/default-avatar.png?text=${encodeURIComponent(a)}`,qe=er[ze];return e.jsx("div",{className:"sceneblock",style:{padding:n==null?void 0:n.padding,zIndex:n==null?void 0:n.zIndex},children:e.jsx("div",{className:`avatar ${o!=null&&o.includes("circle-frame")?"circle-frame":""}`,children:qe?e.jsx("div",{className:"loading-placeholder",children:"Loading..."}):e.jsx("img",{alt:a,src:Q,className:`cursor-pointer ${o!=null&&o.includes("circle-frame")?"circle-frame":""} w-100 h-100 object-cover`,onClick:()=>{Ee(s),Me(!0)},onError:K=>{K.target.src.includes("default-avatar.png")||(K.target.src=`https://investier.visionvivante.in/storage/profile/images/default-avatar.png?text=${encodeURIComponent(a)}`)}})})},a)}function d(X){return X&&X.split("__")[0]}const[u,x]=l.useState({}),[w,$]=l.useState({}),[S,f]=l.useState({});if(i==="text"){const X=d(s),Ae=(N="")=>{if(!N)return{};const H={};return N.split("|").forEach(ae=>{let se=ae.trim();if(se)if(se=se.replace(/\s*\(.*?\)\s*/g,"").trim(),se.includes(":")){let[ue,J]=se.split(":",2);ue=ue.trim().toLowerCase(),J=J.trim(),!isNaN(J)&&J!==""?H[ue]=Number(J):H[ue]=J||!0}else H[se.toLowerCase()]=!0}),H},Je=(N="",H="")=>{if(!H)return null;const E=Ae(H);if(Object.keys(E).length===0)return null;const ae=(N||"").toString().trim();if(E.required&&ae==="")return"This field is required";if(E.numeric&&!/^\d*$/.test(ae))return"Only numbers allowed";if(E.max!==void 0){if(E.numeric){if(Number(ae)>E.max)return`Maximum value is ${E.max}`}else if(ae.length>E.max)return`Maximum ${E.max} characters allowed`}if(E.min!==void 0){if(E.numeric){if(Number(ae)<E.min)return`Minimum value is ${E.min}`}else if(ae.length<E.min)return`Minimum ${E.min} characters required`}return null},ze=N=>{var $t;const H=(($t=N.currentTarget.textContent)==null?void 0:$t.trim())||"",E=N.currentTarget.id,ae=d(E),se=S[ae];let ue=null;if(se&&(ue=Je(H,se)),ue){console.warn("Validation FAILED â†’ blocking save:",ue),x(ge=>({...ge,[E]:ue})),xe(ue,"error"),setTimeout(()=>{N.currentTarget.focus();const ge=document.createRange();ge.selectNodeContents(N.currentTarget);const pe=window.getSelection();pe==null||pe.removeAllRanges(),pe==null||pe.addRange(ge)},0);return}x(ge=>{const pe={...ge};return delete pe[E],delete pe[ae],pe});const J=ye.cloneDeep(v);J[E]||(J[E]={name:E,type:"text",properties:{}}),J[E].properties.content=H,W(J),I(we(J)),Le(ge=>({...ge,[E]:H})),Xt(E,H,J)},ut=["cc_titleplaceholder","cc_hero_cc","cc_img","cc_ds_name_cc","cc_phone_cc","cc_email_cc"],Fe=/^cc_plh\d+_cc/.test(X),Q=!r&&(Fe||ut.some(N=>X.startsWith(N))||!s.startsWith("cc_")),qe=r&&c?c*.5:c,K=u[s]||u[X],Ze=Ft[s]||wt(s);return e.jsxs("div",{contentEditable:Q?"true":"false",suppressContentEditableWarning:!0,id:s,"data-base-id":X,tabIndex:Q?0:-1,className:`text ${qt(s)} ${r?"thumbnail-text":""} ${K?"has-error":""}`,style:{...n,fontSize:qe?`${qe}px`:void 0,fontWeight:m?"bold":"normal",fontStyle:g?"italic":"normal",textDecoration:b?"underline":"none",cursor:Q?"text":"not-allowed",position:"relative",userSelect:Q?"text":"none",WebkitUserSelect:Q?"text":"none",MozUserSelect:Q?"text":"none",outline:"none",pointerEvents:r?"none":"auto"},onFocus:N=>{Q&&$(H=>({...H,[s]:!0}))},onBlur:ze,onKeyDown:N=>{if(Q){if(N.key===" "||N.key==="Spacebar"){N.stopPropagation();return}N.key==="Enter"&&(N.preventDefault(),N.currentTarget.blur()),(N.key==="ArrowLeft"||N.key==="ArrowRight"||N.key==="ArrowUp"||N.key==="ArrowDown")&&N.stopPropagation()}},onClick:N=>{Q&&!r&&N.stopPropagation()},onMouseDown:N=>{Q&&!r&&N.stopPropagation()},children:[Ze,K&&!r&&e.jsxs("div",{className:"error-message",style:{position:"absolute",bottom:"-28px",left:"0",right:"0",fontSize:"11px",color:"#DC2626",backgroundColor:"#FEE2E2",padding:"4px 8px",borderRadius:"4px",border:"1px solid #FCA5A5",zIndex:9999,textAlign:"center",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:["âš ï¸ ",K]})]},s)}}l.useEffect(()=>{const t=r=>{const a=document.activeElement,i=["TEXTAREA","INPUT"],n=a==null?void 0:a.isContentEditable,o=a==null?void 0:a.closest('[contenteditable="true"]');if(!(i.includes(a==null?void 0:a.tagName)||n||o)&&k.length){if(r.key===" "||r.key==="Spacebar"){r.preventDefault();return}r.key==="ArrowLeft"&&(r.preventDefault(),re(s=>(s-1+k.length)%k.length)),r.key==="ArrowRight"&&(r.preventDefault(),re(s=>(s+1)%k.length))}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[k.length]),l.useEffect(()=>{console.log("Current Validations from Redux:",O),console.log("Local validations state:",xt)},[O,xt]),l.useEffect(()=>{const t=r=>{const a=document.activeElement,i=["TEXTAREA","INPUT"],n=a==null?void 0:a.isContentEditable,o=a==null?void 0:a.closest('[contenteditable="true"]');if(!(i.includes(a==null?void 0:a.tagName)||n||o)&&k.length){if(r.key===" "||r.key==="Spacebar"){r.preventDefault();return}r.key==="ArrowLeft"&&(r.preventDefault(),re(s=>(s-1+k.length)%k.length)),r.key==="ArrowRight"&&(r.preventDefault(),re(s=>(s+1)%k.length))}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[k.length]);function jt(t){const r=t.match(/__VP_(\d+)$/);return r?parseInt(r[1],10):1/0}function _t({scene:t,index:r,isThumbnail:a=!1}){const i=l.useMemo(()=>(t.variables||[]).map(Jt).filter(Boolean),[t]),n=l.useMemo(()=>{const o=new Map;for(const s of i)s.key&&(o.has(s.key)||o.set(s.key,[]),o.get(s.key).push(s));for(const[s,c]of o.entries())c.sort((m,g)=>{const b=jt(m.sceneId),d=jt(g.sceneId);return b-d});return o},[i]);return e.jsxs("div",{className:"scene-root",children:[!a&&e.jsxs("div",{className:"scene-badge",children:["Scene ",r+1]}),e.jsxs("div",{className:"grid",children:[[...n.entries()].map(([o,s])=>e.jsx("div",{className:"area-wrapper",style:{gridColumn:s[0].gridCol,gridRow:s[0].gridRow},children:s.map(c=>ar(c,!1))},o)),i.flatMap(o=>(o.lines||[]).map((s,c)=>{const m=s.sc===s.ec,g=s.sr===s.er,b={gridColumn:s.gridCol,gridRow:s.gridRow,display:"flex",width:"100%",height:"100%",boxSizing:"border-box",pointerEvents:"none",zIndex:30};return m?e.jsx("div",{className:"line-wrapper",style:{...b,justifyContent:s.kind==="BL"?"flex-start":"flex-end",alignItems:"stretch"},children:e.jsx("div",{style:{width:2,height:"100%",background:s.kind==="AL"?"#0b1220":"#6b7280",opacity:s.kind==="AL"?1:.9}})},`${s.raw}-${c}`):g?e.jsx("div",{className:"line-wrapper",style:{...b,alignItems:s.kind==="BL"?"flex-start":"flex-end",justifyContent:"stretch"},children:e.jsx("div",{style:{height:3,width:"100%",background:s.kind==="AL"?"#0b1220":"transparent",borderTop:s.kind==="BL"?"2px dashed #6b7280":void 0}})},`${s.raw}-${c}`):e.jsx("div",{className:"line-wrapper",style:{...b,alignItems:"center",justifyContent:"center"},children:e.jsx("div",{style:{height:2,width:"100%",background:"#0b1220"}})},`${s.raw}-${c}`)}))]})]})}l.useEffect(()=>{const t=r=>{const a=document.activeElement,i=["TEXTAREA","INPUT"],n=a==null?void 0:a.isContentEditable,o=a==null?void 0:a.closest('[contenteditable="true"]');r.shiftKey||i.includes(a==null?void 0:a.tagName)||n||o||k.length&&(r.key==="ArrowLeft"&&(r.preventDefault(),re(s=>(s-1+k.length)%k.length)),r.key==="ArrowRight"&&(r.preventDefault(),re(s=>(s+1)%k.length)))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[k.length]),l.useEffect(()=>{if(k.length===0)return;const t=k[_e];if(!t)return;const r=document.querySelector(`div[data-scene-id="${t.id}"]`);r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),r.style.transition="background 0.4s",r.style.background="rgba(108, 93, 211, 0.12)",setTimeout(()=>{r.style.background=""},800))},[_e,k]);const[sr,nr]=l.useState([]),[ir,or]=l.useState(new Set),[lr,kt]=l.useState(!0);l.useEffect(()=>{(async()=>{var r,a;try{kt(!0);const i=await Cr(),o=(((r=i==null?void 0:i.data)==null?void 0:r.data)||[]).filter(g=>g.active===1||g.active==="1").map(g=>({voice_id:g.Voice_id||g.voice_id,name:g.Voice_name||g.voice_name||"Unnamed Voice",gender:g.Female==="x"||g.female==="x"?"female":"male",preview_url:g.preview_url||null,source:"custom"}));nr(o),I(Ar(o));const c=await(await fetch("https://api.heygen.com/v2/voices",{headers:{"Content-Type":"application/json","X-API-KEY":"sk_V2_hgu_kFHRWykcXEd_oisfR7mnYitgiX8vwtraF2NoDtg3J73V"}})).json(),m=new Set((((a=c==null?void 0:c.data)==null?void 0:a.voices)||[]).map(g=>g.voice_id));or(m)}catch(i){console.error("Voice load error:",i)}finally{kt(!1)}})()},[I]);const Ye=l.useRef(null),Nt=t=>{if(rt===t.voice_id){Ye.current.pause(),Oe(null);return}Ye.current&&Ye.current.pause();const r=new Audio(t.preview_audio);Ye.current=r,r.play(),Oe(t.voice_id),r.onended=()=>Oe(null)};l.useEffect(()=>{const t={};We.forEach(r=>{r.scripts.forEach(a=>{const i=`${r.id}-${a.name}`;!ft[i]&&$e.length>0&&(t[i]=$e[0])})}),Object.keys(t).length>0&&Be(r=>({...r,...t}))},[We,$e]);const cr=(t,r)=>{De(a=>({...a,[t]:!a[t]})),T(r),ve(null)},Ct=t=>{ve(r=>r===t?null:t),De({})},ct=l.useRef(null),At=l.useRef({});l.useEffect(()=>{function t(r){const a=document.querySelectorAll("[data-avatar-button]"),i=Array.from(a).some(m=>m.contains(r.target)),n=document.querySelectorAll("[data-voice-button]"),o=Array.from(n).some(m=>m.contains(r.target));i||o||ct.current&&ct.current.contains(r.target)||Object.values(At.current).some(m=>m&&m.contains(r.target))||r.target.closest(".right, .slider, .thumbnail-slider")||(De({}),ve(null))}return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[]);const dr=async(t,r=null)=>{var o,s;const a=r||ke;if(!a){console.error("No scene to update");return}const i=C.find(c=>c.id===a),n=i==null?void 0:i.variables.find(c=>c.type==="character");if(n){const c=ye.cloneDeep(v);c[n.name]={...c[n.name],properties:{...(o=c[n.name])==null?void 0:o.properties,character_id:t.avatar_id||t.id,image:t.image_url||t.preview_image_url}},W(c),I(we(c));try{await Se({template_id:z,user_id:(s=F.user)==null?void 0:s.id,deal_id:P.id,variables:c})}catch(m){console.error("Error saving avatar",m)}}},ur=t=>{if(!(t>=et&&t<et+Ve)){const a=Math.max(0,t-Math.floor(Ve/2)),i=Math.max(0,k.length-Ve),n=Math.min(a,i);tt(n)}};l.useEffect(()=>{ur(_e)},[_e,Ve,k.length]),l.useEffect(()=>{console.log("videoVariables updated",v)},[v]);const pr=async t=>{try{const a=await(await fetch("https://api.heygen.com/v2/avatar_group.list?include_public=true",{method:"GET",headers:{"Content-Type":"application/json","X-API-KEY":"sk_V2_hgu_kFHRWykcXEd_oisfR7mnYitgiX8vwtraF2NoDtg3J73V"}})).json();I(Sr(a.data.avatar_group_list))}catch(r){console.error("API error:",r)}finally{}};l.useEffect(()=>{pr()},[]);const[Xr,St]=l.useState(!1),[Kr,Et]=l.useState(null),mr=async t=>{var r;try{St(!0),Et(null);const a=await fetch(`https://api.heygen.com/v2/avatar_group/${t}/avatars`,{method:"GET",headers:{"X-Api-Key":"sk_V2_hgu_kFHRWykcXEd_oisfR7mnYitgiX8vwtraF2NoDtg3J73V"}});if(!a.ok)throw new Error(`API call failed: ${a.status}`);const n=((r=(await a.json()).data)==null?void 0:r.avatar_list)||[];Y(n)}catch(a){console.error("Error fetching avatar group:",a),Et(a.message)}finally{St(!1)}},Vt=async()=>{var t,r;try{le(!0);const a={userId:(t=F.user)==null?void 0:t.id,dealId:P.id},n=(r=(await Er(a)).data)==null?void 0:r.data;if(!n)return;Ue(o=>o.map(s=>{const c=s.scripts.map(m=>({...m,value:n[m.name]||m.value}));return{...s,scripts:c}}))}catch(a){console.error("Error fetching scripts:",a)}finally{le(!1)}},[dt,xr]=l.useState([]);return l.useEffect(()=>{if(ke){const t=["PUBLIC_PHOTO","PUBLIC","COMMUNITY_PHOTO"],a=te.filter(i=>{var n;return t.includes((n=i.group_type)==null?void 0:n.trim().toUpperCase())}).sort(()=>Math.random()-.5).slice(0,4);xr(a)}},[ke,te]),e.jsxs(e.Fragment,{children:[e.jsx(Tr,{loading:je}),e.jsxs("div",{className:"flex items-center justify-between bg-white dark:bg-[#121212] text-white px-4 py-3 shadow-md rounded-lg mb-1 container mx-auto hide-in-landscape",children:[e.jsxs("button",{onClick:()=>ne("/deal-view-ai-video-generator"),className:"flex items-center gap-2 text-lg font-semibold text-black dark:text-white  transition",children:[e.jsx($r,{className:"text-xl"}),e.jsx("span",{children:"Back"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-around gap-3 md:gap-8 relative",children:[e.jsx(yr,{}),e.jsx("button",{className:"bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition",onClick:Ht,children:"Reset"}),e.jsx("button",{className:"bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition",onClick:Kt,children:"Generate"}),e.jsx(Rr,{show:_,onClose:()=>A(!1),modalTitle:ce,modalMessage:j,showProgress:Qe})]})]}),e.jsxs("div",{className:"app-root",children:[e.jsx("style",{children:`
            :root{
          --slide-radius: 18px;
          --gap: 10px;
          --card-bg: #ffffff;
          --app-bg: #0f1220;
          --shadow: 0 10px 30px rgba(0,0,0,.35);
          --text-soft:#6b7280;
          --text-strong:#111827;
        }
        .app-root{ min-height:60vh;  align-items:center; justify-content:center; padding:24px; box-sizing:border-box; background: #FDFDFD; }
       
        .dark .app-root{
        background:#121212
        }
          font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
          color:var(--text-strong);
        }
           .app-root {
          var(--app-bg);
          font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
          color:var(--text-strong);
          }
        .layout{ width:100%; max-width:1200px; display:flex; background-color:#FDFDFD }
        textarea{ width: 100%; }
        // .left{ color:#fff; width: 100%; min-width: 400px; background:white; box-shadow: var(--shadow); border-radius:15px; }
          .left{ color:#fff; width: 100%; min-width: 400px;}
        .right{ flex:1; display:flex; align-items:center; justify-content:center; }
        .slider{ position:relative; width: min(92vw, 700px); aspect-ratio: 12 / 6; background: var(--card-bg); border-radius: var(--slide-radius); overflow:hidden; margin: auto; }
        .scene-root{height:100% ; background: #F3F3F3; }
        .slide{ position:absolute; inset:0; opacity:0; pointer-events:none; transition: opacity .45s ease;  box-sizing:border-box; }
        .slide.active{ opacity:1; pointer-events:auto; }
        .grid{ display:grid; grid-template-columns: repeat(12, 1fr); grid-template-rows: repeat(6, 1fr);  width:100%; height:100%; }
        .area-wrapper{ display:grid; grid-auto-rows: 1fr; width:100%; height:100%; border-radius: 12px; overflow:hidden; position:relative; }
        .sceneblock{ display:flex; align-items:center; justify-content:center; width:100%; height:100%; box-sizing:border-box; position:relative; margin:4px; max-width: 100%; max-height: 100%; overflow: hidden; text-align: center; z-index: 9; }
        .text{ padding: 12px 14px; color: var(--text-strong); width: calc(100% - 4px); height: calc(100% - 4px); margin: 2px; display:flex; align-items:center; justify-content:center; text-align:center; font-size: 14px; line-height: 1.4; color: #222; word-wrap: break-word; word-break: break-word; white-space: normal; overflow: hidden; text-overflow: ellipsis; max-width: 100%; max-height: 100%; }
        .text:focus { outline: none; border: none;}
        .text.header{ font-weight: 800; font-size: clamp(16px, 2vw, 22px); }
        .text.subtitle{ font-weight: 600; font-size: clamp(14px, 1.6vw, 18px); color: var(--text-soft); }
        .text.title{ font-weight: 700; font-size: clamp(15px, 1.8vw, 20px); }
        .text.callout{ font-weight: 700; font-size: clamp(14px, 1.6vw, 18px); border-color:#ffe6b3; }
        .image{ width:100%; height:100%; overflow:hidden; border-radius: 12px; }
        .image > img{ width:100%; height:100%; object-fit: cover; display:block; }
        .avatar{ width: 100%; display: contents; }
        .avatar img{ height: 100%; }
        .circle-frame, .circle-frame > img{ border-radius: 50% !important; width: 100%; height: 100%; object-position: top; background-color: #fff; object-fit: cover; }
       .nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 50%;
    background: rgba(0, 0, 0, .55);
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    z-index: 20;
}
        .nav.prev{ left:14px; }
        .nav.next{ right:14px; }
        .scene-badge{ position:absolute; right:16px; top:14px; background: rgba(17,24,39,.75); color:#fff; font-size:12px; padding:6px 10px; border-radius:999px; z-index: 20; }
        .line-wrapper { display:flex; align-items:center; justify-content:stretch; pointer-events:none; z-index:20; }
        .error{ color:#fecaca; background:#7f1d1d; border:1px solid #fecaca33; padding:8px 10px; margin:8px 0; border-radius:8px; font-size:12px; }
        .controls{ display:flex; gap:8px; align-items:center; margin-top:8px; }
        .btn{ background:#111827; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; box-shadow: 0 6px 16px rgba(0,0,0,.25); }
        .btn:active{ transform: translateY(1px); }
        textarea{color:#000}
        .thumbnail .avatar img { pointer-events: none; cursor: default; }
 .thumbnail .image,
.thumbnail .image img {
  pointer-events: none;
  cursor: default;
}
  /* Add these new rules to your existing CSS */
.thumbnail .text {
  padding: 6px 7px;
  font-size: 7px;
  line-height: 1.2;
}

.thumbnail .text.header {
  font-size: clamp(8px, 1vw, 11px);
}

.thumbnail .text.subtitle {
  font-size: clamp(7px, 0.8vw, 9px);
}

.thumbnail .text.title {
  font-size: clamp(7.5px, 0.9vw, 10px);
}

.thumbnail .text.callout {
  font-size: clamp(7px, 0.8vw, 9px);
}

.thumbnail .sceneblock {
  margin: 2px;
}
  @media (max-width: 768px) {
    .layout {
      flex-direction: column;
    }
    .left {
      min-width: 100%;
      margin-bottom: 20px;
    }
    .right {
      width: 100%;
      margin-top: 20px;
    }
  } 
    @media(max-width:579px){
    .app-root {
    padding: 94px}
    }
     @media(max-width:768px){
    .app-root {
    padding: 94px}
    }

    @media (orientation: landscape) and (max-width:579px) {
  .hide-in-landscape {
    display: none;
  }


}
  @media (max-width: 820px) {
  .app-root {
   padding: 147px 24px;
  }

  @media (max-width: 768px) {
  .scene-root {
    font-size: 13px;
  }

}

 @media (max-width:579px) {
  .scene-root {
    font-size: 7px;
  }

  .scene-badge {
    font-size: 7px;
    padding: 4px 8px;
  }

  .slider .text {
  padding: 6px 7px;
  font-size: 7px;
  line-height: 1.2;
}
}


@media (max-width: 768px) {
  /* General text inside the main scene */
  .slider .text {
    font-size: 10px;
    line-height: 1.3;
    padding: 8px 10px;
  }


  .slider .text.header {
    font-size: clamp(11px, 2vw, 14px);
  }

  .slider .text.subtitle {
    font-size: clamp(10px, 1.8vw, 13px);
  }

  .slider .text.title {
    font-size: clamp(10.5px, 1.9vw, 13.5px);
  }

  .slider .text.callout {
    font-size: clamp(10px, 1.8vw, 12.5px);
  }

  .scene-badge {
    font-size: 10px;
    padding: 4px 8px;
  }
}


@media (max-width: 579px) {
  .slider .text {
    font-size: 8.5px;
    line-height: 1.3;
  }

  .slider .text.header {
    font-size: clamp(9px, 2.2vw, 12px);
  }

  .slider .text.subtitle,
  .slider .text.title,
  .slider .text.callout {
    font-size: clamp(8px, 2vw, 11px);
  }

  .scene-badge {
    font-size: 8px;
  }
}

.text:focus {
  outline: 2px solid #6C5DD3 !important;
  outline-offset: 2px;
}

.text[contenteditable="true"]:empty:before {
  content: attr(placeholder);
  color: #9CA3AF;
  font-style: italic;
}

 .text[contenteditable="true"] {
      cursor: text !important;
      user-select: text !important;
      -webkit-user-select: text !important;
    }
    
    .text[contenteditable="true"]:focus {
      outline: 2px solid #6C5DD3 !important;
      outline-offset: 2px;
      background-color: rgba(108, 93, 211, 0.05);
    }
    
    .text[contenteditable="true"]:hover {
      background-color: rgba(108, 93, 211, 0.03);
    }
    
    .text.has-error {
      border: 2px solid #DC2626 !important;
      background-color: rgba(220, 38, 38, 0.05) !important;
    }
    
    .thumbnail-text {
      pointer-events: none !important;
      user-select: none !important;
    }
      `}),e.jsxs("div",{className:"layout container mx-auto",children:[e.jsx("button",{onClick:()=>gt(!Ge),className:"lg:hidden fixed bottom-6 right-6 z-50 bg-[#6C5DD3] text-white p-3 px-5 rounded-md shadow-lg hover:bg-[#5a4bc4] transition-all duration-200","aria-label":"Toggle Script Panel",children:Ge?e.jsx(Ir,{className:"w-6 h-6"}):"Scripts"}),e.jsxs("div",{className:`
        lg:hidden fixed inset-x-0 bottom-0 w-full h-full max-h-[85vh]
        bg-white dark:bg-gray-900 rounded-t-3xl shadow-2xl z-40 overflow-y-auto
        transform transition-transform duration-300 ease-in-out
        ${Ge?"translate-y-0":"translate-y-full"}
      `,children:[e.jsx("div",{className:"sticky top-0 pt-4 pb-3 flex justify-center bg-inherit z-10",children:e.jsx("div",{className:"w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full"})}),e.jsxs("div",{className:"p-4 pb-24",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h4",{className:"text-black font-semibold text-lg",children:"Script"}),e.jsx("button",{onClick:Vt,disabled:G,className:`bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition flex items-center gap-2 ${G?"opacity-70 cursor-not-allowed":"hover:bg-[#5a4bc4]"}`,children:G?"Generating...":"Generate Scripts"})]}),e.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"62vh"},children:We.map((t,r)=>e.jsx("div",{className:"mb-6 border border-gray-200 dark:border-gray-700 rounded-xl p-4 shadow-sm bg-white dark:bg-gray-800",children:t.scripts.map(a=>{const i=`${t.id}-${a.name}`;return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex gap-3 items-start flex-col",children:[(()=>{var g,b,d,u;const n=C.find(x=>x.id===t.id),o=n==null?void 0:n.variables.find(x=>x.type==="character");if(!o)return null;const s=v[o.name],c=(g=s==null?void 0:s.properties)==null?void 0:g.character_id,m=((d=(b=He[c])==null?void 0:b.data)==null?void 0:d.preview_image_url)||((u=ie.find(x=>x.avatar_id===c))==null?void 0:u.preview_image_url)||me;return e.jsxs("button",{onClick:()=>Ct(t.id),className:"flex items-center gap-2 px-3 py-2 border rounded-lg hover:shadow-md transition",children:[e.jsx("img",{src:m,alt:"Avatar",className:"w-8 h-8 rounded-full object-cover"}),e.jsx(pt,{className:"text-sm"})]})})(),e.jsx("div",{className:"flex-1 space-y-3 w-full",children:e.jsx("textarea",{rows:4,value:a.value,onChange:n=>vt(t.id,a.name,n.target.value),placeholder:"Write your script here...",className:"w-full p-3 rounded-lg border dark:border-gray-600 dark:bg-gray-800 text-black dark:text-white resize-none focus:ring-2 focus:ring-[#6C5DD3] focus:outline-none"})})]})},i)})},t.id))})]})]}),e.jsx("div",{className:`
  hidden lg:block lg:relative h-full lg:w-auto w-full left fixed
  bg-white dark:bg-[#121212] z-40
  overflow-y-auto
`,children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h4",{className:"text-black dark:text-[#F8F8F8]",children:"Script"}),e.jsx("button",{className:`bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition flex items-center justify-center gap-2 mb-4 ${G?"opacity-70 cursor-not-allowed":""}`,onClick:Vt,disabled:G,children:G?"Generating...":"Generate Scripts"})]}),e.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"70vh",padding:"10px"},children:We.map((t,r)=>{var i;return(((i=C[r])==null?void 0:i.variables)||[]).filter(n=>n.type==="character"),e.jsx("div",{"data-scene-id":t.id,onFocus:()=>re(r),className:"mb-6 border border-gray-200 dark:border-[#181818] rounded-xl p-4 shadow-sm bg-white dark:bg-[#121212] focus-within:ring-2 focus-within:ring-[#6C5DD3] focus-within:outline-none",children:t.scripts.map((n,o)=>{const s=`${t.id}-${n.name}`,c=ft[s];return ht[s],e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 justify-start",children:[(()=>{const m=C.find(d=>d.id===t.id),g=m==null?void 0:m.variables.find(d=>d.type==="character");return g&&v[g.name]?e.jsxs("div",{className:"relative inline-block",children:[e.jsxs("button",{"data-avatar-button":"true",onClick:()=>Ct(t.id),className:"flex items-center justify-between px-4 py-2 border border-gray-300 bg-white text-black dark: font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 w-auto",children:[(()=>{var f,p,y;const d=C.find(h=>h.id===t.id),u=d==null?void 0:d.variables.find(h=>h.type==="character");if(!u)return e.jsx("span",{className:"text-sm",children:"No Character"});const x=v[u.name],w=(f=x==null?void 0:x.properties)==null?void 0:f.character_id,$=ie.find(h=>h.avatar_id===w),S=((y=(p=He[w])==null?void 0:p.data)==null?void 0:y.preview_image_url)||($==null?void 0:$.preview_image_url)||me;return e.jsx("img",{src:S,alt:"Avatar",className:"w-6 h-6 rounded-full object-cover",onError:h=>{h.target.src=me}})})(),e.jsx(pt,{className:"ml-2 text-black flex-shrink-0"})]}),ke===t.id&&e.jsxs("div",{ref:ct,className:"absolute left-0 mt-2 w-80 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl z-50",children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-200 dark:border-gray-700",children:V&&V.length>0?e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>{M?Ne(null):Y([])},className:"flex items-center gap-1 text-sm font-medium text-purple-600 hover:text-purple-800 transition-colors duration-200",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"Back"]})}):e.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Select Avatar"})}),e.jsx("div",{className:"flex items-center justify-center my-4",children:e.jsx("div",{className:`flex justify-center gap-3 ${V&&V.length>0&&!M?"overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent":""}`,children:V&&V.length>0&&M?e.jsxs("div",{className:"flex flex-col items-center justify-center w-full px-4",children:[e.jsx("div",{className:"relative w-24 h-24 rounded-full overflow-hidden border-2 border-purple-500 ring-2 ring-purple-200",children:e.jsx("img",{src:M.preview_image_url??M.image_url??M.image,alt:"Selected avatar",className:"w-full h-full object-cover",onError:d=>d.currentTarget.src=me})}),e.jsxs("div",{className:"mt-3 text-center",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:M.name||M.avatar_name||`Avatar ${M.avatar_id??M.id}`}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Ready to apply"})]})]}):V&&V.length>0?V.map((d,u)=>{const x=C.find(S=>S.id===t.id);if(!(x==null?void 0:x.variables.find(S=>S.type==="character")))return null;const $=(d==null?void 0:d.image_url)||(d==null?void 0:d.preview_image_url);return e.jsx("div",{className:"flex flex-col items-center flex-shrink-0",children:e.jsx("button",{onClick:()=>{Ne(d)},className:"relative w-16 h-16 rounded-full overflow-hidden border-2 border-gray-200 hover:border-purple-300 hover:ring-2 hover:ring-purple-100 transition-all duration-200 flex-shrink-0",children:$?e.jsx("img",{src:$,alt:`Avatar ${u+1}`,className:"w-full h-full object-cover",onError:()=>console.error("Failed to load avatar image:",$)}):e.jsx("div",{className:"w-full h-full bg-gray-100 flex items-center justify-center text-gray-400",children:e.jsx("svg",{className:"w-8 h-8",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z",clipRule:"evenodd"})})})})},`modal_${u}`)}):dt&&dt.length>0?dt.map((d,u)=>{var y;const x=C.find(h=>h.id===t.id),w=x==null?void 0:x.variables.find(h=>h.type==="character");if(!w)return null;const $=v[w.name],S=(y=$==null?void 0:$.properties)==null?void 0:y.character_id,f=d.preview_image||d.image,p=S===d.avatar_id;return e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("button",{onClick:async()=>{const h=d.id||d.avatar_id;try{await mr(h)}catch(D){console.error("Error fetching avatars:",D)}},className:`relative w-16 h-16 rounded-full overflow-hidden border-2 transition-all duration-200 flex-shrink-0 ${p?"border-purple-500 ring-2 ring-purple-200":"border-gray-200 hover:border-purple-300 hover:ring-2 hover:ring-purple-100"}`,children:f?e.jsx("img",{src:f,alt:d.name||`Avatar ${u+1}`,className:"w-full h-full object-cover",onError:()=>console.error("Failed to load avatar image:",f)}):e.jsx("div",{className:"w-full h-full bg-gray-100 flex items-center justify-center text-gray-400",children:e.jsx("svg",{className:"w-8 h-8",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z",clipRule:"evenodd"})})})})},d.avatar_id||d.id||u)}):e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:[e.jsx("div",{className:"text-2xl mb-2",children:"ðŸ‘¤"}),e.jsx("p",{className:"text-sm",children:"No avatars available"})]})})}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 p-3",children:V&&V.length>0&&M?e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:async()=>{await dr(M,t.id),ve(null),Y([]),Ne(null)},className:"flex-1 px-4 py-2 text-sm font-medium text-[#6C5DD3] bg-white rounded-md transition-colors duration-200 border border-purple-200 hover:border-purple-300 flex items-center justify-center gap-2",children:"Apply One"}),e.jsx("button",{onClick:async()=>{var x,w;if(!M)return;const d={avatar_id:M.avatar_id??M.id,preview_image_url:M.preview_image_url??M.image_url},u=ye.cloneDeep(v);for(const $ of C){const S=$.variables.find(f=>f.type==="character");S&&(u[S.name]={...u[S.name],properties:{...(x=u[S.name])==null?void 0:x.properties,character_id:d.avatar_id,image:d.preview_image_url}})}W(u),I(we(u)),await Se({template_id:z,user_id:(w=F.user)==null?void 0:w.id,deal_id:P.id,variables:u}),ve(null),Y([]),Ne(null)},className:"flex-1 px-4 py-2 text-sm font-medium text-white bg-[#6C5DD3] rounded-md transition-colors duration-200 flex items-center justify-center gap-2",children:"Apply to All"})]}):V&&V.length>0?e.jsx("p",{className:"text-xs text-center text-gray-500 dark:text-gray-400 py-2",children:"Select an avatar above to continue"}):e.jsx("button",{onClick:()=>{const d=C.find(x=>x.id===t.id),u=d==null?void 0:d.variables.find(x=>x.type==="character");Ee(u?u.name:t.id),Me(!0),ve(null)},className:"w-full px-4 py-2 text-sm font-medium text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-md transition-colors duration-200 border border-purple-200 hover:border-purple-300",children:"View All Avatars"})})]})]}):null})(),(()=>{var u,x;const m=s.match(/scene_(\d+)_script/);if(!m)return null;const b=`voice_id_${m[1]}`;return((x=(u=v[b])==null?void 0:u.properties)==null?void 0:x.voice_id)?e.jsxs("div",{className:"relative inline-block w-1/2",children:[e.jsxs("button",{"data-voice-button":"true",onClick:()=>cr(s,s),className:"flex items-center justify-between px-4 py-2 border dark:border-[#181818] rounded-lg dark:bg-[#121212] shadow-md transition text-left text-black dark:text-white w-full",children:[e.jsx("span",{className:"truncate max-w-[70%]",children:(()=>{var y,h;const w=s.match(/scene_(\d+)_script/);if(!w)return(c==null?void 0:c.name)||"Select AI Voice";const S=`voice_id_${w[1]}`,f=(h=(y=v[S])==null?void 0:y.properties)==null?void 0:h.voice_id,p=$e.find(D=>D.voice_id===f)||c;return(p==null?void 0:p.name)||"Select AI Voice"})()}),e.jsx(pt,{className:"ml-2 text-gray-500 shrink-0"})]}),ht[s]&&c&&e.jsxs("div",{ref:w=>At.current[s]=w,className:"absolute mt-2 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg z-50 p-2 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center justify-around my-1",children:[e.jsx("button",{onClick:()=>Nt(c),className:"px-3 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg transition flex items-center justify-center",children:rt===(c==null?void 0:c.voice_id)?e.jsx(Dt,{className:"text-lg text-purple-600"}):e.jsx(It,{className:"text-lg text-purple-600"})}),e.jsx("span",{className:"text-sm text-center text-black font-medium",children:(()=>{var y,h;const w=s.match(/scene_(\d+)_script/);if(!w)return c==null?void 0:c.name;const S=`voice_id_${w[1]}`,f=(h=(y=v[S])==null?void 0:y.properties)==null?void 0:h.voice_id,p=$e.find(D=>D.voice_id===f)||c;return(p==null?void 0:p.name)||"Select AI Voice"})()})]}),e.jsx("button",{onClick:()=>{Bt(s),De(w=>({...w,[s]:!1}))},className:"w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition",children:"View All"})]})]}):null})()]}),(()=>{var m;return(m=n.value)!=null&&m.trim().split(/\s+/).filter(Boolean).length,e.jsxs(e.Fragment,{children:[e.jsx("textarea",{rows:4,value:n.value,onFocus:()=>re(r),onChange:g=>vt(t.id,n.name,g.target.value),placeholder:"Write your script here...",className:`w-full p-3 rounded-lg shadow-sm resize-none focus:outline-none transition
          dark:border-gray-600 dark:bg-gray-800 text-black dark:text-white
          ${Xe[n.name]?"border border-red-500":""}`}),Xe[n.name]&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:Xe[n.name]}),e.jsxs("p",{className:`text-xs mt-1 ${st(n.value)>Ce?"text-red-500":"text-gray-400"}`,children:[st(n.value)," / ",Ce," words"]})]})})()]},s)})},t.id)})})]})}),Ge&&e.jsx("div",{className:"lg:hidden fixed inset-0 bg-black bg-opacity-50 z-30",onClick:()=>gt(!1)}),e.jsx("div",{className:"right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"flex-1 flex items-center justify-center lg:block",children:e.jsx("div",{className:"w-full px-4 lg:px-0",children:e.jsxs("div",{className:"slider",children:[e.jsx("button",{className:"nav prev",onClick:()=>k.length&&re(t=>(t-1+k.length)%k.length),"aria-label":"Previous",children:"â®"}),e.jsx("button",{className:"nav next",onClick:()=>k.length&&re(t=>(t+1)%k.length),"aria-label":"Next",children:"â¯"}),k.map((t,r)=>e.jsx("div",{className:`slide ${r===_e?"active":""}`,children:e.jsx(_t,{scene:t,index:r})},t.id||r))]})})}),e.jsx("div",{className:"fixed bottom-20 left-0 right-0 lg:relative lg:bottom-auto lg:left-auto lg:right-auto lg:mt-3 hide-in-landscape",children:e.jsxs("div",{className:"thumbnail-slider flex items-center justify-center relative px-4 lg:px-0 bg-white dark:bg-[#121212] lg:py-0 lg:bg-transparent",children:[e.jsx("button",{className:"thumb-nav prev",onClick:()=>tt(t=>Math.max(t-1,0)),children:"â®"}),e.jsx("div",{className:"thumbnails-wrapper overflow-hidden w-full sm:w-[750px]",children:e.jsx("div",{className:"thumbnails-track flex transition-transform duration-300",style:{transform:`translateX(-${et*Tt}px)`},children:k.map((t,r)=>e.jsx("div",{className:`thumbnail ${r===_e?"active":""} 
                w-[100px] h-[60px] sm:w-[140px] sm:h-[80px] mr-2`,onClick:a=>{var i;a.stopPropagation(),re(r),(i=document.getElementById(`textarea-${t.id}`))==null||i.scrollIntoView({behavior:"smooth",block:"center"})},children:e.jsx(_t,{scene:t,index:r,isThumbnail:!0})},t.id||r))})}),e.jsx("button",{className:"thumb-nav next",onClick:()=>tt(t=>Math.min(t+1,k.length-Ve)),children:"â¯"})]})})]})})]}),mt&&e.jsx(zr,{show:mt,onClose:()=>{Me(!1),Ee(null)},avatars:Ut,VideoScenes:C,activeBlock:Rt,videoVariables:v,onSelect:async(t,r)=>{var n;const a=ye.cloneDeep(v),i=o=>{var b,d;const s=o==null?void 0:o.trim();let c=C.find(u=>u.id===s);if(c||(c=C.find(u=>u.variables.some(x=>x.name===s||x.name.startsWith(s)))),!c){if(console.warn(`[Parent] Scene ${s} not found in VideoScenes`),console.warn("[Parent] Trying to find character variable directly in videoVariables..."),v[s]){a[s]={...a[s],properties:{...(b=a[s])==null?void 0:b.properties,character_id:t.avatar_id,image:t.preview_image_url}};return}console.error("[Parent] Could not find scene or variable for:",s);return}const m=c.variables.find(u=>u.type==="character");if(!m){console.warn(`[Parent] No character variable in scene ${c.id}`);return}const g=m.name;a[g]={...a[g],properties:{...(d=a[g])==null?void 0:d.properties,character_id:t.avatar_id,image:t.preview_image_url}}};r==="ALL"?C.forEach(o=>{o.variables.find(c=>c.type==="character")&&i(o.id)}):r&&i(r),W(a),I(we(a));try{await Se({template_id:z,user_id:(n=F.user)==null?void 0:n.id,deal_id:P.id,variables:a})}catch(o){console.error("[Parent] Error saving avatar to API",o)}Me(!1),Ee(null)}}),e.jsx(Fr,{isModalOpen:Pt,setIsModalOpen:at,voices:sr,heygenVoiceIds:ir,loading:lr,voiceKey:U,videoVariables:v,playingAudioId:rt,handlePlayAudio:Nt,handleVoiceSelect:Ot})]})]})}export{ea as default};
