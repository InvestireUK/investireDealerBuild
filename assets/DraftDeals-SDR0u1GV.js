import{s as U,t as X,q as Z,r as p,u as ee,a7 as se,m as s,x as te,am as ae,p as re,an as le,ao as ne,A as oe,aa as ce,C as ie,E as de,H as pe,I as he,J as me,K as ue,M as ge,ab as N,N as xe}from"./index-BU7qlyvS.js";import{D as fe}from"./DeleteConfirmationModal-AflunMm3.js";const ve=()=>{const i=U(),C=X(),{showSnackbar:m}=Z(),[D,M]=p.useState([]),[ye,je]=p.useState([]),[A,u]=p.useState(!1),[L,v]=p.useState(!1),[k,x]=p.useState(!1),[b,P]=p.useState(null),f=ee(e=>e.deal.draftDeals),[n,E]=p.useState({currentPage:1,totalPages:1,from:0,to:0,total:0,hasMorePages:!1}),[a,h]=p.useState({per_page:10,page:1,status:"draft",year:"",propertyTypeId:"",dealTypeId:"",sortColumn:"created_at",sortOrder:"desc"}),{data:y,loading:O}=se(ce),S=async()=>{try{u(!0);const e=await oe({page:a.page,perPage:a.per_page,status:a.status,year:a.year===""?null:a.year,propertyTypeId:a.propertyTypeId===""?null:a.propertyTypeId,dealTypeId:f!==null?f:a.dealTypeId===""?null:a.dealTypeId,sortColumn:a.sortColumn,sortOrder:a.sortOrder});if(e&&e.data&&e.data.data){M(e.data.data.deals||[]);const t=e.data.data.page_context;t&&E({currentPage:parseInt(t==null?void 0:t.page)||1,totalPages:Math.ceil(parseInt((t==null?void 0:t.total_records)||0)/parseInt((t==null?void 0:t.per_page)||10)),from:(parseInt(t.page)-1)*parseInt(t.per_page)+1,to:Math.min(parseInt(t==null?void 0:t.page)*parseInt(t==null?void 0:t.per_page),parseInt((t==null?void 0:t.total_records)||0)),total:parseInt((t==null?void 0:t.total_records)||0),hasMorePages:(t==null?void 0:t.has_more_page)==="true"})}}catch{m("Failed to fetch draft deals. Please try again.","error")}finally{u(!1)}};p.useEffect(()=>{S()},[a,f]);const j=e=>{const{name:t,value:r}=e.target;h({...a,[t]:r,page:1})},R=e=>{h(t=>({...t,sortColumn:e,sortOrder:t.sortColumn===e&&t.sortOrder==="asc"?"desc":"asc",page:1}))},$=()=>{n.hasMorePages&&h(e=>({...e,page:e.page+1}))},B=()=>{a.page>1&&h(e=>({...e,page:e.page-1}))},Y=e=>{e>=1&&e<=n.totalPages&&h(t=>({...t,page:e}))},z=async(e,t)=>{var r,l,d,o,g,I,T;if(e)try{u(!0);const c=await de(e);i(pe()),i(he()),i(me()),i(ue()),i(ge());for(let _=1;_<=t;_++)i({type:`deal/setDealSteps${_}`,payload:!0});console.log("draft deal up ",N),i(N()),console.log("draft deal down ",N);const{id:_e,...W}=((l=(r=c==null?void 0:c.data)==null?void 0:r.data)==null?void 0:l.propertyDealInvestment)||{},F=((g=(o=(d=c==null?void 0:c.data)==null?void 0:d.data)==null?void 0:o.deal)==null?void 0:g.step_completed)||1,Q={...(T=(I=c==null?void 0:c.data)==null?void 0:I.data)==null?void 0:T.deal,...W,step:F};i(xe(Q)),i({type:"deal/setCurrentStep",payload:F}),C("/create-deal/address")}catch{m("Failed to edit deal. Please try again.","error")}finally{u(!1)}},G=e=>{P(e),x(!0)},q=async()=>{if(b)try{v(!0);const e=await ie(b);e&&e.data?(m("Deal deleted successfully","success"),S()):m("Failed to delete deal","error"),x(!1),P(null)}catch(e){console.error("Error deleting deal:",e),m("Failed to delete deal","error")}finally{v(!1)}},H=e=>{const t=[];e.address_line_1&&t.push(e.address_line_1),e.address_line_2&&t.push(e.address_line_2),e.city&&t.push(e.city),e.post_code&&t.push(e.post_code);const r=t.join(", "),l=120;return r.length>l?r.substring(0,l)+"...":r},w=(y==null?void 0:y.data)||{property_types:[],deal_types:[]},J=new Date().getFullYear(),K=Array.from({length:4},(e,t)=>J-t),V=()=>{const e=n.totalPages,t=n.currentPage;if(e<=5)return Array.from({length:e},(o,g)=>g+1);const r=[1];let l=Math.max(2,t-1),d=Math.min(e-1,t+1);t<=3?d=Math.min(4,e-1):t>=e-2&&(l=Math.max(e-3,2)),l>2&&r.push("...");for(let o=l;o<=d;o++)r.push(o);return d<e-1&&r.push("..."),e>1&&r.push(e),r};return s.jsxs("div",{className:"overflow-x-auto p-4",children:[s.jsx(fe,{isOpen:k,onClose:()=>x(!1),onConfirm:q,title:"Delete Deal",isLoading:L}),s.jsx("div",{className:"flex justify-start items-center mb-5",children:s.jsx("h1",{className:"text-3xl font-semibold",children:"Draft Deals"})}),s.jsxs("div",{className:"grid sm:grid-cols-3 gap-4 mb-4",children:[s.jsxs("select",{name:"year",value:a.year,onChange:j,className:"form-select",children:[s.jsx("option",{value:"",children:"All Years"}),K.map(e=>s.jsx("option",{value:e.toString(),children:e},e))]}),s.jsxs("select",{name:"propertyTypeId",value:a.propertyTypeId,onChange:j,className:"form-select",children:[s.jsx("option",{value:"",children:"All Property Types"}),w.property_types.map(e=>s.jsx("option",{value:e.id,children:e.title},e.id))]}),s.jsxs("select",{name:"dealTypeId",value:a.dealTypeId,onChange:j,className:"form-select",children:[s.jsx("option",{value:"",children:"All Deal Types"}),w.deal_types.map(e=>s.jsx("option",{value:e.id,children:e.title},e.id))]})]}),A||O?s.jsx(te,{}):s.jsx("div",{className:"overflow-x-auto dark:bg-[#222632] bg-[#EBEBEC] comparable-listing-table-wrap",children:s.jsxs("table",{className:"w-full text-left border-collapse",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"bg-[#6C5DD3] text-white",children:[s.jsx("th",{className:"",children:"Sl No"}),s.jsx("th",{className:"",children:"Property Address"}),s.jsx("th",{className:"",children:"Description"}),s.jsx("th",{className:"",children:"GDV"}),s.jsx("th",{className:"",children:"Purchase Price"}),s.jsx("th",{className:"",children:"ROI"}),s.jsx("th",{className:"",children:"Status"}),s.jsxs("th",{className:"cursor-pointer",onClick:()=>R("created_at"),children:["Created Date",a.sortColumn==="created_at"&&s.jsx("span",{className:"ml-1",children:a.sortOrder==="asc"?"↑":"↓"})]}),s.jsx("th",{className:"",children:"Actions"})]})}),s.jsx("tbody",{children:D.length>0?D.map((e,t)=>{var r,l,d,o;return s.jsxs("tr",{className:"",children:[s.jsx("td",{className:"",children:n.from+t}),s.jsx("td",{className:"",children:s.jsx("div",{className:"line-clamp-3 max-w-[200px] overflow-hidden text-ellipsis",children:H(e)})}),s.jsx("td",{className:"",children:s.jsx("div",{className:"line-clamp-3 max-w-[200px] overflow-hidden text-ellipsis",children:e.description?e.description.replace(/<[^>]*>?/gm,""):"No description"})}),s.jsx("td",{className:"",children:(r=e.property_deal_investment)!=null&&r.gross_domestic_value?`£${parseFloat(e.property_deal_investment.gross_domestic_value).toLocaleString()}`:"0"}),s.jsx("td",{className:"",children:(l=e==null?void 0:e.property_deal_investment)!=null&&l.purchase_price?`£${parseFloat(e==null?void 0:e.property_deal_investment.purchase_price).toLocaleString()}`:"0"}),s.jsx("td",{className:"",children:(d=e==null?void 0:e.property_deal_investment)!=null&&d.return_on_cash_investment_percentage?`${parseFloat((o=e==null?void 0:e.property_deal_investment)==null?void 0:o.return_on_cash_investment_percentage).toFixed(2)}%`:"0%"}),s.jsx("td",{className:"",children:s.jsx("span",{className:"px-2 py-1 rounded-full text-xs bg-gray-500 text-white",children:"Draft"})}),s.jsx("td",{className:"",children:e.created_at?new Date(e.created_at).toLocaleDateString():"-"}),s.jsx("td",{className:"",children:s.jsxs("div",{className:"flex space-x-2",children:[s.jsx("button",{onClick:()=>z(e.id,e==null?void 0:e.step_completed),className:"text-lg",children:s.jsx(ae,{})}),s.jsx("button",{onClick:()=>G(e.id),className:"text-lg",children:s.jsx(re,{})})]})})]},e.id)}):s.jsx("tr",{children:s.jsx("td",{colSpan:"9",className:"text-center p-4",children:"No draft deals available"})})})]})}),n.total>0&&s.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center mt-6 gap-4",children:[s.jsxs("div",{className:"dark:text-white  text-[#323130] text-sm",children:["Showing ",n.from,"-",n.to," of ",n.total," ","deals"]}),s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("button",{onClick:B,className:"p-2 rounded-l-md bg-gray-700 text-white hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed",disabled:a.page<=1,children:s.jsx(le,{size:14})}),s.jsx("div",{className:"flex space-x-2",children:V().map((e,t)=>e==="..."?s.jsx("span",{className:"p-2 bg-gray-700 text-white",children:"..."},`ellipsis-${t}`):s.jsx("button",{onClick:()=>Y(e),className:`px-2 py-1 min-w-[40px] text-center ${e===n.currentPage?"bg-[#6C5DD3] text-white":"bg-gray-700 text-white hover:bg-gray-600"}`,children:e},`page-${e}`))}),s.jsx("button",{onClick:$,className:"p-2 rounded-r-md bg-gray-700 text-white hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!n.hasMorePages,children:s.jsx(ne,{size:14})})]}),s.jsx("div",{className:"flex items-center gap-2",children:s.jsxs("select",{value:a.per_page,onChange:e=>h({...a,per_page:parseInt(e.target.value),page:1}),className:"form-select",children:[s.jsx("option",{value:"10",children:"10 / 10"}),s.jsx("option",{value:"20",children:"20 / 20"}),s.jsx("option",{value:"50",children:"50 / 50"}),s.jsx("option",{value:"100",children:"100 / 100"})]})})]})]})};export{ve as default};
