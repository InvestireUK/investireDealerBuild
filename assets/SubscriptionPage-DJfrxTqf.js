import{m as e,T as ne,U as ce,w as K,bs as oe,bt as de,r as i,t as O,bu as X,z as W,bv as ue,v as xe,u as A,bw as be,bx as he,by as L,bz as fe,bA as me,bB as pe,bC as ge,bD as q,bE as je}from"./index-q3cNB_W_.js";import{u as Z}from"./useRefreshUser-D036Ne24.js";import{u as ye}from"./useFetchData-DSkiWikC.js";const Ne=ce("pk_test_51R6uLuGhmABE4SukbmgqsLITna4D57Ittag620AxGwm1ckI0oeYBXvNUBO9w4WhygDlp3sWd7ldWiZlGbR8jzxXk00N3jUSXPv"),we=({plan:d,onClose:j})=>{console.log("plan",d);const t=K(),P=oe(),o=de(),[x,y]=i.useState(!1),[b,h]=i.useState(null),{showSnackbar:v}=O(),[f,D]=i.useState(null),Y=Z(),R=async n=>{var B;n.preventDefault(),y(!0),h(null);try{if(!P||!o)throw new Error("Stripe not initialized");let k=f;if(!f){const N=o.getElement(X),{error:m,paymentMethod:_}=await P.createPaymentMethod({type:"card",card:N});if(m)throw v(m.message||"Invalid card details","error"),new Error(m.message);k=_.id}const $=await ue({plan_id:d.id,payment_method_id:k,save_payment_method:!0});v(((B=$.data)==null?void 0:B.message)||"Payment successful!","success"),await Y(),t("/success"),j()}catch(k){k.response.data.error&&v(k.response.data.error||"Payment failed!","error")}finally{y(!1)}},u=d.savedCards||[],G=u.length>0?u[u.length-1]:null;return i.useEffect(()=>{},[u]),e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"dark:bg-[#222632] bg-[#fff] p-8 rounded-xl shadow-2xl w-full max-w-md text-white subscription-checkout-popup-wrap",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsxs("h2",{className:"text-2xl font-bold text-purple",children:["Checkout: ",d.title]}),e.jsx("p",{className:"dark:text-[#ffffff] text-[#5B5B5B] mt-2",children:d.description||"Complete your subscription"})]}),u.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"Your Saved Cards"}),G.map((n,B)=>e.jsxs("div",{className:`flex items-center justify-between border p-3 rounded-md mb-2 ${f===n.id?"border-green-500 bg-green-50":""}`,children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"mr-3",children:f===n.id&&e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-green-500",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})})}),e.jsxs("span",{className:"text-[#4E515B] font-medium",children:[n.card.brand.toUpperCase()," ****",n.card.last4," (Exp:"," ",n.card.exp_month,"/",n.card.exp_year,")"]})]}),e.jsx("button",{className:`px-3 py-1 rounded ${f===n.id?"bg-green-500 text-white":"bg-blue-500 text-white hover:bg-blue-600"}`,onClick:()=>D(n.id),children:f===n.id?"Selected":"Use this card"})]},n.id))]}),e.jsxs("form",{onSubmit:R,children:[!f&&e.jsx("div",{className:"mb-6 dark:bg-[#15172b] bg-[#EBEBEC] p-3 py-4 rounded-lg",children:e.jsx(X,{options:{style:{base:{fontSize:"16px",color:"#424770","::placeholder":{color:"#aab7c4"}},invalid:{color:"#9e2146"}}}})}),b&&e.jsx("p",{className:"text-red-400 text-sm mb-4 text-center",children:b}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("button",{type:"submit",className:`flex-1 py-3 rounded-lg font-semibold text-white transition-colors duration-200 ${!P||x?"bg-gray-600 cursor-not-allowed":"bg-green-600 hover:bg-green-700"}`,disabled:!P||x,children:x?e.jsx(W,{size:20}):"Pay Now"}),e.jsx("button",{type:"button",className:`flex-1 py-3 ml-2 rounded-lg font-semibold text-white transition-colors duration-200 ${x?"bg-gray-600 cursor-not-allowed":"bg-red-600 hover:bg-red-700"}`,onClick:j,disabled:x,children:"Cancel"})]})]})]})})},Ce=({plan:d,onClose:j})=>(console.log("plan inside",d),e.jsx(ne,{stripe:Ne,children:e.jsx(we,{plan:d,onClose:j})})),Pe=()=>{const d=xe(),j=Z(),t=A(s=>{var a;return(a=s.user)==null?void 0:a.user}),P=A(s=>{var a;return(a=s.user)==null?void 0:a.role}),o=A(s=>{var a;return(a=s.plan)==null?void 0:a.plan}),[x,y]=i.useState(null),[b,h]=i.useState(null),[v,f]=i.useState(null),[D,Y]=i.useState(!1),[R,u]=i.useState(!1),[G,n]=i.useState(!1),[B,k]=i.useState(!1),[$,N]=i.useState(!1),[m,_]=i.useState(null),[z,U]=i.useState(""),[H,E]=i.useState(!1),{showSnackbar:w}=O(),J=K(),Q=o===null,{loading:I}=ye({fetchFn:me,onSuccess:s=>{d(pe({plan:s}))},shouldFetch:Q}),V=async s=>{var a,r,c;h(s.id),E(!0);try{let l=[];if(t!=null&&t.stripe_customer_id){const g=await je(t==null?void 0:t.stripe_customer_id);l=(g==null?void 0:g.data)||[]}const p={...s,savedCards:l,currentSubscriptionId:(a=t==null?void 0:t.user_subscription)==null?void 0:a.id,hasExistingSubscription:!!(t!=null&&t.user_subscription)};y(p),u(!0)}catch(l){console.error("Subscription error:",l),w(((c=(r=l.response)==null?void 0:r.data)==null?void 0:c.error)||"Error handling subscription","error")}finally{h(null),E(!1)}},ee=async()=>{if(!m){w("No plan selected for change","error");return}try{N(!1),await te(m),_(null)}catch{w("Failed to change plan","error")}},se=()=>{N(!1),_(null)},te=async s=>{var a,r,c,l,p,g,S,F;n(!0),h(s.id),E(!0);try{const C=parseFloat(((a=t==null?void 0:t.user_subscription)==null?void 0:a.price)||0),le=parseFloat(s.price||0);if(C>0){const T=await q(t.user_subscription.id,s.id);w(((r=T.data)==null?void 0:r.message)||"Plan changed successfully","success"),await j(),N(!1),_(null)}else if(C===0&&le>0)N(!1),await V(s);else{const T=await q(t.user_subscription.id,s.id);w(((c=T.data)==null?void 0:c.message)||"Plan changed successfully","success"),await j(),N(!1),_(null)}}catch(C){w(((p=(l=C.response)==null?void 0:l.data)==null?void 0:p.error)||"Failed to change plan","error"),(((g=C.response)==null?void 0:g.status)===402||(F=(S=C.response)==null?void 0:S.data)!=null&&F.payment_required)&&(N(!1),await V(s))}finally{n(!1),h(null),E(!1)}},ae=()=>{J("/cancel-subscription")},re=()=>{k(!1),U("")},ie=async()=>{var s,a,r;if(t!=null&&t.user_subscription){if(!z.trim()){w("Please provide a reason for cancellation","error");return}Y(!0),k(!1),E(!0);try{const c=await ge(t.user_subscription.id,P,{cancelReason:z});if(w(((s=c.data)==null?void 0:s.message)||"Subscription cancelled successfully","success"),await j(),f(null),o){const l=o.find(p=>parseFloat(p.price)===0);l&&(y(l),u(!1))}}catch(c){w(((r=(a=c.response)==null?void 0:a.data)==null?void 0:r.error)||"Failed to cancel subscription","error")}finally{Y(!1),E(!1),U("")}}};i.useEffect(()=>{if(!(!o||!t)){if(t!=null&&t.user_subscription){const s=o.find(a=>a.product_id===(t==null?void 0:t.user_subscription.product_id));console.log("purchasedPlan",s),s&&f(s)}else if(!x){console.log("selectedPlan",x);const s=o.find(a=>parseFloat(a.price)===0);s&&y(s)}}},[o,t]),i.useEffect(()=>{d(be())},[d]);const M=s=>{var a,r;return console.log("user?.user_subscription",t==null?void 0:t.user_subscription),console.log("user.user_subscription.product_id",(a=t.user_subscription)==null?void 0:a.product_id),console.log("planId",s),(t==null?void 0:t.user_subscription)&&((r=t.user_subscription)==null?void 0:r.product_id)===(s==null?void 0:s.product_id)};return e.jsxs("div",{className:"min-h-screen text-white",children:[e.jsx("h1",{className:"text-[30px] font-semibold mb-8 text-black border-b pb-4 dark:text-[#F8F8F8] dark:border-b-[#333333]",children:"Subscription Plans"}),I?e.jsx(W,{}):e.jsx("div",{className:"grid md:grid-cols-3 gap-8 z-10 items-stretch",children:o==null?void 0:o.map(s=>{var a,r,c,l;return e.jsxs("div",{className:`subscription-plans-container rounded-xl shadow-lg overflow-hidden transform hover:scale-105 transition-all duration-300 border-2 bg-white dark:bg-[#121212] dark:border-[#333333] ${M(s)?"border border-[#6C5DD3] !bg-[#E4E7FB] dark:!bg-[#262145] dark:border-[#8F92EA]":parseFloat(s.price)===0?"border-[#6C5DD3] bg-[#E4E7FB]":"border border-[#F4F4F4]"} relative flex justify-between flex-col h-full`,children:[M(s)&&e.jsx("div",{className:"absolute text-[#7E22CE] text-[10px] font-light bg-white rounded-xl py-1 px-2  right-[30px] top-[20px] dark:bg-[#3B0764] dark:border-[#6B21A8] dark:text-[#D8B4FE]",children:e.jsx("p",{children:"Current plan"})}),M(s)&&e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx(he,{className:"text-[#6C5DD3] text-xl"})}),e.jsxs("div",{className:"p-4",children:[e.jsxs("h2",{className:"text-xl font-bold text-black dark:text-[#F8F8F8]",children:[s.title," Package"]}),e.jsx("p",{className:"text-sm text-black mt-1",children:s.description})]}),e.jsxs("div",{className:"p-6 text-gray-300",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("span",{className:"text-3xl font-bold dark:text-[#fff] text-[#000]",children:["£",parseFloat(s.price).toFixed(2)]}),e.jsxs("span",{className:"text-sm dark:text-[#fff] text-[#000]",children:[" ","/ ",(a=s.plan_type)==null?void 0:a.interval]})]}),e.jsx("p",{className:"text-black font-medium text-lg my-3 dark:text-[#F8F8F8]",children:"What’s included:"}),e.jsxs("ul",{className:"text-sm space-y-2",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"text-[#595959] dark:text-[#ECECEC]"}),e.jsx("span",{className:"font-semibold text-[#595959] dark:text-[#ECECEC]",children:"Plan Type:"}),e.jsx("span",{className:"dark:text-[#fff] text-[#595959]",children:(r=s.plan_type)==null?void 0:r.interval})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"text-[#595959] dark:text-[#ECECEC]"}),e.jsxs("span",{className:"dark:text-[#fff] text-[#595959]",children:[(c=s.plan_type)==null?void 0:c.interval_count," ",(l=s.plan_type)==null?void 0:l.interval]})," ",e.jsx("span",{className:"dark:text-[#fff] text-[#595959]",children:"Billing Cycle"})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"text-[#595959] dark:text-[#ECECEC]"}),e.jsx("span",{className:"dark:text-[#fff] text-[#000] font-semibold",children:"Deal Limit:"}),"  ",e.jsxs("span",{className:"dark:text-[#fff] text-[#595959]",children:[s==null?void 0:s.deal_limit," ","active deals"]})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"text-[#595959] dark:text-[#ECECEC]"}),e.jsx("span",{className:"dark:text-[#fff] text-[#000] font-semibold",children:"AI Video Limit:"}),"  ",e.jsxs("span",{className:"dark:text-[#fff] text-[#595959]",children:[s==null?void 0:s.ai_video_limit," ",(s==null?void 0:s.ai_video_limit)===1?"Video":"Videos"]})]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"text-[#595959] dark:text-[#ECECEC]"}),e.jsx("span",{className:"dark:text-[#fff] text-[#000] font-semibold",children:"No.of Seats:"}),"  ",e.jsxs("span",{className:"dark:text-[#fff] text-[#595959]",children:[(s==null?void 0:s.user_limit)+1," ",(s==null?void 0:s.user_limit)===1?"Member":"Members"]})]}),e.jsxs("p",{className:"text-[#595959]",children:["(1 Deal Sourcer + ",s==null?void 0:s.user_limit," ",(s==null?void 0:s.user_limit)===1?"Team Member":"Team Members",")"]}),s.trial_period_days>0&&e.jsxs("li",{children:[e.jsx("span",{className:"font-semibold text-[#595959] dark:text-[#C5C5C5]",children:"Trial:"})," ",e.jsxs("span",{className:"dark:text-[#fff] text-[#595959]",children:[s.trial_period_days," days free"]})]})]})]}),e.jsx("div",{className:"p-4 text-center",children:M(s)?e.jsx("button",{className:`w-full py-3 rounded-lg font-semibold transition-colors duration-200
                                        ${D&&b===s.id?"bg-gray-600 cursor-not-allowed ":"bg-white border text-[#DE2424] dark:bg-[#181818] dark:border-[#DE2424]"}`,onClick:ae,disabled:D&&b===s.id,children:D&&b===s.id?e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(W,{size:20})}):"Cancel Subscription"}):e.jsx("button",{className:`w-full py-3 rounded-lg transition-colors duration-200
                                        ${b===s.id?"bg-white border cursor-not-allowed":"bg-white dark:bg-[#121212] border dark:border-[#333333] text-black dark:text-[#F8F8F8]"}`,onClick:()=>{console.log("Clicked plan:",s),console.log("Subscribed plan:",v),h(s.id);const p=(t==null?void 0:t.user_subscription)&&parseFloat(t.user_subscription.price||0)>0;if(v&&p)_(s),N(!0);else{const g={...s,savedCards:[]};y(g),u(!0)}setTimeout(()=>{h(null)},1e3)},disabled:b!==null&&b!==s.id,children:b===s.id?e.jsx("div",{className:"flex items-center justify-center",children:"Processing..."}):v?`Upgrade to ${s.title} Package`:"Subscribe Now"})})]},s.id)})}),H&&e.jsx(fe,{}),x&&R?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsx(Ce,{plan:x,onClose:()=>{h(null),y(null),u(!1)},onSuccess:()=>{h(null),y(null),u(!1),j()}})}):null,B&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"dark:bg-gray-800 bg-[#EBEBEC] p-6 rounded-lg shadow-lg max-w-md w-full",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 dark:text-white text-[#333]",children:"Confirm Cancellation"}),e.jsx("p",{className:"dark:text-gray-300 text-[#333] mb-4 text-sm",children:"Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your current billing period."}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"cancelReason",className:"block dark:text-gray-300 text-[#333] mb-2 text-sm",children:"Please tell us why you're cancelling:"}),e.jsx("textarea",{id:"cancelReason",value:z,onChange:s=>U(s.target.value),className:"w-full p-2 dark:bg-gray-700 bg-[#dddedf] rounded text-white",rows:"3",placeholder:"Your feedback helps us improve our service"})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx("button",{onClick:re,className:"gray-btn",children:"No, Keep Subscription"}),e.jsx("button",{onClick:ie,className:`red-btn transition-colors ${z.trim()?"":"opacity-50 cursor-not-allowed"}`,disabled:!z.trim(),children:"Yes, Cancel"})]})]})}),$&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"dark:bg-gray-800 bg-[#EBEBEC] p-6 rounded-lg shadow-lg max-w-md w-full",children:[e.jsx("h3",{className:"text-xl font-bold mb-4 dark:text-white text-[#333]",children:"Confirm Plan Change"}),m&&(t==null?void 0:t.user_subscription)&&(()=>{var C;const s=parseFloat(t.user_subscription.price||0),a=parseFloat(m.price||0),r=a>s,c=a<s,l=new Date(t.user_subscription.current_period_end),p=new Date(t.user_subscription.end_date).toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"}),g=1e3*60*60*24;Math.ceil((l-new Date(t.user_subscription.current_period_start))/g);let S=null,F="";return r&&(S="Pro-rated charge (today)",F=`You’re now moving to the ${t.user_subscription.title}, effective today. Your plan will be upgraded immediately, and the pro-rated amount based on the remaining days will be adjusted in your next billing cycle. You’ll continue to have access to the features included in this plan.`),c&&(S="Credit (next billing cycle)",F=`You’re now moving to the ${t.user_subscription.title}, effective ${p}. Your current plan will remain active until the end of the billing cycle. The price difference will be applied as a credit to your next payment. You’ll continue to have access to the features included in your current plan.`),e.jsxs("div",{className:"mb-6",children:[e.jsx("p",{className:"dark:text-gray-300 text-[#333] mb-4",children:"You are about to change your subscription plan:"}),e.jsxs("div",{className:"dark:bg-gray-700 bg-[#dddedf] p-4 rounded-lg mb-4",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"dark:text-gray-300 text-[#333]",children:"Current Plan:"}),e.jsx("span",{className:"dark:text-white text-[#333] font-medium",children:t.user_subscription.title})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"dark:text-gray-300 text-[#333]",children:"Current Price:"}),e.jsxs("span",{className:"dark:text-white text-[#333] font-medium",children:["£",s.toFixed(2)]})]})]}),e.jsxs("div",{className:"dark:bg-gray-700 bg-[#dddedf] p-4 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("span",{className:"dark:text-gray-300 text-[#333]",children:"New Plan:"}),e.jsx("span",{className:"dark:text-white text-[#333] font-medium",children:m.title})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"dark:text-gray-300 text-[#333]",children:"New Price:"}),e.jsxs("span",{className:"dark:text-white text-[#333] font-medium",children:["£",a.toFixed(2)," / ",(C=m.plan_type)==null?void 0:C.interval]})]})]}),(r||c)&&e.jsxs("div",{className:"mt-4 p-3 bg-[#6C5DD3] bg-opacity-20 border border-[#6C5DD3] rounded-lg",children:[e.jsx("div",{className:"flex justify-between",children:e.jsx("span",{className:"dark:text-gray-200 text-[#333]",children:S})}),e.jsx("p",{className:"dark:text-gray-300 text-[#333] text-sm mt-2",children:F})]})]})})(),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx("button",{onClick:se,className:"red-btn transition-colors",children:"Cancel"}),e.jsx("button",{onClick:ee,className:"purple-btn transition-colors",children:"Confirm Change"})]})]})})]})};export{Pe as default};
