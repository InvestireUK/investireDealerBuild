import{r as l,e as xr,m as e,b6 as It,b7 as hr,b8 as gr,w as br,v as vr,a6 as yr,u as de,t as wr,b9 as jr,ba as nt,bb as he,bc as ke,bd as _r,be as kr,bf as Nr,bg as Ar,bh as Cr,bi as Sr,bj as Er,bk as Ir}from"./index-BPP_8qLW.js";import{l as ue}from"./lodash-BO8ePN9b.js";import{C as $t}from"./index-DuJNgbCt.js";import{b as $r}from"./index-D2yoghIw.js";import{u as Vr}from"./useRefreshUser-CJ-DUsZ_.js";import{X as zr}from"./x-qlCVu3df.js";const oe="/assets/aiii-qzy6FebL.webp";function Tr({show:$,onClose:N,avatars:M,onSelect:B,VideoScenes:V,activeBlock:g,videoVariables:re}){const[te,X]=l.useState(null),[se,z]=l.useState([]),[R,K]=l.useState(!1),[H,T]=l.useState(!1),[ae,b]=l.useState(!1),[_,U]=l.useState(null),[L,O]=l.useState("all"),[W,w]=l.useState("");if(!$)return null;const S=async j=>{var k;b(!0);try{const Y=`https://api.heygen.com/v2/avatar_group/${j.id}/avatars`,P=await fetch(Y,{method:"GET",headers:{"X-Api-Key":"sk_V2_hgu_kKqknA6ytKH_2KwO3bxcX62IB12c285JDCoAIdiiuduk","Content-Type":"application/json"}});if(!P.ok)throw new Error(`HTTP ${P.status}`);const ne=await P.json();z(((k=ne.data)==null?void 0:k.avatar_list)||[]),X(j),K(!0),T(!1)}catch(Y){console.error("[AvatarModal] fetch error:",Y)}finally{b(!1)}},q=()=>{K(!1),X(null),z([]),U(null),T(!1)},F=()=>{T(!1),U(null)},ge=j=>{U(j),T(!0)};M.filter(j=>{var k,Y;return L==="all"?!0:L==="male"?((k=j.gender)==null?void 0:k.toLowerCase())==="male":L==="female"?((Y=j.gender)==null?void 0:Y.toLowerCase())==="female":!0});const J=M.filter(j=>{var k,Y,P;return L!=="all"&&(L==="male"&&((k=j.gender)==null?void 0:k.toLowerCase())!=="male"||L==="female"&&((Y=j.gender)==null?void 0:Y.toLowerCase())!=="female")?!1:W?(P=j.name)==null?void 0:P.toLowerCase().includes(W.toLowerCase()):!0}),be=J.length>0,pe=()=>{if(!_){console.warn("[AvatarModal] No avatar selected");return}if(!B){console.error("[AvatarModal] onSelect prop missing");return}if(!g){console.error("[AvatarModal] activeBlock (scene ID) missing");return}const j={avatar_id:_.avatar_id||_.id,preview_image_url:_.image_url||_.preview_image_url,..._};B(j,g),T(!1),U(null),K(!1),X(null),z([])},Xe=()=>{if(!_||!B||!Array.isArray(V)){console.warn("[AvatarModal] Invalid state for Apply to All");return}const j={avatar_id:_.avatar_id||_.id,preview_image_url:_.image_url||_.preview_image_url,..._};B(j,"ALL"),T(!1),U(null),K(!1),X(null),z([])};return xr.createPortal(e.jsxs(e.Fragment,{children:[!R&&!H&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[9999] bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-5xl relative flex flex-col max-h-[80vh] m-5 md:m-0",children:[e.jsx("button",{onClick:N,className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black z-10",children:"X"}),e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-lg font-semibold",children:"Choose an Avatar Group"})}),e.jsx("div",{className:"p-4 border-b flex flex-col gap-2",children:e.jsx("input",{type:"text",placeholder:"Search avatar name...",value:W,onChange:j=>w(j.target.value),className:"px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"})}),e.jsx("div",{className:"p-4 overflow-y-auto",children:ae?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"})}):e.jsx("div",{className:"select-ai-voice-grid-wrap",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:J.length>0?J.map(j=>e.jsxs("div",{className:"cursor-pointer flex flex-col p-2 border rounded-md hover:border-blue-500 transition-colors",onClick:()=>S(j),children:[e.jsx("img",{src:j.preview_image||oe,alt:j.name,className:"w-full h-32 object-contain rounded-md border",onError:k=>k.currentTarget.src=oe}),e.jsxs("div",{className:"flex justify-between items-center mt-2 px-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:j.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[j.num_looks," looks"]})]})]},j.id)):J.length===0||W&&!be?e.jsx("p",{className:"col-span-full text-gray-500 text-center",children:"No avatar found"}):null})})}),e.jsx("div",{className:"flex justify-start p-4 border-t",children:e.jsx("button",{onClick:N,className:"px-4 py-2 bg-gray-300 rounded hover:bg-gray-400",children:"Back"})})]})}),R&&!H&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[9999] bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-5xl relative flex flex-col max-h-[80vh] m-5 md:m-0",children:[e.jsx("button",{onClick:N,className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black z-10",children:"X"}),e.jsx("div",{className:"p-4 border-b",children:e.jsxs("h2",{className:"text-lg font-semibold",children:[(te==null?void 0:te.name)||"Avatar"," - Select a Look"]})}),e.jsx("div",{className:"p-4 overflow-y-auto",children:ae?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"})}):e.jsx("div",{className:"select-ai-voice-grid-wrap",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:se.length>0?se.map((j,k)=>e.jsxs("div",{className:"cursor-pointer flex flex-col items-center p-2 border rounded-md hover:border-purple-500 transition-colors",onClick:()=>ge(j),children:[e.jsx("img",{src:j.image_url||j.preview_image_url||oe,alt:j.avatar_name||`Avatar ${k+1}`,className:"w-full h-32 object-contain rounded-md border",onError:Y=>Y.currentTarget.src=oe}),j.avatar_name&&e.jsx("p",{className:"mt-2 text-xs font-medium truncate max-w-full",children:j.avatar_name})]},j.avatar_id||j.id||k)):e.jsx("p",{className:"col-span-full text-gray-500 text-center",children:"No looks available"})})})}),e.jsx("div",{className:"flex justify-start p-4 border-t",children:e.jsx("button",{onClick:q,className:"px-4 py-2 bg-gray-300 rounded hover:bg-gray-400",children:"Back"})})]})}),H&&_&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[9999] bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-xl relative flex flex-col m-5 md:m-0",children:[e.jsx("button",{onClick:N,className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black z-10",children:"X"}),e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-lg font-semibold",children:"Confirm Avatar"})}),e.jsxs("div",{className:"p-6 flex flex-col items-center",children:[e.jsx("div",{className:"relative w-40 h-40 rounded-full overflow-hidden border-4 border-purple-500 ring-4 ring-purple-200 mb-4",children:e.jsx("img",{src:_.image_url||_.preview_image_url||oe,alt:"Selected",className:"w-full h-full object-cover",onError:j=>j.currentTarget.src=oe})}),e.jsx("p",{className:"text-lg font-medium text-gray-900",children:_.avatar_name||_.name||"Avatar"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Ready to apply"})]}),e.jsxs("div",{className:"p-4 border-t flex gap-3",children:[e.jsx("button",{onClick:F,className:"flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300",children:"Back"}),e.jsxs("button",{onClick:pe,className:"flex-1 px-4 py-2 bg-[#6C5DD3] text-white rounded-md hover:bg-purple-700 flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),"Apply One"]}),e.jsxs("button",{onClick:Xe,className:"flex-1 px-4 py-2 bg-[#6C5DD3] text-white rounded-md flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),"Apply to All"]})]})]})}),e.jsx("style",{jsx:!0,children:`
        .loader {
          border-top-color: #3498db;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }
      `})]}),document.body)}function Dr({isModalOpen:$,setIsModalOpen:N,voices:M=[],heygenVoiceMap:B={},voiceKey:V,videoVariables:g,playingAudioId:re,handlePlayAudio:te,handleVoiceSelect:X,loading:se=!1}){const[z,R]=l.useState("all"),[K,H]=l.useState(null),[T,ae]=l.useState(!1),[b,_]=l.useState(""),L=(()=>{var ge,J,be;const w=V==null?void 0:V.match(/scene_(\d+)_script/);if(!w)return null;const q=`voice_id_${w[1]}`,F=g==null?void 0:g[q];return((ge=F==null?void 0:F.properties)==null?void 0:ge.voice_id)||((J=F==null?void 0:F.voice)==null?void 0:J.Voice_id)||((be=F==null?void 0:F.voice)==null?void 0:be.voice_id)||null})(),O=l.useMemo(()=>{if(!Array.isArray(M)||M.length===0)return[];let w=M.filter(S=>(S==null?void 0:S.voice_id)&&B[S.voice_id]);if(z==="male"&&(w=w.filter(S=>S.gender==="male")),z==="female"&&(w=w.filter(S=>S.gender==="female")),b.trim()){const S=b.toLowerCase();w=w.filter(q=>{var F;return(F=q.name)==null?void 0:F.toLowerCase().startsWith(S)})}return w},[M,z,B,b]),W=w=>!!B[w];return $?e.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0",onClick:()=>N(!1)}),e.jsxs("div",{className:"relative bg-white dark:bg-gray-900 w-full max-w-4xl max-h-[85vh] overflow-hidden rounded-lg shadow-xl flex flex-col mx-4",children:[e.jsx("button",{onClick:()=>N(!1),className:"absolute top-4 right-4 text-2xl z-10 text-gray-600 hover:text-black dark:text-gray-300",children:"X"}),e.jsx("h2",{className:"text-xl font-semibold p-6 pb-3 text-black dark:text-white",children:"ðŸŽ™ï¸ Select AI Voice"}),e.jsx("div",{className:"flex justify-center gap-4 px-6 border-b pb-4",children:["all","male","female"].map(w=>e.jsx("button",{onClick:S=>{S.stopPropagation(),R(w),H(null)},className:`px-6 py-2 rounded-lg font-medium transition ${z===w?"bg-purple-600 text-white":"bg-gray-200 dark:bg-gray-700"}`,children:w.charAt(0).toUpperCase()+w.slice(1)},w))}),e.jsx("div",{className:"px-6 pt-4",children:e.jsx("input",{type:"text",placeholder:"Search voice by alphabet...",value:b,onChange:w=>_(w.target.value),className:"w-full px-4 py-2 border rounded-lg bg-white dark:bg-gray-800 text-black dark:text-white focus:outline-none"})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:se?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx("div",{className:"w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin"})}):O.length===0?e.jsx("p",{className:"text-center text-gray-500 py-10",children:"No voices found"}):e.jsx("div",{className:"select-ai-voice-grid-wrap",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4",children:O.map(w=>{const S=W(w.voice_id),q=L===w.voice_id;return e.jsx("div",{onClick:()=>S&&H(w),className:`flex flex-col items-center justify-between p-2 rounded-lg border transition shadow-sm text-sm ${q?"bg-[#EDF4FF] text-black/[1] border-[#6C5DD3]":"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:shadow-md"}`,children:e.jsxs("div",{className:"flex items-center gap-2 w-full min-w-0",children:[e.jsx("button",{onClick:F=>{F.stopPropagation(),S&&te(w)},disabled:!S,className:`p-1 rounded-full transition text-sm ${q?"bg-white text-[#6C5DD3]":"bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-purple-600"}`,children:re===w.voice_id?e.jsx(It,{}):e.jsx($t,{})}),e.jsx("span",{className:"font-medium truncate",children:w.name})]})},w.voice_id)})})})}),K&&e.jsx("div",{className:"fixed inset-0 z-[10000] flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg w-full max-w-xl relative flex flex-col m-5 md:m-0 shadow-2xl",children:[e.jsx("button",{onClick:()=>H(null),className:"absolute top-3 right-3 text-2xl",children:"X"}),e.jsx("div",{className:"p-6 text-center",children:e.jsx("h2",{className:"text-2xl font-bold",children:K.name})}),e.jsxs("div",{className:"p-6 flex gap-4",children:[e.jsx("button",{onClick:()=>H(null),className:"flex-1 px-6 py-3 bg-gray-200 rounded-lg",children:"Cancel"}),e.jsx("button",{onClick:async()=>{await X(K,"current"),H(null),N(!1)},className:"flex-1 px-6 py-3 bg-purple-500 text-white rounded-lg",children:"Apply One"}),e.jsx("button",{onClick:async()=>{await X(K,"all"),H(null),N(!1)},className:"flex-1 px-6 py-3 bg-[#6C5DD3] text-white rounded-lg",children:"Apply All"})]})]})})]})]}):null}function Mr({show:$,onClose:N,modalTitle:M,modalMessage:B,showProgress:V}){return $?e.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50",onClick:N}),e.jsxs("div",{className:"absolute top-20 right-8 bg-white dark:bg-gray-900 w-full max-w-md rounded-2xl shadow-lg p-6 text-center z-50",children:[e.jsx("button",{onClick:N,className:"absolute top-3 right-3 text-2xl text-gray-600 hover:text-black dark:text-gray-300 dark:hover:text-white",children:"âœ•"}),e.jsxs("div",{className:"flex items-start gap-4",children:[V&&e.jsx(hr,{className:"text-black animate-spin text-3xl"}),e.jsxs("div",{className:"text-start",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 dark:text-white",children:M}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mt-1",children:B})]})]}),V&&e.jsx("div",{className:"mt-6 w-full bg-gray-200 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"h-2 bg-[#6C5DD3] rounded-full animate-progress"})})]})]}):null}function Fr({loading:$}){return $?e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm",children:e.jsxs("div",{className:"flex flex-col items-center gap-4 p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl",children:[e.jsxs("div",{className:"relative w-16 h-16",children:[e.jsx("div",{className:"absolute inset-0 border-4 border-purple-200 dark:border-purple-900 rounded-full"}),e.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-purple-600 rounded-full animate-spin"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-1",children:"Resetting..."}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Please wait while we restore the original template"})]})]})}):null}function Lr({x:$=0,y:N=0,scale:M=1,onMove:B,onScale:V}){return e.jsxs("div",{className:"w-full bg-white dark:bg-[#121212] border border-gray-200 dark:border-gray-700 p-5 rounded-xl",children:[e.jsx("h5",{className:"text-center mb-5",children:"Avatar Positioning"}),e.jsxs("div",{className:"custom-grid",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsx("span",{children:"Left"}),e.jsx("span",{className:"font-mono",children:$.toFixed(2)}),e.jsx("span",{children:"Right"})]}),e.jsx("input",{type:"range",min:"-1",max:"1",step:"0.01",value:$,onChange:g=>B({x:parseFloat(g.target.value),y:N}),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsx("span",{children:"Top"}),e.jsx("span",{className:"font-mono",children:N.toFixed(2)}),e.jsx("span",{children:"Bottom"})]}),e.jsx("input",{type:"range",min:"-1",max:"1",step:"0.01",value:N,onChange:g=>B({x:$,y:parseFloat(g.target.value)}),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsx("span",{children:"Zoom In"}),e.jsxs("span",{className:"font-mono",children:[M.toFixed(2),"x"]}),e.jsx("span",{children:"Zoom Out"})]}),e.jsx("input",{type:"range",min:"0.3",max:"2",step:"0.01",value:M,onChange:g=>V(parseFloat(g.target.value)),className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600"})]})]})]})}function Pr({sceneId:$,elStyle:N,classes:M,videoVariables:B,setVideoVariables:V,dispatch:g,isThumbnail:re}){var b;const te=l.useRef(null),[X,se]=l.useState({}),z=/^cc_bgimg\d+_cc__FI__Z_0$/.test($),R="https://investier.visionvivante.in/storage/deal_images/GJO5G81JE5jkAtseXrJjUyphnBjEc3QvTOj2bwVO.jpg?text="+encodeURIComponent($),K=((b=B[$])==null?void 0:b.properties)||{},T=$.toLowerCase().includes("logo")?X[$]||K.url||K.content||K.image||R:X[$]||K.content||K.url||K.image||R,ae=async(_,U,L)=>{var O;try{await AiDataSend({template_id:templateId,user_id:(O=user.user)==null?void 0:O.id,deal_id:deal.id,variables:{...U,[_]:{...U[_],properties:{...U[_].properties,url:L}}}})}catch(W){console.error("Error saving image",W)}};return e.jsxs("div",{className:"sceneblock",style:{padding:N==null?void 0:N.padding,zIndex:N==null?void 0:N.zIndex},children:[e.jsx("div",{className:`image ${M!=null&&M.includes("circle-frame")?"circle-frame":""}`,onClick:()=>{var _;!re&&!z&&((_=te.current)==null||_.click())},style:{cursor:re?"default":"pointer"},children:e.jsx("img",{alt:$,src:T,className:M!=null&&M.includes("circle-frame")?"circle-frame":""})}),!re&&!z&&e.jsx("input",{type:"file",accept:"image/*",ref:te,style:{display:"none"},onChange:async _=>{const U=_.target.files[0];if(!U)return;const L=new FormData;L.append("image",U);let O;try{O=await gr(L)}catch(w){console.log(w)}const W=new FileReader;W.onload=w=>{w.target.result;const S=ue.cloneDeep(B);S[$]||(S[$]={properties:{}});const q={...S[$].properties};delete q.content,S[$].properties={...q,url:O.data.url},V(S),g(SaveAiVideoData(S)),se(F=>({...F,[$]:O.data.url})),setBaseToUrl(O.data.url),ae($,S,O.data.url)},W.readAsDataURL(U)}})]},$)}function Zr(){var Nt;const $=br(),N=vr(),M=yr(),B=Vr(),{templateId:V}=M.state,g=de(t=>t.deal.VideoScenes||[]),re=de(t=>t.deal.AiAvatars||[]),te=de(t=>t.deal.AiAvatarGroups||[]),X=de(t=>t.deal.VideoVariables),se=de(t=>t.deal.VideoValidations),z=de(t=>t.deal.deal),{user:R}=de(t=>t),K=Object.entries(X).filter(([t,r])=>(r==null?void 0:r.type)==="character").map(([t,r])=>({id:t,...r})),{showSnackbar:H}=wr(),[T,ae]=l.useState([]),[b,_]=l.useState(X),[U,L]=l.useState(!1),[O,W]=l.useState(null),[w,S]=l.useState(!1),[q,F]=l.useState(!1),[ge,J]=l.useState(""),[be,pe]=l.useState(""),[Xe,j]=l.useState(!1),[k,Y]=l.useState([]),[P,ne]=l.useState(0),[it,Te]=l.useState({}),[ot,De]=l.useState(!1),[Vt,Ne]=l.useState(null),[He,qe]=l.useState(0),zt=150,Ae=5,Ce=de(t=>t.deal.AiVoices||[]),[lt,Se]=l.useState({}),[Je,Ee]=l.useState(null),[Tt,Me]=l.useState(!1),[ct,Ie]=l.useState({}),[ve,fe]=l.useState(null),[G,ye]=l.useState(null),[Fe,Le]=l.useState([]),[Pe,dt]=l.useState(!1),[Rr,Dt]=l.useState(),[Or,Mt]=l.useState({}),ut=l.useRef({}),[$e,Br]=l.useState(()=>{const t={};return g.forEach(r=>{t[r.id]={x:0,y:0,scale:1}}),t}),[pt]=l.useState(()=>{const t={};return g.forEach(r=>{const s=r.variables.find(n=>n.type==="character");if(s){const n=s.name.match(/__P_(\d+)_(\d+)_(\d+)_(\d+)/);if(n){const[i,u,a,o,p]=n.map(Number),y=(u+o)/2,d=(a+p)/2,c=(y-6.5)/6.5,f=(d-3.5)/3.5;t[r.id]={x:Math.max(-1,Math.min(1,c)),y:Math.max(-1,Math.min(1,f))}}else t[r.id]={x:0,y:0}}else t[r.id]={x:0,y:0}}),t}),[Ye,Ft]=l.useState(()=>{const t={};return g.forEach(r=>{t[r.id]={x:0,y:0,scale:1}}),t}),ft=(t,r)=>{var y;const s=pt[t]||{x:0,y:0};let i={...Ye[t]||{x:0,y:0,scale:1}};r.x!==void 0&&(i.x=r.x-s.x),r.y!==void 0&&(i.y=r.y-s.y),r.scale!==void 0&&(i.scale=r.scale),Ft(d=>({...d,[t]:i}));const u=g.find(d=>d.id===t),a=u==null?void 0:u.variables.find(d=>d.type==="character");if(!a){console.warn("No character variable found for scene:",t);return}const o=a.name,p=ue.cloneDeep(b);p[o]||(p[o]={name:o,type:"character",properties:{}}),p[o].properties={...p[o].properties,offset:{x:i.x,y:i.y},scale:i.scale},_(p),N(he(p)),ke({template_id:V,user_id:(y=R.user)==null?void 0:y.id,deal_id:z.id,variables:p}).catch(console.error)},we=(Nt=k[P])==null?void 0:Nt.id;$e[we];const Lt=t=>{ut.current[t]=it[t]||Be(t)},Pt=t=>{S(!0),Me(!0),W(t),setTimeout(()=>{S(!1)},1e3)},Rt=l.useCallback(async(t,r="current")=>{if(t!=null&&t.voice_id){if(_(s=>{const n=ue.cloneDeep(s);if(r==="current"&&O){const i=O.match(/scene_(\d+)_script/);if(i){const a=`voice_id_${i[1]}`;n[a]||(n[a]={name:a,type:"voice",properties:{}}),n[a].properties.voice_id=t.voice_id}}return r==="all"&&k.forEach((i,u)=>{const a=`voice_id_${u+1}`;n[a]||(n[a]={name:a,type:"voice",properties:{}}),n[a].properties.voice_id=t.voice_id}),n}),r==="current"&&O&&Se(s=>({...s,[O]:t})),r==="all"){const s={};k.forEach((n,i)=>{const u=`scene_${i+1}_script`;s[u]=t}),Se(s)}Me(!1),W(null)}},[O,k,_,Se,Me,W]),Ot=["PUBLIC_PHOTO","PUBLIC","COMMUNITY_PHOTO"],Bt=te.filter(t=>{var r;return Ot.includes((r=t.group_type)==null?void 0:r.trim().toUpperCase())}),Kt=async(t,r)=>{try{let s=[];return{cleanedVariables:Object.fromEntries(Object.entries(r).filter(([i,u])=>{const a=(u==null?void 0:u.properties)||{},o=typeof a.content=="string"&&a.content.trim()!=="",p=a.url||a.image,y=a.character_id!==void 0&&a.character_id!==null&&String(a.character_id).trim()!=="",d=a.voice_id&&String(a.voice_id).trim()!=="",c=a.offset&&typeof a.offset.x=="number"&&typeof a.offset.y=="number",f=typeof a.scale=="number",x=o||p||y||d||c||f;return x||s.push(i),x})),emptyKeys:s}}catch(s){return console.error("API error:",s),{cleanedVariables:{},emptyKeys:[]}}},Wt=async(t,r,s)=>{var n;try{await ke({template_id:V,user_id:(n=R.user)==null?void 0:n.id,deal_id:z.id,variables:{...s,[t]:{...s[t],properties:{...s[t].properties,content:r}}}})}catch(i){console.error("Error saving to API",i)}};l.useEffect(()=>{ve||ye(null)},[ve]);const Ze=(t="")=>t.trim()===""?0:t.trim().split(/\s+/).length,Gt=t=>{const r={...t},s=Object.keys(r).filter(n=>{var i;return((i=r[n])==null?void 0:i.type)==="character"});return s.forEach((n,i)=>{var o,p;const u=Qe[i];if(!u)return;const a=i===s.length-1;r[n]={...r[n],properties:{...r[n].properties,offset:((o=r[n].properties)==null?void 0:o.offset)??u.offset,scale:((p=r[n].properties)==null?void 0:p.scale)??u.scale,...a?{avatar_style:"circle"}:{}}}}),r},Qe=[{offset:{x:-.3,y:.14},scale:.7},{offset:{x:0,y:.14},scale:.7},{offset:{x:.3,y:.25},scale:.5},{offset:{x:-.38,y:-.25},scale:.5},{offset:{x:0,y:-.25},scale:.5},{offset:{x:.35,y:-.31},scale:.35},{offset:{x:.45,y:-.2},scale:.8}],Ut=async()=>{var t,r;try{if(Object.values(Re).some(c=>c)){pe("Word limit exceeded"),J("Please reduce words before generating the video."),L(!0);return}const{cleanedVariables:n,emptyKeys:i}=await Kt(V,b),u=Gt(n);if(i.length>0){pe("Missing Fields"),J(`Some fields are still missing:${i}`),j(!1),L(!0);return}if(!n||Object.keys(n).length===0){pe("No Variables"),J("All fields are empty. Please fill them before generating."),j(!1),L(!0);return}pe("Generatingâ€¦"),J(""),j(!0),L(!0);const a=await fetch(`https://api.heygen.com/v2/template/${V}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":"sk_V2_hgu_kKqknA6ytKH_2KwO3bxcX62IB12c285JDCoAIdiiuduk"},body:JSON.stringify({test:!0,variables:u,dimension:{width:1280,height:720}})});if(!a.ok)throw new Error("Failed to generate video");const o=await a.json(),p=await _r({user_id:(t=R.user)==null?void 0:t.id}),y=await kr({deal:z.id,ai_video_id:(r=o==null?void 0:o.data)==null?void 0:r.video_id}),d=await B();if(y!=null&&y.status)sessionStorage.setItem(`video_generated_${z.id}`,"true"),$(`/deals/deal-view/${z.id}`);else throw new Error("Failed to save generated video")}catch(s){console.error("Error during video generation:",s),j(!1),pe("Error"),J("There is some error please contact admin or try again in some time"),L(!0)}};l.useEffect(()=>{g&&g.length>0&&Y(g)},[g]);const Xt=async()=>{var t,r,s,n,i;if(V){F(!0);try{const u={template_id:V,user_id:(t=R.user)==null?void 0:t.id,deal_id:z.id};await Nr(u,V);const a=await Ar({template_id:V,user_id:(r=R.user)==null?void 0:r.id,deal_id:z.id});let o=((s=a==null?void 0:a.data)==null?void 0:s.variables)??((i=(n=a==null?void 0:a.data)==null?void 0:n.data)==null?void 0:i.variables)??(a==null?void 0:a.variables)??{};N(he(o)),_(o);const p={};Object.entries(o).forEach(([d,c])=>{var f;((f=c==null?void 0:c.properties)==null?void 0:f.content)!==void 0&&(p[d]=c.properties.content)}),Te(p);const y=g.map(d=>({id:d.id,scripts:d.variables.filter(c=>c.type==="text"&&c.name.endsWith("_script")).map(c=>{var x,A;const f=((A=(x=o[c.name])==null?void 0:x.properties)==null?void 0:A.content)||"";return{name:c.name,value:f}})}));Le(y),Mt({}),Dt(null),Se({}),mt({}),W(null),Ee(null),Ie({}),fe(null),ae([]),ye(null),Object.keys(le.current).forEach(d=>{le.current[d]&&clearTimeout(le.current[d])}),le.current={},Ht.current={},setTimeout(()=>{Object.keys(o).forEach(d=>{var f,x;const c=document.getElementById(d);if(c&&c.contentEditable==="true"){const A=((x=(f=o[d])==null?void 0:f.properties)==null?void 0:x.content)||Be(d);c.textContent!==A&&(c.textContent=A)}})},100)}catch(u){console.error("Reset failed silently:",u)}finally{F(!1)}}};l.useEffect(()=>{const t={};Object.entries(b).forEach(([r,s])=>{var n;((n=s==null?void 0:s.properties)==null?void 0:n.content)!==void 0&&(t[r]=s.properties.content)}),Te(t)},[b]),l.useEffect(()=>{console.log("videoVariables state updated (local):",b),console.log("Redux VideoVariables (from selector):",X)},[b,X]),l.useEffect(()=>{if(g&&g.length>0){const t=g.map(r=>{const s=r.variables.filter(n=>n.type==="text"&&n.name.endsWith("_script")).map(n=>{var i,u;return{name:n.name,value:((u=(i=b[n.name])==null?void 0:i.properties)==null?void 0:u.content)||""}});return{id:r.id,scripts:s}});Le(t)}},[g]);const Ht=l.useRef({}),le=l.useRef({}),[Re,mt]=l.useState({}),Oe=40,et=l.useRef(new Map),qt=(t,r,s)=>{const i=Ze(s)>Oe;if(Le(u=>u.map(a=>a.id===t?{...a,scripts:a.scripts.map(o=>o.name===r?{...o,value:s}:o)}:a)),mt(u=>({...u,[r]:i?`Maximum ${Oe} words allowed`:""})),i){le.current[r]&&clearTimeout(le.current[r]);return}et.current.set(r,s),le.current[r]&&clearTimeout(le.current[r]),le.current[r]=setTimeout(()=>{var o;const u=et.current.get(r)||s,a=ue.cloneDeep(b);a[r]||(a[r]={name:r,type:"text",properties:{}}),a[r].properties.content=u,_(a),N(he(a)),ke({template_id:V,user_id:(o=R.user)==null?void 0:o.id,deal_id:z.id,variables:a}).catch(console.error)},800)};l.useEffect(()=>()=>{et.current.clear()},[]),l.useEffect(()=>{if(b&&Object.keys(b).length>0){const t={};Object.entries(b).forEach(([r,s])=>{var n;(n=s==null?void 0:s.properties)!=null&&n.content&&(t[r]=s.properties.content)}),Object.keys(t).length>0&&Te(r=>({...t,...r}))}},[b]);function Jt(t){const r=t.name,{name:s,type:n}=t||{};if(!s||!n||!s.includes("__")||s.endsWith("_script"))return null;const i=s.split("__").filter(Boolean),u=i[0],a=i.slice(1);let o=null,p=null,y=null,d={},c=[];const f=[];let x=null,A=!1,E=!1,I=!1;for(const m of a)if(m==="FI")o="1 / -1",p="1 / -1",y="FI";else if(m.startsWith("P_")){const h=m==null?void 0:m.split("_");if(h.length===5){const C=+h[1],v=+h[2],D=+h[3],Z=+h[4];[C,v,D,Z].every(Number.isFinite)&&(o=`${C} / ${D+1}`,p=`${v} / ${Z+1}`,y=`${C}-${v}-${D}-${Z}`)}}else if(m.startsWith("BG_")){const h=m.replace("BG_","").trim();/^[0-9a-fA-F]{6}$/.test(h)&&(d.background=`#${h}`)}else if(m.startsWith("JL"))d.justifyContent="left";else if(m.startsWith("JR"))d.justifyContent="right";else if(m.startsWith("JC"))d.justifyContent="center";else if(m.startsWith("FR_C"))c.push("circle-frame");else if(m.startsWith("PD_")){const h=m==null?void 0:m.split("_");if(h.length===5){const C=+h[1],v=+h[2],D=+h[3],Z=+h[4];[C,v,D,Z].every(Number.isFinite)&&(d.padding=`${C}px ${Z}px ${D}px ${v}px`)}}else if(m.startsWith("Z_")){const h=+(m==null?void 0:m.split("_")[1]);Number.isFinite(h)&&(d.zIndex=h)}else if(m.startsWith("AL_")||m.startsWith("BL_")){const h=m==null?void 0:m.split("_");if(h.length===5){const C=+h[1],v=+h[2],D=+h[3],Z=+h[4];[C,v,D,Z].every(Number.isFinite)&&f.push({kind:m.startsWith("AL_")?"AL":"BL",sc:C,sr:v,ec:D,er:Z,gridCol:`${C} / ${D+1}`,gridRow:`${v} / ${Z+1}`,raw:m})}}else if(m.startsWith("F_")){const h=m==null?void 0:m.split("_");if(h.length>=2){const C=+h[1];Number.isFinite(C)&&(x=C);const v=h[2]||"";A=v.includes("B"),E=v.includes("I"),I=v.includes("U")}}return!o&&f.length===0?null:{id:u,type:n,gridCol:o,gridRow:p,key:y,elStyle:d,classes:c,lines:f,sceneId:r,fontSize:x,bold:A,italic:E,underline:I}}function Yt(t){const r=(t||"").toLowerCase();return r.startsWith("header")?"header":r.startsWith("subtitle")?"subtitle":r.startsWith("title")?"title":r.startsWith("callout")?"callout":""}function Be(t){if(!t)return"Enter text...";let r=t;return r.includes("__")&&(r=r.split("__")[0]),r=r.replace(/_P_\d+_\d+_\d+_\d+.*$/,""),r=r.replace(/_FI.*$/,""),r=r.replace(/_BG_[a-fA-F0-9]+.*$/,""),r=r.replace(/_FR_C.*$/,""),r=r.replace(/_PD_\d+_\d+_\d+_\d+.*$/,""),r=r.replace(/_Z_\d+.*$/,""),r=r.replace(/_AL_\d+_\d+_\d+_\d+.*$/,""),r=r.replace(/_BL_\d+_\d+_\d+_\d+.*$/,""),r||t}const Ke=new Map,Ve=new Map,Zt=async(t,r)=>{if(Ke.has(t))return Ke.get(t);if(Ve.has(t))return Ve.get(t);r(s=>({...s,[t]:!0}));try{const s=fetch(`https://api.heygen.com/v2/avatar/${t}/details`,{method:"GET",headers:{"X-API-KEY":"sk_V2_hgu_kKqknA6ytKH_2KwO3bxcX62IB12c285JDCoAIdiiuduk","Content-Type":"application/json"}}).then(i=>{if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);return i.json()});Ve.set(t,s);const n=await s;return Ke.set(t,n),Ve.delete(t),n}catch(s){return console.error("Error fetching avatar details:",s),Ve.delete(t),null}finally{r(s=>({...s,[t]:!1}))}},[We,Qt]=l.useState({}),[Kr,er]=l.useState({}),tt=l.useRef(new Set),rt=l.useRef(!0);l.useEffect(()=>()=>{rt.current=!1},[]);const xt=l.useMemo(()=>{const t=new Set;return g.forEach(r=>{var n,i;const s=r.variables.find(u=>u.type==="character");if(s){const u=(i=(n=b[s.name])==null?void 0:n.properties)==null?void 0:i.character_id;u&&t.add(u)}}),Array.from(t)},[g,b]);l.useEffect(()=>{xt.forEach(t=>{!Ke.has(t)&&!We[t]&&!tt.current.has(t)&&(tt.current.add(t),Zt(t,er).then(r=>{rt.current&&r&&Qt(s=>({...s,[t]:r}))}).catch(r=>{rt.current&&(console.error("Failed to fetch avatar details:",r),tt.current.delete(t))}))})},[xt]);function tr(t,r=!1){var D,Z,At,Ct,St,Et;const{id:s,type:n,elStyle:i={},classes:u=[],sceneId:a,fontSize:o,bold:p,italic:y,underline:d}=t;if(n==="image")return i.background?e.jsx("div",{className:"sceneblock",style:{padding:i.padding,zIndex:i.zIndex},children:e.jsx("div",{className:"image",style:{background:i.background}})},s):e.jsx(Pr,{sceneId:a,elStyle:i,classes:u,videoVariables:b,setVideoVariables:_,dispatch:N,templateId:V,user:R,deal:z},s);if(n==="character"){const Q=g.find(xe=>xe.variables.some(Ue=>Ue.name===a));if(!Q)return console.warn("Could not find scene for avatar:",a),null;const je=Q.id,ee=Q.variables.find(xe=>xe.type==="character"),Ge=(ee==null?void 0:ee.name)||a,me=(Z=(D=b[Ge])==null?void 0:D.properties)==null?void 0:Z.character_id,_e=(Ct=(At=b[Ge])==null?void 0:At.properties)==null?void 0:Ct.image,ie=Ye[je]||{x:0,y:0,scale:1},ce=re.find(xe=>xe.avatar_id===me)||re.find(xe=>{const Ue=K.find(mr=>mr.id===a);return Ue&&xe.avatar_id===Ue.properties.character_id}),fr=_e||((Et=(St=We[me])==null?void 0:St.data)==null?void 0:Et.preview_image_url)||(ce==null?void 0:ce.preview_image_url)||"/aiii.webp";return e.jsx("div",{className:"sceneblock relative overflow-visible",children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{transform:`translate(${ie.x*50}%, ${ie.y*50}%) scale(${ie.scale})`,transformOrigin:"center center",transition:"transform 0.2s ease-out"},children:e.jsx("img",{src:fr,alt:s,className:"w-full h-full object-cover cursor-pointer",style:{cursor:r?"default":"pointer"},onClick:()=>{r||(Ne(je),De(!0))}})})})}const[c,f]=l.useState({}),x=(Q="")=>Q.trim().split(/\s+/).filter(Boolean).length,A=Q=>Q&&Q.split("__")[0],E=Q=>{const je=Q.currentTarget,ee=je.id,Ge=A(ee),me=je.textContent.trim(),_e=Number(se==null?void 0:se[Ge]);if(_e>0&&x(me)>_e){H(`Maximum ${_e} word${_e>1?"s":""} allowed`,"error"),je.textContent=ut.current[ee]||Be(ee);return}const ie=ue.cloneDeep(b);ie[ee]||(ie[ee]={properties:{}}),ie[ee].properties.content=me,_(ie),N(he(ie)),Te(ce=>({...ce,[ee]:me})),Wt(ee,me,ie),f(ce=>({...ce,[ee]:!0}))},I=["cc_title","cc_hero_cc","cc_img","cc_ds_name_cc","cc_phone_cc","cc_email_cc"],m=/^cc_plh\d+_cc/.test(a),h=!r&&(m||I.some(Q=>a.startsWith(Q))||!a.startsWith("cc_")),C=r&&o?o*.5:o,v={...i,fontSize:C?`${C}px`:void 0,fontWeight:p?700:400,fontStyle:y?"italic":"normal",textDecoration:d?"underline":"none"};return e.jsx("div",{contentEditable:h,suppressContentEditableWarning:!0,id:a,className:`text ${Yt(a)}`,style:v,onFocus:()=>Lt(a),onBlur:E,children:it[a]||Be(a)},a)}function ht(t){const r=t.match(/__VP_(\d+)$/);return r?parseInt(r[1],10):1/0}function gt({scene:t,index:r,isThumbnail:s=!1}){const n=l.useMemo(()=>(t.variables||[]).map(Jt).filter(Boolean),[t]),i=l.useMemo(()=>{const u=new Map;for(const a of n)a.key&&(u.has(a.key)||u.set(a.key,[]),u.get(a.key).push(a));for(const[a,o]of u.entries())o.sort((p,y)=>{const d=ht(p.sceneId),c=ht(y.sceneId);return d-c});return u},[n]);return e.jsxs("div",{className:"scene-root",children:[!s&&e.jsxs("div",{className:"scene-badge",children:["Scene ",r+1]}),e.jsxs("div",{className:"grid",children:[[...i.entries()].map(([u,a])=>e.jsx("div",{className:"area-wrapper",style:{gridColumn:a[0].gridCol,gridRow:a[0].gridRow},children:a.map(o=>tr(o,!1))},u)),n.flatMap(u=>(u.lines||[]).map((a,o)=>{const p=a.sc===a.ec,y=a.sr===a.er,d={gridColumn:a.gridCol,gridRow:a.gridRow,display:"flex",width:"100%",height:"100%",boxSizing:"border-box",pointerEvents:"none",zIndex:30};return p?e.jsx("div",{className:"line-wrapper",style:{...d,justifyContent:a.kind==="BL"?"flex-start":"flex-end",alignItems:"stretch"},children:e.jsx("div",{style:{width:2,height:"100%",background:a.kind==="AL"?"#0b1220":"#6b7280",opacity:a.kind==="AL"?1:.9}})},`${a.raw}-${o}`):y?e.jsx("div",{className:"line-wrapper",style:{...d,alignItems:a.kind==="BL"?"flex-start":"flex-end",justifyContent:"stretch"},children:e.jsx("div",{style:{height:3,width:"100%",background:a.kind==="AL"?"#0b1220":"transparent",borderTop:a.kind==="BL"?"2px dashed #6b7280":void 0}})},`${a.raw}-${o}`):e.jsx("div",{className:"line-wrapper",style:{...d,alignItems:"center",justifyContent:"center"},children:e.jsx("div",{style:{height:2,width:"100%",background:"#0b1220"}})},`${a.raw}-${o}`)}))]})]})}l.useEffect(()=>{const t=r=>{const s=document.activeElement,n=["TEXTAREA","INPUT"],i=s==null?void 0:s.isContentEditable,u=s==null?void 0:s.closest('[contenteditable="true"]');r.shiftKey||n.includes(s==null?void 0:s.tagName)||i||u||k.length&&(r.key==="ArrowLeft"&&(r.preventDefault(),ne(a=>(a-1+k.length)%k.length)),r.key==="ArrowRight"&&(r.preventDefault(),ne(a=>(a+1)%k.length)))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[k.length]),l.useEffect(()=>{if(k.length===0)return;const t=k[P];if(!t)return;const r=document.querySelector(`div[data-scene-id="${t.id}"]`);r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),r.style.transition="background 0.4s",r.style.background="rgba(108, 93, 211, 0.12)",setTimeout(()=>{r.style.background=""},800))},[P,k]);const[rr,ar]=l.useState([]),[sr,nr]=l.useState({}),[ir,bt]=l.useState(!0);l.useEffect(()=>{(async()=>{var r,s;try{bt(!0);const n=await Cr(),u=(((r=n==null?void 0:n.data)==null?void 0:r.data)||[]).filter(d=>d.active===1||d.active==="1").map(d=>({voice_id:d.Voice_id,name:d.Voice_name,gender:d.Female?"female":"male",preview_available:d.Preview_Available===!0,preview_url:null,source:"custom"})),o=await(await fetch("https://api.heygen.com/v2/voices",{headers:{"Content-Type":"application/json","X-API-KEY":"sk_V2_hgu_kKqknA6ytKH_2KwO3bxcX62IB12c285JDCoAIdiiuduk"}})).json(),p={};(((s=o==null?void 0:o.data)==null?void 0:s.voices)||[]).forEach(d=>{p[d.voice_id]={preview_audio:d.preview_audio,gender:d.gender,name:d.name}}),nr(p);const y=u.map(d=>d.preview_available&&p[d.voice_id]?{...d,preview_url:p[d.voice_id].preview_audio}:d);ar(y),N(Sr(y))}catch(n){console.error("Voice load error:",n)}finally{bt(!1)}})()},[N]);const ze=l.useRef(null),vt=async t=>{var s;if(!(t!=null&&t.preview_url))return;if(Je===t.voice_id){(s=ze.current)==null||s.pause(),Ee(null);return}ze.current&&(ze.current.pause(),ze.current.currentTime=0);const r=new Audio(t.preview_url);ze.current=r,Ee(t.voice_id);try{await r.play()}catch(n){console.warn("Audio play interrupted:",n),Ee(null)}r.onended=()=>{Ee(null)}};l.useEffect(()=>{const t={};Fe.forEach(r=>{r.scripts.forEach(s=>{const n=`${r.id}-${s.name}`;!lt[n]&&Ce.length>0&&(t[n]=Ce[0])})}),Object.keys(t).length>0&&Se(r=>({...r,...t}))},[Fe,Ce]);const or=(t,r)=>{Ie(s=>({...s,[t]:!s[t]})),W(r),fe(null)},yt=t=>{fe(r=>r===t?null:t),Ie({})},at=l.useRef(null),wt=l.useRef({});l.useEffect(()=>{function t(r){const s=document.querySelectorAll("[data-avatar-button]"),n=Array.from(s).some(p=>p.contains(r.target)),i=document.querySelectorAll("[data-voice-button]"),u=Array.from(i).some(p=>p.contains(r.target));n||u||at.current&&at.current.contains(r.target)||Object.values(wt.current).some(p=>p&&p.contains(r.target))||r.target.closest(".right, .slider, .thumbnail-slider")||(Ie({}),fe(null))}return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[]);const lr=async(t,r=null)=>{var u,a,o,p,y,d;const s=r||ve;if(!s){console.error("No scene to update");return}const n=g.find(c=>c.id===s),i=n==null?void 0:n.variables.find(c=>c.type==="character");if(i){const c=[];g.forEach(I=>{var h;const m=((h=I==null?void 0:I.variables)==null?void 0:h.filter(C=>C.type==="character"))||[];c.push(...m)});const f=c.findIndex(I=>I.name===i.name);let x=Qe[f];x||(x={offset:{x:0,y:0},scale:1});const A=f===c.length-1,E=ue.cloneDeep(b);E[i.name]={...E[i.name],properties:{...(u=E[i.name])==null?void 0:u.properties,character_id:t.avatar_id||t.id,image:t.image_url||t.preview_image_url,offset:((o=(a=E[i.name])==null?void 0:a.properties)==null?void 0:o.offset)??x.offset,scale:((y=(p=E[i.name])==null?void 0:p.properties)==null?void 0:y.scale)??x.scale,...A?{avatar_style:"circle"}:{}}},_(E),N(he(E));try{await ke({template_id:V,user_id:(d=R.user)==null?void 0:d.id,deal_id:z.id,variables:E})}catch(I){console.error("Error saving avatar",I)}}},cr=t=>{if(!(t>=He&&t<He+Ae)){const s=Math.max(0,t-Math.floor(Ae/2)),n=Math.max(0,k.length-Ae),i=Math.min(s,n);qe(i)}};l.useEffect(()=>{cr(P)},[P,Ae,k.length]),l.useEffect(()=>{console.log("videoVariables updated",b)},[b]);const dr=async t=>{try{const s=await(await fetch("https://api.heygen.com/v2/avatar_group.list?include_public=true",{method:"GET",headers:{"Content-Type":"application/json","X-API-KEY":"sk_V2_hgu_kKqknA6ytKH_2KwO3bxcX62IB12c285JDCoAIdiiuduk"}})).json();N(Er(s.data.avatar_group_list))}catch(r){console.error("API error:",r)}finally{}};l.useEffect(()=>{dr()},[]);const[Wr,jt]=l.useState(!1),[Gr,_t]=l.useState(null),ur=async t=>{var r;try{jt(!0),_t(null);const s=await fetch(`https://api.heygen.com/v2/avatar_group/${t}/avatars`,{method:"GET",headers:{"X-Api-Key":"sk_V2_hgu_kKqknA6ytKH_2KwO3bxcX62IB12c285JDCoAIdiiuduk"}});if(!s.ok)throw new Error(`API call failed: ${s.status}`);const i=((r=(await s.json()).data)==null?void 0:r.avatar_list)||[];ae(i)}catch(s){console.error("Error fetching avatar group:",s),_t(s.message)}finally{jt(!1)}},kt=async()=>{var t,r;try{S(!0);const s={userId:(t=R.user)==null?void 0:t.id,dealId:z.id},i=(r=(await Ir(s)).data)==null?void 0:r.data;if(!i)return;Le(u=>u.map(a=>{const o=a.scripts.map(p=>({...p,value:i[p.name]||p.value}));return{...a,scripts:o}}))}catch(s){console.error("Error fetching scripts:",s)}finally{S(!1)}},[st,pr]=l.useState([]);return l.useEffect(()=>{if(ve){const t=["PUBLIC_PHOTO","PUBLIC","COMMUNITY_PHOTO"],s=te.filter(n=>{var i;return t.includes((i=n.group_type)==null?void 0:i.trim().toUpperCase())}).sort(()=>Math.random()-.5).slice(0,4);pr(s)}},[ve,te]),l.useEffect(()=>{console.log("avatarTransforms state changed:",$e)},[$e]),l.useEffect(()=>{var t;console.log("currentIndex changed to:",P),console.log("Active scene:",k[P]),console.log("Active transform:",$e[(t=k[P])==null?void 0:t.id])},[P,k,$e]),e.jsxs(e.Fragment,{children:[e.jsx(Fr,{loading:q}),e.jsxs("div",{className:"flex items-center justify-between bg-white dark:bg-[#121212] text-white px-4 py-3 shadow-md rounded-lg mb-1 container mx-auto hide-in-landscape",children:[e.jsxs("button",{onClick:()=>$("/deal-view-ai-video-generator"),className:"flex items-center gap-2 text-lg font-semibold text-black dark:text-white  transition",children:[e.jsx($r,{className:"text-xl"}),e.jsx("span",{children:"Back"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-around gap-3 md:gap-8 relative",children:[e.jsx(jr,{}),e.jsx("button",{className:"bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition",onClick:Xt,children:"Reset"}),e.jsx("button",{className:"bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition",onClick:Ut,children:"Generate"}),e.jsx(Mr,{show:U,onClose:()=>L(!1),modalTitle:be,modalMessage:ge,showProgress:Xe})]})]}),e.jsxs("div",{className:"app-root",children:[e.jsx("style",{children:`
            :root{
          --slide-radius: 18px;
          --gap: 10px;
          --card-bg: #ffffff;
          --app-bg: #0f1220;
          --shadow: 0 10px 30px rgba(0,0,0,.35);
          --text-soft:#6b7280;
          --text-strong:#111827;
        }
        .app-root{ min-height:60vh;  align-items:center; justify-content:center; padding:24px; box-sizing:border-box; background: #FDFDFD; }
       
        .dark .app-root{
        background:#121212
        }
          font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
          color:var(--text-strong);
        }
           .app-root {
          var(--app-bg);
          font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
          color:var(--text-strong);
          }
        .layout{ width:100%; max-width:1200px; display:flex; background-color:#FDFDFD }
        textarea{ width: 100%; }
        // .left{ color:#fff; width: 100%; min-width: 400px; background:white; box-shadow: var(--shadow); border-radius:15px; }
          .left{ color:#fff; width: 100%; min-width: 400px;}
        .right{ flex:1; display:flex; align-items:center; justify-content:center; }
        .slider{ position:relative; width: min(92vw, 700px); aspect-ratio: 12 / 6; background: var(--card-bg); border-radius: var(--slide-radius); overflow:hidden; margin: auto; }
        .scene-root{height:100% ; background: #F3F3F3; }
        .slide{ position:absolute; inset:0; opacity:0; pointer-events:none; transition: opacity .45s ease;  box-sizing:border-box; }
        .slide.active{ opacity:1; pointer-events:auto; }
        .grid{ display:grid; grid-template-columns: repeat(12, 1fr); grid-template-rows: repeat(6, 1fr);  width:100%; height:100%; }
        .area-wrapper{ display:grid; grid-auto-rows: 1fr; width:100%; height:100%; border-radius: 12px; overflow:hidden; position:relative; }
        .sceneblock{ display:flex; align-items:center; justify-content:center; width:100%; height:100%; box-sizing:border-box; position:relative; margin:4px; max-width: 100%; max-height: 100%; overflow: hidden; text-align: center; z-index: 9; }
        .text{ padding: 12px 14px; color: var(--text-strong); width: calc(100% - 4px); height: calc(100% - 4px); margin: 2px; display:flex; align-items:center; justify-content:center; text-align:center; font-size: 14px; line-height: 1.4; color: #222; word-wrap: break-word; word-break: break-word; white-space: normal; overflow: hidden; text-overflow: ellipsis; max-width: 100%; max-height: 100%; }
        .text:focus { outline: none; border: none;}
        .text.header{ font-weight: 800; font-size: clamp(16px, 2vw, 22px); }
        .text.subtitle{ font-weight: 600; font-size: clamp(14px, 1.6vw, 18px); color: var(--text-soft); }
        .text.title{ font-weight: 700; font-size: clamp(15px, 1.8vw, 20px); }
        .text.callout{ font-weight: 700; font-size: clamp(14px, 1.6vw, 18px); border-color:#ffe6b3; }
        .image{ width:100%; height:100%; overflow:hidden; border-radius: 12px; }
        .image > img{ width:100%; height:100%; object-fit: cover; display:block; }
        .avatar{ width: 100%; display: contents; }
        .avatar img{ height: 100%; }
        .circle-frame, .circle-frame > img{ border-radius: 50% !important; width: 100%; height: 100%; object-position: top; background-color: #fff; object-fit: cover; }
       .nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 50%;
    background: rgba(0, 0, 0, .55);
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    z-index: 20;
}
        .nav.prev{ left:14px; }
        .nav.next{ right:14px; }
        .scene-badge{ position:absolute; right:16px; top:14px; background: rgba(17,24,39,.75); color:#fff; font-size:12px; padding:6px 10px; border-radius:999px; z-index: 20; }
        .line-wrapper { display:flex; align-items:center; justify-content:stretch; pointer-events:none; z-index:20; }
        .error{ color:#fecaca; background:#7f1d1d; border:1px solid #fecaca33; padding:8px 10px; margin:8px 0; border-radius:8px; font-size:12px; }
        .controls{ display:flex; gap:8px; align-items:center; margin-top:8px; }
        .btn{ background:#111827; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; box-shadow: 0 6px 16px rgba(0,0,0,.25); }
        .btn:active{ transform: translateY(1px); }
        textarea{color:#000}
        .thumbnail .avatar img { pointer-events: none; cursor: default; }
 .thumbnail .image,
.thumbnail .image img {
  pointer-events: none;
  cursor: default;
}
  /* Add these new rules to your existing CSS */
.thumbnail .text {
  padding: 6px 7px;
  font-size: 7px;
  line-height: 1.2;
}

.thumbnail .text.header {
  font-size: clamp(8px, 1vw, 11px);
}

.thumbnail .text.subtitle {
  font-size: clamp(7px, 0.8vw, 9px);
}

.thumbnail .text.title {
  font-size: clamp(7.5px, 0.9vw, 10px);
}

.thumbnail .text.callout {
  font-size: clamp(7px, 0.8vw, 9px);
}

.thumbnail .sceneblock {
  margin: 2px;
}
  @media (max-width: 768px) {
    .layout {
      flex-direction: column;
    }
    .left {
      min-width: 100%;
      margin-bottom: 20px;
    }
    .right {
      width: 100%;
      margin-top: 20px;
    }
  } 
    @media(max-width:579px){
    .app-root {
    padding: 94px}
    }
     @media(max-width:768px){
    .app-root {
    padding: 94px}
    }

    @media (orientation: landscape) and (max-width:579px) {
  .hide-in-landscape {
    display: none;
  }


}
  @media (max-width: 820px) {
  .app-root {
   padding: 147px 24px;
  }

  @media (max-width: 768px) {
  .scene-root {
    font-size: 13px;
  }

}

 @media (max-width:579px) {
  .scene-root {
    font-size: 7px;
  }

  .scene-badge {
    font-size: 7px;
    padding: 4px 8px;
  }

  .slider .text {
  padding: 6px 7px;
  font-size: 7px;
  line-height: 1.2;
}
}


@media (max-width: 768px) {
  /* General text inside the main scene */
  .slider .text {
    font-size: 10px;
    line-height: 1.3;
    padding: 8px 10px;
  }


  .slider .text.header {
    font-size: clamp(11px, 2vw, 14px);
  }

  .slider .text.subtitle {
    font-size: clamp(10px, 1.8vw, 13px);
  }

  .slider .text.title {
    font-size: clamp(10.5px, 1.9vw, 13.5px);
  }

  .slider .text.callout {
    font-size: clamp(10px, 1.8vw, 12.5px);
  }

  .scene-badge {
    font-size: 10px;
    padding: 4px 8px;
  }
}


@media (max-width: 579px) {
  .slider .text {
    font-size: 8.5px;
    line-height: 1.3;
  }

  .slider .text.header {
    font-size: clamp(9px, 2.2vw, 12px);
  }

  .slider .text.subtitle,
  .slider .text.title,
  .slider .text.callout {
    font-size: clamp(8px, 2vw, 11px);
  }

  .scene-badge {
    font-size: 8px;
  }
}


.sceneblock {
  overflow: visible !important; /* Critical: stops clipping */
}
.area-wrapper {
  overflow: visible !important;
}
.grid {
  overflow: visible !important;
}
.scene-root {
  overflow: visible !important;
}
.slider {
  overflow: visible !important; /* Allows avatar to move outside slide bounds */
}

.grid,
.area-wrapper,
.sceneblock,
.scene-root,
.slider {
  overflow: visible !important;
}

.sceneblock img {
  max-width: none !important; /* Already have this, but reinforce */
}
  /* Add these rules at the end of your style block */
.slider,
.scene-root,
.grid,
.area-wrapper,
.sceneblock {
  overflow: visible !important;
}

.sceneblock img {
  max-width: none !important;
}

      `}),e.jsxs("div",{className:"layout container mx-auto",children:[e.jsx("button",{onClick:()=>dt(!Pe),className:"lg:hidden fixed bottom-6 right-6 z-50 bg-[#6C5DD3] text-white p-3 px-5 rounded-md shadow-lg hover:bg-[#5a4bc4] transition-all duration-200","aria-label":"Toggle Script Panel",children:Pe?e.jsx(zr,{className:"w-6 h-6"}):"Scripts"}),e.jsxs("div",{className:`
        lg:hidden fixed inset-x-0 bottom-0 w-full h-full max-h-[85vh]
        bg-white dark:bg-gray-900 rounded-t-3xl shadow-2xl z-40 overflow-y-auto
        transform transition-transform duration-300 ease-in-out
        ${Pe?"translate-y-0":"translate-y-full"}
      `,children:[e.jsx("div",{className:"sticky top-0 pt-4 pb-3 flex justify-center bg-inherit z-10",children:e.jsx("div",{className:"w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full"})}),e.jsxs("div",{className:"p-4 pb-24",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h4",{className:"text-black font-semibold text-lg",children:"Script"}),e.jsx("button",{onClick:kt,disabled:w,className:`bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition flex items-center gap-2 ${w?"opacity-70 cursor-not-allowed":"hover:bg-[#5a4bc4]"}`,children:w?"Generating...":"Generate Scripts"})]}),e.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"62vh"},children:Fe.map((t,r)=>e.jsx("div",{className:"mb-6 border border-gray-200 dark:border-gray-700 rounded-xl p-4 shadow-sm bg-white dark:bg-gray-800",children:t.scripts.map(s=>{const n=`${t.id}-${s.name}`;return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex gap-3 items-start flex-col",children:[(()=>{var y,d,c,f;const i=g.find(x=>x.id===t.id),u=i==null?void 0:i.variables.find(x=>x.type==="character");if(!u)return null;const a=b[u.name],o=(y=a==null?void 0:a.properties)==null?void 0:y.character_id,p=((c=(d=We[o])==null?void 0:d.data)==null?void 0:c.preview_image_url)||((f=re.find(x=>x.avatar_id===o))==null?void 0:f.preview_image_url)||oe;return e.jsxs("button",{onClick:()=>yt(t.id),className:"flex items-center gap-2 px-3 py-2 border rounded-lg hover:shadow-md transition",children:[e.jsx("img",{src:p,alt:"Avatar",className:"w-8 h-8 rounded-full object-cover"}),e.jsx(nt,{className:"text-sm"})]})})(),e.jsx("div",{className:"flex-1 space-y-3 w-full"})]})},n)})},t.id))})]})]}),e.jsx("div",{className:`
  hidden lg:block lg:relative h-full lg:w-auto w-full left fixed
  bg-white dark:bg-[#121212] z-40
  overflow-y-auto
`,children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center ",children:[e.jsx("h4",{className:"text-black dark:text-[#F8F8F8]",children:"Script"}),e.jsx("button",{className:`bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition flex items-center justify-center gap-2 mb-4 ${w?"opacity-70 cursor-not-allowed":""}`,onClick:kt,disabled:w,children:w?"Generating...":"Generate Scripts"})]}),e.jsx("div",{className:"overflow-y-auto mt-6",style:{maxHeight:"70vh"},children:Fe.map((t,r)=>{var n;return(((n=g[r])==null?void 0:n.variables)||[]).filter(i=>i.type==="character"),e.jsxs("div",{"data-scene-id":t.id,onFocus:()=>ne(r),className:"mb-6 border border-gray-200 dark:border-[#181818] rounded-xl p-2 shadow-sm bg-white dark:bg-[#121212] focus-within:ring-2 focus-within:ring-[#6C5DD3] focus-within:outline-none flex gap-2",children:[e.jsx("div",{className:`flex items-center justify-center w-6 h-6 rounded-full text-md font-bold cursor-pointer transition-all
    ${P===r?"bg-[#121212] text-white":"bg-black/60 text-white"}
  `,onClick:()=>ne(r),children:r+1}),t.scripts.map((i,u)=>{const a=`${t.id}-${i.name}`,o=lt[a];return ct[a],e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 justify-start",children:[(()=>{const p=g.find(c=>c.id===t.id),y=p==null?void 0:p.variables.find(c=>c.type==="character");return y&&b[y.name]?e.jsxs("div",{className:"relative inline-block",children:[e.jsxs("button",{"data-avatar-button":"true",onClick:()=>yt(t.id),className:"flex items-center justify-between px-4 py-2 border border-gray-300 bg-white text-black dark: font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 w-auto",children:[(()=>{var m,h,C;const c=g.find(v=>v.id===t.id),f=c==null?void 0:c.variables.find(v=>v.type==="character");if(!f)return e.jsx("span",{className:"text-sm",children:"No Character"});const x=b[f.name],A=(m=x==null?void 0:x.properties)==null?void 0:m.character_id,E=re.find(v=>v.avatar_id===A),I=((C=(h=We[A])==null?void 0:h.data)==null?void 0:C.preview_image_url)||(E==null?void 0:E.preview_image_url)||oe;return e.jsx("img",{src:I,alt:"Avatar",className:"w-6 h-6 rounded-full object-cover",onError:v=>{v.target.src=oe}})})(),e.jsx(nt,{className:"ml-2 text-black flex-shrink-0"})]}),ve===t.id&&e.jsxs("div",{ref:at,className:"absolute left-0 mt-2 w-80 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl z-50",children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-200 dark:border-gray-700",children:T&&T.length>0?e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>{G?ye(null):ae([])},className:"flex items-center gap-1 text-sm font-medium text-purple-600 hover:text-purple-800 transition-colors duration-200",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"Back"]})}):e.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Select Avatar"})}),e.jsx("div",{className:"flex items-center justify-center my-4",children:e.jsx("div",{className:`flex justify-center gap-3 ${T&&T.length>0&&!G?"overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent":""}`,children:T&&T.length>0&&G?e.jsxs("div",{className:"flex flex-col items-center justify-center w-full px-4",children:[e.jsx("div",{className:"relative w-24 h-24 rounded-full overflow-hidden border-2 border-purple-500 ring-2 ring-purple-200",children:e.jsx("img",{src:G.preview_image_url??G.image_url??G.image,alt:"Selected avatar",className:"w-full h-full object-cover",onError:c=>c.currentTarget.src=oe})}),e.jsxs("div",{className:"mt-3 text-center",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:G.name||G.avatar_name||`Avatar ${G.avatar_id??G.id}`}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Ready to apply"})]})]}):T&&T.length>0?T.map((c,f)=>{const x=g.find(I=>I.id===t.id);if(!(x==null?void 0:x.variables.find(I=>I.type==="character")))return null;const E=(c==null?void 0:c.image_url)||(c==null?void 0:c.preview_image_url);return e.jsx("div",{className:"flex flex-col items-center flex-shrink-0",children:e.jsx("button",{onClick:()=>{ye(c)},className:"relative w-16 h-16 rounded-full overflow-hidden border-2 border-gray-200 hover:border-purple-300 hover:ring-2 hover:ring-purple-100 transition-all duration-200 flex-shrink-0",children:E?e.jsx("img",{src:E,alt:`Avatar ${f+1}`,className:"w-full h-full object-cover",onError:()=>console.error("Failed to load avatar image:",E)}):e.jsx("div",{className:"w-full h-full bg-gray-100 flex items-center justify-center text-gray-400",children:e.jsx("svg",{className:"w-8 h-8",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z",clipRule:"evenodd"})})})})},`modal_${f}`)}):st&&st.length>0?st.map((c,f)=>{var C;const x=g.find(v=>v.id===t.id),A=x==null?void 0:x.variables.find(v=>v.type==="character");if(!A)return null;const E=b[A.name],I=(C=E==null?void 0:E.properties)==null?void 0:C.character_id,m=c.preview_image||c.image,h=I===c.avatar_id;return e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("button",{onClick:async()=>{const v=c.id||c.avatar_id;try{await ur(v)}catch(D){console.error("Error fetching avatars:",D)}},className:`relative w-16 h-16 rounded-full overflow-hidden border-2 transition-all duration-200 flex-shrink-0 ${h?"border-purple-500 ring-2 ring-purple-200":"border-gray-200 hover:border-purple-300 hover:ring-2 hover:ring-purple-100"}`,children:m?e.jsx("img",{src:m,alt:c.name||`Avatar ${f+1}`,className:"w-full h-full object-cover",onError:()=>console.error("Failed to load avatar image:",m)}):e.jsx("div",{className:"w-full h-full bg-gray-100 flex items-center justify-center text-gray-400",children:e.jsx("svg",{className:"w-8 h-8",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z",clipRule:"evenodd"})})})})},c.avatar_id||c.id||f)}):e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:[e.jsx("div",{className:"text-2xl mb-2",children:"ðŸ‘¤"}),e.jsx("p",{className:"text-sm",children:"No avatars available"})]})})}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 p-3",children:T&&T.length>0&&G?e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:async()=>{await lr(G,t.id),fe(null),ae([]),ye(null)},className:"flex-1 px-4 py-2 text-sm font-medium text-[#6C5DD3] bg-white rounded-md transition-colors duration-200 border border-purple-200 hover:border-purple-300 flex items-center justify-center gap-2",children:"Apply One"}),e.jsx("button",{onClick:async()=>{var x,A;if(!G)return;const c={avatar_id:G.avatar_id??G.id,preview_image_url:G.preview_image_url??G.image_url},f=ue.cloneDeep(b);for(const E of g){const I=E.variables.find(m=>m.type==="character");I&&(f[I.name]={...f[I.name],properties:{...(x=f[I.name])==null?void 0:x.properties,character_id:c.avatar_id,image:c.preview_image_url}})}_(f),N(he(f)),await ke({template_id:V,user_id:(A=R.user)==null?void 0:A.id,deal_id:z.id,variables:f}),fe(null),ae([]),ye(null)},className:"flex-1 px-4 py-2 text-sm font-medium text-white bg-[#6C5DD3] rounded-md transition-colors duration-200 flex items-center justify-center gap-2",children:"Apply to All"})]}):T&&T.length>0?e.jsx("p",{className:"text-xs text-center text-gray-500 dark:text-gray-400 py-2",children:"Select an avatar above to continue"}):e.jsx("button",{onClick:()=>{const c=g.find(x=>x.id===t.id),f=c==null?void 0:c.variables.find(x=>x.type==="character");Ne(f?f.name:t.id),De(!0),fe(null)},className:"w-full px-4 py-2 text-sm font-medium text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-md transition-colors duration-200 border border-purple-200 hover:border-purple-300",children:"View All Avatars"})})]})]}):null})(),(()=>{var f,x;const p=a.match(/scene_(\d+)_script/);if(!p)return null;const d=`voice_id_${p[1]}`;return((x=(f=b[d])==null?void 0:f.properties)==null?void 0:x.voice_id)?e.jsxs("div",{className:"relative inline-block w-1/2",children:[e.jsxs("button",{"data-voice-button":"true",onClick:()=>or(a,a),className:"flex items-center justify-between px-4 py-2 border dark:border-[#181818] rounded-lg dark:bg-[#121212] shadow-md transition text-left text-black dark:text-white w-full",children:[e.jsx("span",{className:"truncate max-w-[70%]",children:(()=>{var C,v;const A=a.match(/scene_(\d+)_script/);if(!A)return(o==null?void 0:o.name)||"Select AI Voice";const I=`voice_id_${A[1]}`,m=(v=(C=b[I])==null?void 0:C.properties)==null?void 0:v.voice_id,h=Ce.find(D=>D.voice_id===m)||o;return(h==null?void 0:h.name)||"Select AI Voice"})()}),e.jsx(nt,{className:"ml-2 text-gray-500 shrink-0"})]}),ct[a]&&o&&e.jsxs("div",{ref:A=>wt.current[a]=A,className:"absolute mt-2 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg z-50 p-2 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center justify-around my-1",children:[e.jsx("button",{onClick:()=>vt(o),className:"px-3 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg transition flex items-center justify-center",children:Je===(o==null?void 0:o.voice_id)?e.jsx(It,{className:"text-lg text-purple-600"}):e.jsx($t,{className:"text-lg text-purple-600"})}),e.jsx("span",{className:"text-sm text-center text-black font-medium",children:(()=>{var C,v;const A=a.match(/scene_(\d+)_script/);if(!A)return o==null?void 0:o.name;const I=`voice_id_${A[1]}`,m=(v=(C=b[I])==null?void 0:C.properties)==null?void 0:v.voice_id,h=Ce.find(D=>D.voice_id===m)||o;return(h==null?void 0:h.name)||"Select AI Voice"})()})]}),e.jsx("button",{onClick:()=>{Pt(a),Ie(A=>({...A,[a]:!1}))},className:"w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition",children:"View All"})]})]}):null})()]}),(()=>{var p;return(p=i.value)!=null&&p.trim().split(/\s+/).filter(Boolean).length,e.jsxs(e.Fragment,{children:[e.jsx("textarea",{rows:4,value:i.value,onFocus:()=>ne(r),onChange:y=>qt(t.id,i.name,y.target.value),placeholder:"Write your script here...",className:`w-full p-3 rounded-lg shadow-sm resize-none focus:outline-none transition
                                     dark:border-gray-600 dark:bg-gray-800 text-black dark:text-white
                                        ${Re[i.name]?"border border-red-500":""}`}),Re[i.name]&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:Re[i.name]}),e.jsxs("p",{className:`text-xs mt-1 ${Ze(i.value)>Oe?"text-red-500":"text-gray-400"}`,children:[Ze(i.value)," / ",Oe," words"]})]})})()]},a)})]},t.id)})})]})}),Pe&&e.jsx("div",{className:"lg:hidden fixed inset-0 bg-black bg-opacity-50 z-30",onClick:()=>dt(!1)}),e.jsx("div",{className:"right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex-1 flex items-center justify-center lg:block",children:[e.jsx("div",{className:"mt-4 flex justify-center z-40 relative",children:we&&(()=>{const t=Ye[we]||{x:0,y:0,scale:1},r=pt[we]||{x:0,y:0},s=r.x+t.x,n=r.y+t.y,i=s,u=-n;return e.jsx(Lr,{x:i,y:u,scale:t.scale,onMove:({x:a,y:o})=>{ft(we,{x:a,y:-o})},onScale:a=>{ft(we,{scale:a})}})})()}),e.jsx("div",{className:"w-full px-4 lg:px-0 mt-4",children:e.jsxs("div",{className:"slider",children:[e.jsx("button",{className:"nav prev",onClick:()=>k.length&&ne(t=>(t-1+k.length)%k.length),"aria-label":"Previous",children:"â®"}),e.jsx("button",{className:"nav next",onClick:()=>k.length&&ne(t=>(t+1)%k.length),"aria-label":"Next",children:"â¯"}),k.map((t,r)=>e.jsx("div",{className:`slide ${r===P?"active":""}`,children:e.jsx(gt,{scene:t,index:r})},t.id||r))]})})]}),e.jsx("div",{className:"fixed bottom-20 left-0 right-0 lg:relative lg:bottom-auto lg:left-auto lg:right-auto lg:mt-3 hide-in-landscape",children:e.jsxs("div",{className:"thumbnail-slider flex items-center justify-center relative px-4 lg:px-0 bg-white dark:bg-[#121212] lg:py-0 lg:bg-transparent",children:[e.jsx("button",{className:"thumb-nav prev",onClick:()=>qe(t=>Math.max(t-1,0)),children:"â®"}),e.jsx("div",{className:"thumbnails-wrapper overflow-hidden w-full sm:w-[750px]",children:e.jsx("div",{className:"thumbnails-track flex transition-transform duration-300",style:{transform:`translateX(-${He*zt}px)`},children:k.map((t,r)=>e.jsxs("div",{className:`thumbnail ${r===P?"active":""}
          w-[100px] h-[60px] sm:w-[140px] sm:h-[80px] mr-2 cursor-pointer relative`,onClick:s=>{s.stopPropagation(),ne(r);const n=document.querySelector(`div[data-scene-id="${t.id}"]`);n&&n.scrollIntoView({behavior:"smooth",block:"center"})},children:[e.jsx("div",{className:"pointer-events-none absolute inset-0",children:e.jsx(gt,{scene:t,index:r,isThumbnail:!0})}),e.jsx("div",{className:`absolute top-[1px] right-[3px] z-20 w-6 h-6 rounded-full text-xs font-semibold flex items-center justify-center shadow-md ${r===P?"bg-[#121212] text-white":"bg-black/60 text-white"}`,children:r+1})]},t.id||r))})}),e.jsx("button",{className:"thumb-nav next",onClick:()=>qe(t=>Math.min(t+1,k.length-Ae)),children:"â¯"})]})})]})})]}),ot&&e.jsx(Tr,{show:ot,onClose:()=>{De(!1),Ne(null)},avatars:Bt,VideoScenes:g,activeBlock:Vt,videoVariables:b,onSelect:async(t,r)=>{var u;const s=ue.cloneDeep(b),n=[];g.forEach(a=>{var p;const o=((p=a==null?void 0:a.variables)==null?void 0:p.filter(y=>y.type==="character"))||[];n.push(...o)});const i=a=>{var A,E,I,m,h,C;const o=a==null?void 0:a.trim();let p=g.find(v=>v.id===o);if(p||(p=g.find(v=>v.variables.some(D=>D.name===o||D.name.startsWith(o)))),!p){if(b[o]){s[o]={...s[o],properties:{...(A=s[o])==null?void 0:A.properties,character_id:t.avatar_id,image:t.preview_image_url}};return}console.error("[Parent] Could not find scene or variable for:",o);return}const y=p.variables.find(v=>v.type==="character");if(!y){console.warn(`[Parent] No character variable in scene ${p.id}`);return}const d=y.name,c=n.findIndex(v=>v.name===d);let f=Qe[c];f||(f={offset:{x:0,y:0},scale:1});const x=c===n.length-1;s[d]={...s[d],properties:{...(E=s[d])==null?void 0:E.properties,character_id:t.avatar_id,image:t.preview_image_url,offset:((m=(I=s[d])==null?void 0:I.properties)==null?void 0:m.offset)??f.offset,scale:((C=(h=s[d])==null?void 0:h.properties)==null?void 0:C.scale)??f.scale,...x?{avatar_style:"circle"}:{}}}};r==="ALL"?g.forEach(a=>{a.variables.find(p=>p.type==="character")&&i(a.id)}):r&&i(r),_(s),N(he(s));try{await ke({template_id:V,user_id:(u=R.user)==null?void 0:u.id,deal_id:z.id,variables:s})}catch(a){console.error("[Parent] Error saving avatar to API",a)}De(!1),Ne(null)}}),e.jsx(Dr,{isModalOpen:Tt,setIsModalOpen:Me,voices:rr,heygenVoiceMap:sr,loading:ir,voiceKey:O,videoVariables:b,playingAudioId:Je,handlePlayAudio:vt,handleVoiceSelect:Rt})]})]})}export{Zr as default};
