import{r as o,h as hr,m as e,b3 as Et,b4 as gr,b5 as br,t as vr,s as yr,a1 as wr,u as ue,q as jr,b6 as _r,b7 as ot,b8 as ve,b9 as Ne,ba as Nr,bb as kr,bc as Cr,bd as Ar,be as Sr,bf as Er,bg as Vr,bh as $r}from"./index-B1P5acEq.js";import{l as pe}from"./lodash-B5fXgQtM.js";import{C as Vt}from"./index-Dqjd6quM.js";import{b as Ir}from"./index-DeDtW0bZ.js";import{u as Tr}from"./useRefreshUser-DfJI3zGb.js";import{X as Fr}from"./x-CfU72frF.js";const ne="/assets/aiii-qzy6FebL.webp";function zr({show:V,onClose:j,avatars:M,onSelect:L,VideoScenes:T,activeBlock:v,videoVariables:ee}){const[te,H]=o.useState(null),[re,$]=o.useState([]),[B,U]=o.useState(!1),[K,F]=o.useState(!1),[W,Y]=o.useState(!1),[I,b]=o.useState(null),[z,_]=o.useState("all"),[k,R]=o.useState("");if(!V)return null;const P=async w=>{var X;Y(!0);try{const G=`https://api.heygen.com/v2/avatar_group/${w.id}/avatars`,E=await fetch(G,{method:"GET",headers:{"X-Api-Key":"sk_V2_hgu_kFHRWykcXEd_oisfR7mnYitgiX8vwtraF2NoDtg3J73V","Content-Type":"application/json"}});if(!E.ok)throw new Error(`HTTP ${E.status}`);const Je=await E.json();$(((X=Je.data)==null?void 0:X.avatar_list)||[]),H(w),U(!0),F(!1)}catch(G){console.error("[AvatarModal] fetch error:",G)}finally{Y(!1)}},J=()=>{U(!1),H(null),$([]),b(null),F(!1)},ie=()=>{F(!1),b(null)},ye=w=>{b(w),F(!0)};M.filter(w=>{var X,G;return z==="all"?!0:z==="male"?((X=w.gender)==null?void 0:X.toLowerCase())==="male":z==="female"?((G=w.gender)==null?void 0:G.toLowerCase())==="female":!0});const me=M.filter(w=>{var X,G,E;return z!=="all"&&(z==="male"&&((X=w.gender)==null?void 0:X.toLowerCase())!=="male"||z==="female"&&((G=w.gender)==null?void 0:G.toLowerCase())!=="female")?!1:k?(E=w.name)==null?void 0:E.toLowerCase().includes(k.toLowerCase()):!0}),He=me.length>0,fe=()=>{if(!I){console.warn("[AvatarModal] No avatar selected");return}if(!L){console.error("[AvatarModal] onSelect prop missing");return}if(!v){console.error("[AvatarModal] activeBlock (scene ID) missing");return}const w={avatar_id:I.avatar_id||I.id,preview_image_url:I.image_url||I.preview_image_url,...I};L(w,v),F(!1),b(null),U(!1),H(null),$([])},Ke=()=>{if(!I||!L||!Array.isArray(T)){console.warn("[AvatarModal] Invalid state for Apply to All");return}const w={avatar_id:I.avatar_id||I.id,preview_image_url:I.image_url||I.preview_image_url,...I};L(w,"ALL"),F(!1),b(null),U(!1),H(null),$([])};return hr.createPortal(e.jsxs(e.Fragment,{children:[!B&&!K&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[9999] bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-5xl relative flex flex-col max-h-[80vh] m-5 md:m-0",children:[e.jsx("button",{onClick:j,className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black z-10",children:"X"}),e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-lg font-semibold",children:"Choose an Avatar Group"})}),e.jsx("div",{className:"p-4 border-b flex flex-col gap-2",children:e.jsx("input",{type:"text",placeholder:"Search avatar name...",value:k,onChange:w=>R(w.target.value),className:"px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"})}),e.jsx("div",{className:"p-4 overflow-y-auto",children:W?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"})}):e.jsx("div",{className:"select-ai-voice-grid-wrap",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:me.length>0?me.map(w=>e.jsxs("div",{className:"cursor-pointer flex flex-col p-2 border rounded-md hover:border-blue-500 transition-colors",onClick:()=>P(w),children:[e.jsx("img",{src:w.preview_image||ne,alt:w.name,className:"w-full h-32 object-contain rounded-md border",onError:X=>X.currentTarget.src=ne}),e.jsxs("div",{className:"flex justify-between items-center mt-2 px-1",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:w.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[w.num_looks," looks"]})]})]},w.id)):me.length===0||k&&!He?e.jsx("p",{className:"col-span-full text-gray-500 text-center",children:"No avatar found"}):null})})}),e.jsx("div",{className:"flex justify-start p-4 border-t",children:e.jsx("button",{onClick:j,className:"px-4 py-2 bg-gray-300 rounded hover:bg-gray-400",children:"Back"})})]})}),B&&!K&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[9999] bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-5xl relative flex flex-col max-h-[80vh] m-5 md:m-0",children:[e.jsx("button",{onClick:j,className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black z-10",children:"X"}),e.jsx("div",{className:"p-4 border-b",children:e.jsxs("h2",{className:"text-lg font-semibold",children:[(te==null?void 0:te.name)||"Avatar"," - Select a Look"]})}),e.jsx("div",{className:"p-4 overflow-y-auto",children:W?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"})}):e.jsx("div",{className:"select-ai-voice-grid-wrap",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4",children:re.length>0?re.map((w,X)=>e.jsxs("div",{className:"cursor-pointer flex flex-col items-center p-2 border rounded-md hover:border-purple-500 transition-colors",onClick:()=>ye(w),children:[e.jsx("img",{src:w.image_url||w.preview_image_url||ne,alt:w.avatar_name||`Avatar ${X+1}`,className:"w-full h-32 object-contain rounded-md border",onError:G=>G.currentTarget.src=ne}),w.avatar_name&&e.jsx("p",{className:"mt-2 text-xs font-medium truncate max-w-full",children:w.avatar_name})]},w.avatar_id||w.id||X)):e.jsx("p",{className:"col-span-full text-gray-500 text-center",children:"No looks available"})})})}),e.jsx("div",{className:"flex justify-start p-4 border-t",children:e.jsx("button",{onClick:J,className:"px-4 py-2 bg-gray-300 rounded hover:bg-gray-400",children:"Back"})})]})}),K&&I&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[9999] bg-black/50",children:e.jsxs("div",{className:"bg-white rounded-lg w-full max-w-xl relative flex flex-col m-5 md:m-0",children:[e.jsx("button",{onClick:j,className:"absolute top-2 right-2 text-xl text-gray-600 hover:text-black z-10",children:"X"}),e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-lg font-semibold",children:"Confirm Avatar"})}),e.jsxs("div",{className:"p-6 flex flex-col items-center",children:[e.jsx("div",{className:"relative w-40 h-40 rounded-full overflow-hidden border-4 border-purple-500 ring-4 ring-purple-200 mb-4",children:e.jsx("img",{src:I.image_url||I.preview_image_url||ne,alt:"Selected",className:"w-full h-full object-cover",onError:w=>w.currentTarget.src=ne})}),e.jsx("p",{className:"text-lg font-medium text-gray-900",children:I.avatar_name||I.name||"Avatar"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Ready to apply"})]}),e.jsxs("div",{className:"p-4 border-t flex gap-3",children:[e.jsx("button",{onClick:ie,className:"flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300",children:"Back"}),e.jsxs("button",{onClick:fe,className:"flex-1 px-4 py-2 bg-[#6C5DD3] text-white rounded-md hover:bg-purple-700 flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),"Apply One"]}),e.jsxs("button",{onClick:Ke,className:"flex-1 px-4 py-2 bg-[#6C5DD3] text-white rounded-md flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),"Apply to All"]})]})]})}),e.jsx("style",{jsx:!0,children:`
        .loader {
          border-top-color: #3498db;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }
      `})]}),document.body)}function Rr({isModalOpen:V,setIsModalOpen:j,voices:M=[],heygenVoiceIds:L=new Set,voiceKey:T,videoVariables:v,playingAudioId:ee,handlePlayAudio:te,handleVoiceSelect:H,loading:re=!1}){const[$,B]=o.useState("all"),[U,K]=o.useState(null),[F,W]=o.useState(!1),I=(()=>{var J,ie,ye;const _=T==null?void 0:T.match(/scene_(\d+)_script/);if(!_)return null;const R=`voice_id_${_[1]}`,P=v==null?void 0:v[R];return((J=P==null?void 0:P.properties)==null?void 0:J.voice_id)||((ie=P==null?void 0:P.voice)==null?void 0:ie.Voice_id)||((ye=P==null?void 0:P.voice)==null?void 0:ye.voice_id)||null})(),b=o.useMemo(()=>{if(!Array.isArray(M)||M.length===0)return[];const _=M.filter(k=>(k==null?void 0:k.voice_id)&&L.has(k.voice_id));return $==="male"?_.filter(k=>k.gender==="male"):$==="female"?_.filter(k=>k.gender==="female"):_},[M,$,L]),z=_=>L.has(_);return V?e.jsxs("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0",onClick:()=>j(!1)}),e.jsxs("div",{className:"relative bg-white dark:bg-gray-900 w-full max-w-4xl max-h-[85vh] overflow-hidden rounded-lg shadow-xl flex flex-col mx-4",children:[e.jsx("button",{onClick:()=>j(!1),className:"absolute top-4 right-4 text-2xl z-10 text-gray-600 hover:text-black dark:text-gray-300",children:"X"}),e.jsx("h2",{className:"text-xl font-semibold p-6 pb-3 text-black dark:text-white",children:"ðŸŽ™ï¸ Select AI Voice"}),e.jsx("div",{className:"flex justify-center gap-4 px-6 border-b pb-4",children:["all","male","female"].map(_=>e.jsx("button",{onClick:k=>{k.stopPropagation(),B(_),K(null)},className:`px-6 py-2 rounded-lg font-medium transition ${$===_?"bg-purple-600 text-white":"bg-gray-200 dark:bg-gray-700"}`,children:_.charAt(0).toUpperCase()+_.slice(1)},_))}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6",children:re?e.jsx("div",{className:"flex justify-center py-20",children:e.jsx("div",{className:"w-12 h-12 border-4 border-purple-600 border-t-transparent rounded-full animate-spin"})}):b.length===0?e.jsx("p",{className:"text-center text-gray-500 py-10",children:re?"Loading voices...":$==="all"?"No supported voices available":`No supported ${$} voices available`}):e.jsx("div",{className:"select-ai-voice-grid-wrap",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4",children:b.map(_=>{const k=z(_.voice_id),R=I===_.voice_id;return e.jsx("div",{onClick:()=>k&&K(_),className:`
                      flex flex-col items-center justify-between p-2 rounded-lg border transition shadow-sm text-sm
                      ${R?"bg-[#EDF4FF] text-black/[1] border-[#6C5DD3]":"bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:shadow-md"}
                    
                    `,children:e.jsxs("div",{className:"flex items-center gap-2 w-full min-w-0",children:[e.jsx("button",{onClick:P=>{P.stopPropagation(),k&&te(_)},disabled:!k,className:`
                          p-1 rounded-full transition text-sm
                          ${R?"bg-white text-[#6C5DD3]":"bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-purple-600"}
                          ${k?"":"opacity-50 cursor-not-allowed"}
                        `,children:ee===_.voice_id?e.jsx(Et,{className:"text-base"}):e.jsx(Vt,{className:"text-base"})}),e.jsx("span",{className:`font-medium truncate ${R?"text-black":"text-gray-800 dark:text-gray-200"}`,children:_.name}),e.jsx("div",{className:"ml-1 flex gap-[2px] items-end flex-shrink-0",children:[...Array(5)].map((P,J)=>e.jsx("span",{className:`w-[2px] h-2 bg-[#6C5DD3] rounded ${ee===_.voice_id&&k?"animate-pulse":"opacity-50"}`,style:{animationDelay:`${J*.1}s`}},J))})]})},_.voice_id)})})})}),U&&e.jsx("div",{className:"fixed inset-0 z-[10000] flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-lg w-full max-w-xl relative flex flex-col m-5 md:m-0 shadow-2xl",children:[e.jsx("button",{onClick:()=>K(null),className:"absolute top-3 right-3 text-2xl text-gray-600 hover:text-black dark:text-gray-300 dark:hover:text-white z-10",children:"X"}),e.jsx("div",{className:"p-6 pb-4 border-b border-gray-200 dark:border-gray-700 text-center",children:e.jsx("h2",{className:"text-2xl font-bold text-black dark:text-white",children:"Confirm Voice"})}),e.jsxs("div",{className:"p-8 flex flex-col items-center text-center",children:[e.jsx("div",{className:"w-28 h-28 bg-[#6C5DD3] rounded-full flex items-center justify-center text-white text-5xl font-bold mx-auto mb-6 shadow-lg",children:"ðŸŽ™ï¸"}),e.jsx("p",{className:"text-2xl font-semibold text-gray-900 dark:text-white mb-2",children:U.name}),e.jsx("p",{className:"text-base text-gray-500 dark:text-gray-400",children:"Ready to apply voice"})]}),e.jsxs("div",{className:"p-6 border-t border-gray-200 dark:border-gray-700 flex gap-4",children:[e.jsx("button",{onClick:()=>K(null),className:"flex-1 px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition font-medium",children:"Cancel"}),e.jsx("button",{disabled:F,onClick:async()=>{W(!0),await new Promise(_=>setTimeout(_,100));try{await H(U,"current")}finally{W(!1),K(null),j(!1)}},className:"flex-1 px-6 py-3 bg-[#6C5DD3] text-white rounded-lg hover:bg-purple-700 disabled:opacity-60 disabled:cursor-not-allowed transition font-medium flex items-center justify-center gap-3",children:F?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Applying..."]}):"Apply One"}),e.jsx("button",{disabled:F,onClick:async()=>{W(!0),await new Promise(_=>setTimeout(_,100));try{await H(U,"all")}finally{W(!1),K(null),j(!1)}},className:"flex-1 px-6 py-3 bg-[#6C5DD3] text-white rounded-lg hover:bg-purple-700 disabled:opacity-60 disabled:cursor-not-allowed transition font-medium flex items-center justify-center gap-3",children:F?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Applying..."]}):"Apply to All"})]})]})})]})]}):null}function Dr({show:V,onClose:j,modalTitle:M,modalMessage:L,showProgress:T}){return V?e.jsxs("div",{className:"fixed inset-0 z-[9999]",children:[e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50",onClick:j}),e.jsxs("div",{className:"absolute top-20 right-8 bg-white dark:bg-gray-900 w-full max-w-md rounded-2xl shadow-lg p-6 text-center z-50",children:[e.jsx("button",{onClick:j,className:"absolute top-3 right-3 text-2xl text-gray-600 hover:text-black dark:text-gray-300 dark:hover:text-white",children:"âœ•"}),e.jsxs("div",{className:"flex items-start gap-4",children:[T&&e.jsx(gr,{className:"text-black animate-spin text-3xl"}),e.jsxs("div",{className:"text-start",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 dark:text-white",children:M}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 mt-1",children:L})]})]}),T&&e.jsx("div",{className:"mt-6 w-full bg-gray-200 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"h-2 bg-[#6C5DD3] rounded-full animate-progress"})})]})]}):null}function Mr({loading:V}){return V?e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm",children:e.jsxs("div",{className:"flex flex-col items-center gap-4 p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl",children:[e.jsxs("div",{className:"relative w-16 h-16",children:[e.jsx("div",{className:"absolute inset-0 border-4 border-purple-200 dark:border-purple-900 rounded-full"}),e.jsx("div",{className:"absolute inset-0 border-4 border-transparent border-t-purple-600 rounded-full animate-spin"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-1",children:"Resetting..."}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Please wait while we restore the original template"})]})]})}):null}function Pr({x:V=0,y:j=0,scale:M=1,onMove:L,onScale:T}){return e.jsxs("div",{className:"w-full max-w-md bg-white dark:bg-[#121212] border border-gray-200 dark:border-gray-700 p-5 rounded-xl shadow-lg",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-center",children:"Avatar Position & Zoom"}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsx("span",{children:"Horizontal Position"}),e.jsx("span",{className:"font-mono",children:V.toFixed(2)})]}),e.jsx("input",{type:"range",min:"-1",max:"1",step:"0.01",value:V,onChange:v=>{L({x:parseFloat(v.target.value),y:j})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600"}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500 mt-1",children:[e.jsx("span",{children:"â† Far Left (-1)"}),e.jsx("span",{children:"Center (0)"}),e.jsx("span",{children:"Far Right (1) â†’"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsx("span",{children:"Vertical Position"}),e.jsx("span",{className:"font-mono",children:j.toFixed(2)})]}),e.jsx("input",{type:"range",min:"-1",max:"1",step:"0.01",value:j,onChange:v=>{L({x:V,y:parseFloat(v.target.value)})},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600"}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500 mt-1",children:[e.jsx("span",{children:"â†‘ Top (-1)"}),e.jsx("span",{children:"Center (0)"}),e.jsx("span",{children:"Bottom (1) â†“"})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsx("span",{children:"Zoom"}),e.jsxs("span",{className:"font-mono",children:[M.toFixed(2),"x"]})]}),e.jsx("input",{type:"range",min:"0.3",max:"2",step:"0.01",value:M,onChange:v=>{T(parseFloat(v.target.value))},className:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-600"}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500 mt-1",children:[e.jsx("span",{children:"0.3x"}),e.jsx("span",{children:"1x"}),e.jsx("span",{children:"2x"})]})]}),e.jsx("button",{onClick:()=>{L({x:0,y:0}),T(1)},className:"w-full py-2.5 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 text-white font-medium rounded-lg transition-colors",children:"Reset to Screen Center"})]})}function Lr({sceneId:V,elStyle:j,classes:M,videoVariables:L,setVideoVariables:T,dispatch:v,isThumbnail:ee}){var W;const te=o.useRef(null),[H,re]=o.useState({}),$=/^cc_bgimg\d+_cc__FI__Z_0$/.test(V),B="https://investier.visionvivante.in/storage/deal_images/GJO5G81JE5jkAtseXrJjUyphnBjEc3QvTOj2bwVO.jpg?text="+encodeURIComponent(V),U=((W=L[V])==null?void 0:W.properties)||{};V.toLowerCase().includes("logo");const K=H[V]||U.content||U.url||U.image||B,F=async(Y,I,b)=>{var z;try{await AiDataSend({template_id:templateId,user_id:(z=user.user)==null?void 0:z.id,deal_id:deal.id,variables:{...I,[Y]:{...I[Y],properties:{...I[Y].properties,url:b}}}})}catch(_){console.error("Error saving image",_)}};return e.jsxs("div",{className:"sceneblock",style:{padding:j==null?void 0:j.padding,zIndex:j==null?void 0:j.zIndex},children:[e.jsx("div",{className:`image ${M!=null&&M.includes("circle-frame")?"circle-frame":""}`,onClick:()=>{var Y;!ee&&!$&&((Y=te.current)==null||Y.click())},style:{cursor:ee?"default":"pointer"},children:e.jsx("img",{alt:V,src:K,className:M!=null&&M.includes("circle-frame")?"circle-frame":""})}),!ee&&!$&&e.jsx("input",{type:"file",accept:"image/*",ref:te,style:{display:"none"},onChange:async Y=>{const I=Y.target.files[0];if(!I)return;const b=new FormData;b.append("image",I);let z;try{z=await br(b)}catch(k){console.log(k)}const _=new FileReader;_.onload=k=>{k.target.result;const R=pe.cloneDeep(L);R[V]||(R[V]={properties:{}}),R[V].properties={...R[V].properties,url:z.data.url,content:null},T(R),v(SaveAiVideoData(R)),re(P=>({...P,[V]:z.data.url})),setBaseToUrl(z.data.url),F(V,R,z.data.url)},_.readAsDataURL(I)}})]},V)}function Qr(){var Ct;const V=vr(),j=yr(),M=wr(),L=Tr(),{templateId:T}=M.state,v=ue(t=>t.deal.VideoScenes||[]),ee=ue(t=>t.deal.AiAvatars||[]),te=ue(t=>t.deal.AiAvatarGroups||[]),H=ue(t=>t.deal.VideoVariables),re=ue(t=>t.deal.VideoValidations),$=ue(t=>t.deal.deal),{user:B}=ue(t=>t),U=Object.entries(H).filter(([t,r])=>(r==null?void 0:r.type)==="character").map(([t,r])=>({id:t,...r})),{showSnackbar:K}=jr(),[F,W]=o.useState([]),[Y,I]=o.useState(null),[b,z]=o.useState(H),[_,k]=o.useState(!1),[R,P]=o.useState(null),[J,ie]=o.useState(!1),[ye,me]=o.useState(!1),[He,fe]=o.useState(""),[Ke,w]=o.useState(""),[X,G]=o.useState(!1),[E,Je]=o.useState([]),[ae,xe]=o.useState(0),[Br,Or]=o.useState(""),[lt,Ie]=o.useState({}),[ct,Te]=o.useState(!1),[$t,ke]=o.useState(null),[Ye,qe]=o.useState(0),It=150,Ce=5,Ae=ue(t=>t.deal.AiVoices||[]),[dt,Fe]=o.useState({}),[Ze,ze]=o.useState(null),[Tt,Qe]=o.useState(!1),[ut,Se]=o.useState({}),[we,he]=o.useState(null),[O,je]=o.useState(null),[Re,De]=o.useState([]),[Me,pt]=o.useState(!1),[Wr,Ft]=o.useState(),[Gr,zt]=o.useState({}),mt=o.useRef({}),Rt=(t,r)=>{const s=t.match(/__P_(\d+)_(\d+)_(\d+)_(\d+)/);if(!s)return{x:0,y:0,scale:1};const[i,n,d,a,l]=s.map(Number),u=(n+a)/2,m=(d+l)/2,f=(u-6.5)/6.5,c=(m-3.5)/3.5;return console.log("Calculated initial position:",{variableName:t,gridArea:{startCol:n,startRow:d,endCol:a,endRow:l},centerCol:u,centerRow:m,normalizedPosition:{x:f.toFixed(2),y:c.toFixed(2)}}),{x:Math.max(-1,Math.min(1,f)),y:Math.max(-1,Math.min(1,c)),scale:1}},[oe,Dt]=o.useState(()=>{const t={};return v.forEach(r=>{const s=r.variables.find(i=>i.type==="character");if(s){const i=Rt(s.name,r.variables);t[r.id]=i,console.log("ðŸŽ¬ Scene initial transform:",{sceneId:r.id,characterVar:s.name,position:i})}else t[r.id]={x:0,y:0,scale:1}}),console.log("All initial transforms:",t),t}),ft=(t,r)=>{var a,l,u,m,f,c;console.log("updateTransform called:",{sceneId:t,next:r}),console.log("Current avatarTransforms before update:",oe),Dt(p=>({...p,[t]:{...p[t]||{x:0,y:0,scale:1},...r}}));const s=v.find(p=>p.id===t);console.log("Current scene found:",s);const i=s==null?void 0:s.variables.find(p=>p.type==="character");if(console.log("Character variable:",i),!i){console.warn("No character variable found for scene:",t);return}const n=i.name,d=pe.cloneDeep(b);d[n]||(d[n]={name:n,type:"character",properties:{}}),d[n].properties={...d[n].properties,offset:{x:r.x!==void 0?r.x:((l=(a=d[n].properties)==null?void 0:a.offset)==null?void 0:l.x)||0,y:r.y!==void 0?r.y:((m=(u=d[n].properties)==null?void 0:u.offset)==null?void 0:m.y)||0},scale:r.scale!==void 0?r.scale:((f=d[n].properties)==null?void 0:f.scale)||1},z(d),j(ve(d)),Ne({template_id:T,user_id:(c=B.user)==null?void 0:c.id,deal_id:$.id,variables:d}).catch(console.error)},Ee=(Ct=E[ae])==null?void 0:Ct.id,Pe=oe[Ee]||{x:0,y:0,scale:1},Mt=t=>{mt.current[t]=lt[t]||Oe(t)},Pt=t=>{ie(!0),Qe(!0),P(t),setTimeout(()=>{ie(!1)},1e3)},Lt=o.useCallback(async(t,r="current")=>{if(t!=null&&t.voice_id){if(z(s=>{const i=pe.cloneDeep(s);if(r==="current"&&R){const n=R.match(/scene_(\d+)_script/);if(n){const a=`voice_id_${n[1]}`;i[a]||(i[a]={name:a,type:"voice",properties:{}}),i[a].properties.voice_id=t.voice_id}}return r==="all"&&Object.keys(i).forEach(n=>{n.startsWith("voice_id_")&&(i[n]||(i[n]={name:n,type:"voice",properties:{}}),i[n].properties.voice_id=t.voice_id)}),i}),r==="current"&&R&&Fe(s=>({...s,[R]:t})),r==="all"){const s={};E.forEach(i=>{i.scripts.forEach(n=>{const d=`${i.id}-${n.name}`;s[d]=t})}),Fe(s)}Qe(!1),P(null)}},[R,E]),Bt=["PUBLIC_PHOTO","PUBLIC","COMMUNITY_PHOTO"],Ot=te.filter(t=>{var r;return Bt.includes((r=t.group_type)==null?void 0:r.trim().toUpperCase())}),Wt=async(t,r)=>{try{let s=[];return{cleanedVariables:Object.fromEntries(Object.entries(r).filter(([n,d])=>{const a=(d==null?void 0:d.properties)||{},l=typeof a.content=="string"&&a.content.trim()!=="",u=a.url||a.image,m=a.character_id!==void 0&&a.character_id!==null&&String(a.character_id).trim()!=="",f=a.voice_id&&String(a.voice_id).trim()!=="",c=a.offset&&typeof a.offset.x=="number"&&typeof a.offset.y=="number",p=typeof a.scale=="number",h=l||u||m||f||c||p;return h||s.push(n),h})),emptyKeys:s}}catch(s){return console.error("API error:",s),{cleanedVariables:{},emptyKeys:[]}}},Gt=async(t,r,s)=>{var i;try{await Ne({template_id:T,user_id:(i=B.user)==null?void 0:i.id,deal_id:$.id,variables:{...s,[t]:{...s[t],properties:{...s[t].properties,content:r}}}})}catch(n){console.error("Error saving to API",n)}};o.useEffect(()=>{we||je(null)},[we]);const et=(t="")=>t.trim()===""?0:t.trim().split(/\s+/).length,Ut=t=>{const r={...t},s=Object.keys(r).filter(i=>{var n;return((n=r[i])==null?void 0:n.type)==="character"});return s.forEach((i,n)=>{var l,u;const d=tt[n];if(!d)return;const a=n===s.length-1;r[i]={...r[i],properties:{...r[i].properties,offset:((l=r[i].properties)==null?void 0:l.offset)??d.offset,scale:((u=r[i].properties)==null?void 0:u.scale)??d.scale,...a?{avatar_style:"circle"}:{}}}}),r},tt=[{offset:{x:-.3,y:.14},scale:.7},{offset:{x:0,y:.14},scale:.7},{offset:{x:.3,y:.25},scale:.5},{offset:{x:-.38,y:-.25},scale:.5},{offset:{x:0,y:-.25},scale:.5},{offset:{x:.35,y:-.31},scale:.35},{offset:{x:.45,y:-.2},scale:.8}],Xt=async()=>{var t,r;try{if(Object.values(Le).some(c=>c)){w("Word limit exceeded"),fe("Please reduce words before generating the video."),k(!0);return}const{cleanedVariables:i,emptyKeys:n}=await Wt(T,b),d=Ut(i);if(n.length>0){w("Missing Fields"),fe(`Some fields are still missing:${n}`),G(!1),k(!0);return}if(!i||Object.keys(i).length===0){w("No Variables"),fe("All fields are empty. Please fill them before generating."),G(!1),k(!0);return}w("Generatingâ€¦"),fe(""),G(!0),k(!0),console.log("FINAL VARIABLES SENT TO API:",JSON.stringify(d,null,2)),console.log(v);const a=await fetch(`https://api.heygen.com/v2/template/${T}/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-API-KEY":"sk_V2_hgu_kFHRWykcXEd_oisfR7mnYitgiX8vwtraF2NoDtg3J73V"},body:JSON.stringify({test:!0,variables:d,dimension:{width:1280,height:720}})});if(!a.ok)throw new Error("Failed to generate video");const l=await a.json(),u=await Nr({user_id:(t=B.user)==null?void 0:t.id});console.log("Minus Count Response:",u);const m=await kr({deal:$.id,ai_video_id:(r=l==null?void 0:l.data)==null?void 0:r.video_id}),f=await L();if(console.log("User after minus count:",f),m!=null&&m.status)sessionStorage.setItem(`video_generated_${$.id}`,"true"),V(`/deals/deal-view/${$.id}`);else throw new Error("Failed to save generated video")}catch(s){console.error("Error during video generation:",s),G(!1),w("Error"),fe("There is some error please contact admin or try again in some time"),k(!0)}};o.useEffect(()=>{v&&v.length>0&&Je(v)},[v]);const Ht=async()=>{var t,r,s,i,n;if(T){me(!0);try{const d={template_id:T,user_id:(t=B.user)==null?void 0:t.id,deal_id:$.id};await Cr(d,T);const a=await Ar({template_id:T,user_id:(r=B.user)==null?void 0:r.id,deal_id:$.id});let l=((s=a==null?void 0:a.data)==null?void 0:s.variables)??((n=(i=a==null?void 0:a.data)==null?void 0:i.data)==null?void 0:n.variables)??(a==null?void 0:a.variables)??{};j(ve(l)),z(l);const u={};Object.entries(l).forEach(([f,c])=>{var p;((p=c==null?void 0:c.properties)==null?void 0:p.content)!==void 0&&(u[f]=c.properties.content)}),Ie(u);const m=v.map(f=>({id:f.id,scripts:f.variables.filter(c=>c.type==="text"&&c.name.endsWith("_script")).map(c=>{var h,N;const p=((N=(h=l[c.name])==null?void 0:h.properties)==null?void 0:N.content)||"";return{name:c.name,value:p}})}));De(m),zt({}),Ft(null),Fe({}),xt({}),P(null),ze(null),Se({}),he(null),W([]),je(null),Object.keys(le.current).forEach(f=>{le.current[f]&&clearTimeout(le.current[f])}),le.current={},Kt.current={},setTimeout(()=>{Object.keys(l).forEach(f=>{var p,h;const c=document.getElementById(f);if(c&&c.contentEditable==="true"){const N=((h=(p=l[f])==null?void 0:p.properties)==null?void 0:h.content)||Oe(f);c.textContent!==N&&(c.textContent=N)}})},100)}catch(d){console.error("Reset failed silently:",d)}finally{me(!1)}}};o.useEffect(()=>{const t={};Object.entries(b).forEach(([r,s])=>{var i;((i=s==null?void 0:s.properties)==null?void 0:i.content)!==void 0&&(t[r]=s.properties.content)}),Ie(t)},[b]),o.useEffect(()=>{console.log("videoVariables state updated (local):",b),console.log("Redux VideoVariables (from selector):",H)},[b,H]),o.useEffect(()=>{if(v&&v.length>0){const t=v.map(r=>{const s=r.variables.filter(i=>i.type==="text"&&i.name.endsWith("_script")).map(i=>{var n,d;return{name:i.name,value:((d=(n=b[i.name])==null?void 0:n.properties)==null?void 0:d.content)||""}});return{id:r.id,scripts:s}});De(t)}},[v]);const Kt=o.useRef({}),le=o.useRef({}),[Le,xt]=o.useState({}),Be=40,rt=o.useRef(new Map),Jt=(t,r,s)=>{const n=et(s)>Be;if(De(d=>d.map(a=>a.id===t?{...a,scripts:a.scripts.map(l=>l.name===r?{...l,value:s}:l)}:a)),xt(d=>({...d,[r]:n?`Maximum ${Be} words allowed`:""})),n){le.current[r]&&clearTimeout(le.current[r]);return}rt.current.set(r,s),le.current[r]&&clearTimeout(le.current[r]),le.current[r]=setTimeout(()=>{var l;const d=rt.current.get(r)||s,a=pe.cloneDeep(b);a[r]||(a[r]={name:r,type:"text",properties:{}}),a[r].properties.content=d,z(a),j(ve(a)),Ne({template_id:T,user_id:(l=B.user)==null?void 0:l.id,deal_id:$.id,variables:a}).catch(console.error)},800)};o.useEffect(()=>()=>{rt.current.clear()},[]),o.useEffect(()=>{if(b&&Object.keys(b).length>0){const t={};Object.entries(b).forEach(([r,s])=>{var i;(i=s==null?void 0:s.properties)!=null&&i.content&&(t[r]=s.properties.content)}),Object.keys(t).length>0&&Ie(r=>({...t,...r}))}},[b]);function Yt(t){const r=t.name,{name:s,type:i}=t||{};if(!s||!i||!s.includes("__")||s.endsWith("_script"))return null;const n=s.split("__").filter(Boolean),d=n[0],a=n.slice(1);let l=null,u=null,m=null,f={},c=[];const p=[];let h=null,N=!1,A=!1,S=!1;for(const x of a)if(x==="FI")l="1 / -1",u="1 / -1",m="FI";else if(x.startsWith("P_")){const g=x==null?void 0:x.split("_");if(g.length===5){const C=+g[1],y=+g[2],D=+g[3],q=+g[4];[C,y,D,q].every(Number.isFinite)&&(l=`${C} / ${D+1}`,u=`${y} / ${q+1}`,m=`${C}-${y}-${D}-${q}`)}}else if(x.startsWith("BG_")){const g=x.replace("BG_","").trim();/^[0-9a-fA-F]{6}$/.test(g)&&(f.background=`#${g}`)}else if(x.startsWith("JL"))f.justifyContent="left";else if(x.startsWith("JR"))f.justifyContent="right";else if(x.startsWith("JC"))f.justifyContent="center";else if(x.startsWith("FR_C"))c.push("circle-frame");else if(x.startsWith("PD_")){const g=x==null?void 0:x.split("_");if(g.length===5){const C=+g[1],y=+g[2],D=+g[3],q=+g[4];[C,y,D,q].every(Number.isFinite)&&(f.padding=`${C}px ${q}px ${D}px ${y}px`)}}else if(x.startsWith("Z_")){const g=+(x==null?void 0:x.split("_")[1]);Number.isFinite(g)&&(f.zIndex=g)}else if(x.startsWith("AL_")||x.startsWith("BL_")){const g=x==null?void 0:x.split("_");if(g.length===5){const C=+g[1],y=+g[2],D=+g[3],q=+g[4];[C,y,D,q].every(Number.isFinite)&&p.push({kind:x.startsWith("AL_")?"AL":"BL",sc:C,sr:y,ec:D,er:q,gridCol:`${C} / ${D+1}`,gridRow:`${y} / ${q+1}`,raw:x})}}else if(x.startsWith("F_")){const g=x==null?void 0:x.split("_");if(g.length>=2){const C=+g[1];Number.isFinite(C)&&(h=C);const y=g[2]||"";N=y.includes("B"),A=y.includes("I"),S=y.includes("U")}}return!l&&p.length===0?null:{id:d,type:i,gridCol:l,gridRow:u,key:m,elStyle:f,classes:c,lines:p,sceneId:r,fontSize:h,bold:N,italic:A,underline:S}}function qt(t){const r=(t||"").toLowerCase();return r.startsWith("header")?"header":r.startsWith("subtitle")?"subtitle":r.startsWith("title")?"title":r.startsWith("callout")?"callout":""}function Oe(t){if(!t)return"Enter text...";let r=t;return r.includes("__")&&(r=r.split("__")[0]),r=r.replace(/_P_\d+_\d+_\d+_\d+.*$/,""),r=r.replace(/_FI.*$/,""),r=r.replace(/_BG_[a-fA-F0-9]+.*$/,""),r=r.replace(/_FR_C.*$/,""),r=r.replace(/_PD_\d+_\d+_\d+_\d+.*$/,""),r=r.replace(/_Z_\d+.*$/,""),r=r.replace(/_AL_\d+_\d+_\d+_\d+.*$/,""),r=r.replace(/_BL_\d+_\d+_\d+_\d+.*$/,""),r||t}const We=new Map,Ve=new Map,Zt=async(t,r)=>{if(We.has(t))return We.get(t);if(Ve.has(t))return Ve.get(t);r(s=>({...s,[t]:!0}));try{const s=fetch(`https://api.heygen.com/v2/avatar/${t}/details`,{method:"GET",headers:{"X-API-KEY":"sk_V2_hgu_kFHRWykcXEd_oisfR7mnYitgiX8vwtraF2NoDtg3J73V","Content-Type":"application/json"}}).then(n=>{if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return n.json()});Ve.set(t,s);const i=await s;return We.set(t,i),Ve.delete(t),i}catch(s){return console.error("Error fetching avatar details:",s),Ve.delete(t),null}finally{r(s=>({...s,[t]:!1}))}},[Ge,Qt]=o.useState({}),[er,tr]=o.useState({}),at=o.useRef(new Set),st=o.useRef(!0);o.useEffect(()=>()=>{st.current=!1},[]);const ht=o.useMemo(()=>{const t=new Set;return v.forEach(r=>{var i,n;const s=r.variables.find(d=>d.type==="character");if(s){const d=(n=(i=b[s.name])==null?void 0:i.properties)==null?void 0:n.character_id;d&&t.add(d)}}),Array.from(t)},[v,b]);o.useEffect(()=>{ht.forEach(t=>{!We.has(t)&&!Ge[t]&&!at.current.has(t)&&(at.current.add(t),Zt(t,tr).then(r=>{st.current&&r&&Qt(s=>({...s,[t]:r}))}).catch(r=>{st.current&&(console.error("Failed to fetch avatar details:",r),at.current.delete(t))}))})},[ht]);function rr(t,r=!1){var C,y,D,q,At,St;const{id:s,type:i,elStyle:n={},classes:d=[],sceneId:a,fontSize:l,bold:u,italic:m,underline:f}=t;if(i==="image")return n.background?e.jsx("div",{className:"sceneblock",style:{padding:n.padding,zIndex:n.zIndex},children:e.jsx("div",{className:"image",style:{background:n.background}})},s):e.jsx(Lr,{sceneId:a,elStyle:n,classes:d,videoVariables:b,setVideoVariables:z,dispatch:j,templateId:T,user:B,deal:$},s);if(i==="character"){const Z=v.find(be=>be.variables.some(Xe=>Xe.name===a));if(!Z)return console.warn("Could not find scene for avatar:",a),null;const ge=Z.id,Q=Z.variables.find(be=>be.type==="character"),$e=(Q==null?void 0:Q.name)||a,ce=(y=(C=b[$e])==null?void 0:C.properties)==null?void 0:y.character_id,_e=(q=(D=b[$e])==null?void 0:D.properties)==null?void 0:q.image,se=oe[ge]||{x:0,y:0,scale:1};console.log("Rendering avatar:",{variableName:a,actualSceneId:ge,characterVarName:$e,transformState:se,allTransforms:oe});const de=ee.find(be=>be.avatar_id===ce)||ee.find(be=>{const Xe=U.find(xr=>xr.id===a);return Xe&&be.avatar_id===Xe.properties.character_id}),fr=_e||((St=(At=Ge[ce])==null?void 0:At.data)==null?void 0:St.preview_image_url)||(de==null?void 0:de.preview_image_url)||`https://investier.visionvivante.in/storage/profile/images/default-avatar.png?text=${encodeURIComponent(s)}`;return er[ce],e.jsx("div",{className:"sceneblock relative overflow-visible",children:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{transform:`translate(${se.x*50}%, ${se.y*50}%) scale(${se.scale})`,transformOrigin:"center center",transition:"transform 0.2s ease-out"},children:e.jsx("img",{src:fr,alt:s,className:"w-full h-full object-cover cursor-pointer",onClick:()=>{ke(ge),Te(!0)}})})})}const[c,p]=o.useState({}),h=(Z="")=>Z.trim().split(/\s+/).filter(Boolean).length,N=Z=>Z&&Z.split("__")[0],A=Z=>{const ge=Z.currentTarget,Q=ge.id,$e=N(Q),ce=ge.textContent.trim(),_e=Number(re==null?void 0:re[$e]);if(_e>0&&h(ce)>_e){K(`Maximum ${_e} word${_e>1?"s":""} allowed`,"error"),ge.textContent=mt.current[Q]||Oe(Q);return}const se=pe.cloneDeep(b);se[Q]||(se[Q]={properties:{}}),se[Q].properties.content=ce,z(se),j(ve(se)),Ie(de=>({...de,[Q]:ce})),Gt(Q,ce,se),p(de=>({...de,[Q]:!0}))},S=["cc_titleplaceholder","cc_hero_cc","cc_img","cc_ds_name_cc","cc_phone_cc","cc_email_cc"],x=/^cc_plh\d+_cc/.test(a),g=!r&&(x||S.some(Z=>a.startsWith(Z))||!a.startsWith("cc_"));return e.jsx("div",{contentEditable:g,suppressContentEditableWarning:!0,id:a,className:`text ${qt(a)}`,style:{...n},onFocus:()=>Mt(a),onBlur:A,children:lt[a]||Oe(a)},a)}function gt(t){const r=t.match(/__VP_(\d+)$/);return r?parseInt(r[1],10):1/0}function bt({scene:t,index:r,isThumbnail:s=!1}){const i=o.useMemo(()=>(t.variables||[]).map(Yt).filter(Boolean),[t]),n=o.useMemo(()=>{const d=new Map;for(const a of i)a.key&&(d.has(a.key)||d.set(a.key,[]),d.get(a.key).push(a));for(const[a,l]of d.entries())l.sort((u,m)=>{const f=gt(u.sceneId),c=gt(m.sceneId);return f-c});return d},[i]);return e.jsxs("div",{className:"scene-root",children:[!s&&e.jsxs("div",{className:"scene-badge",children:["Scene ",r+1]}),e.jsxs("div",{className:"grid",children:[[...n.entries()].map(([d,a])=>e.jsx("div",{className:"area-wrapper",style:{gridColumn:a[0].gridCol,gridRow:a[0].gridRow},children:a.map(l=>rr(l,!1))},d)),i.flatMap(d=>(d.lines||[]).map((a,l)=>{const u=a.sc===a.ec,m=a.sr===a.er,f={gridColumn:a.gridCol,gridRow:a.gridRow,display:"flex",width:"100%",height:"100%",boxSizing:"border-box",pointerEvents:"none",zIndex:30};return u?e.jsx("div",{className:"line-wrapper",style:{...f,justifyContent:a.kind==="BL"?"flex-start":"flex-end",alignItems:"stretch"},children:e.jsx("div",{style:{width:2,height:"100%",background:a.kind==="AL"?"#0b1220":"#6b7280",opacity:a.kind==="AL"?1:.9}})},`${a.raw}-${l}`):m?e.jsx("div",{className:"line-wrapper",style:{...f,alignItems:a.kind==="BL"?"flex-start":"flex-end",justifyContent:"stretch"},children:e.jsx("div",{style:{height:3,width:"100%",background:a.kind==="AL"?"#0b1220":"transparent",borderTop:a.kind==="BL"?"2px dashed #6b7280":void 0}})},`${a.raw}-${l}`):e.jsx("div",{className:"line-wrapper",style:{...f,alignItems:"center",justifyContent:"center"},children:e.jsx("div",{style:{height:2,width:"100%",background:"#0b1220"}})},`${a.raw}-${l}`)}))]})]})}o.useEffect(()=>{const t=r=>{const s=document.activeElement,i=["TEXTAREA","INPUT"],n=s==null?void 0:s.isContentEditable,d=s==null?void 0:s.closest('[contenteditable="true"]');r.shiftKey||i.includes(s==null?void 0:s.tagName)||n||d||E.length&&(r.key==="ArrowLeft"&&(r.preventDefault(),xe(a=>(a-1+E.length)%E.length)),r.key==="ArrowRight"&&(r.preventDefault(),xe(a=>(a+1)%E.length)))};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[E.length]),o.useEffect(()=>{if(E.length===0)return;const t=E[ae];if(!t)return;const r=document.querySelector(`div[data-scene-id="${t.id}"]`);r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),r.style.transition="background 0.4s",r.style.background="rgba(108, 93, 211, 0.12)",setTimeout(()=>{r.style.background=""},800))},[ae,E]);const[ar,sr]=o.useState([]),[nr,ir]=o.useState(new Set),[or,vt]=o.useState(!0);o.useEffect(()=>{(async()=>{var r,s;try{vt(!0);const i=await Sr(),d=(((r=i==null?void 0:i.data)==null?void 0:r.data)||[]).filter(m=>m.active===1||m.active==="1").map(m=>({voice_id:m.Voice_id||m.voice_id,name:m.Voice_name||m.voice_name||"Unnamed Voice",gender:m.Female===!0||m.Female==="x"||m.female===!0||m.female==="x"?"female":"male",preview_url:m.preview_url||null,source:"custom"}));sr(d),j(Er(d));const l=await(await fetch("https://api.heygen.com/v2/voices",{headers:{"Content-Type":"application/json","X-API-KEY":"sk_V2_hgu_kFHRWykcXEd_oisfR7mnYitgiX8vwtraF2NoDtg3J73V"}})).json(),u=new Set((((s=l==null?void 0:l.data)==null?void 0:s.voices)||[]).map(m=>m.voice_id));ir(u)}catch(i){console.error("Voice load error:",i)}finally{vt(!1)}})()},[j]);const Ue=o.useRef(null),yt=t=>{if(Ze===t.voice_id){Ue.current.pause(),ze(null);return}Ue.current&&Ue.current.pause();const r=new Audio(t.preview_audio);Ue.current=r,r.play(),ze(t.voice_id),r.onended=()=>ze(null)};o.useEffect(()=>{const t={};Re.forEach(r=>{r.scripts.forEach(s=>{const i=`${r.id}-${s.name}`;!dt[i]&&Ae.length>0&&(t[i]=Ae[0])})}),Object.keys(t).length>0&&Fe(r=>({...r,...t}))},[Re,Ae]);const lr=(t,r)=>{Se(s=>({...s,[t]:!s[t]})),P(r),he(null)},wt=t=>{he(r=>r===t?null:t),Se({})},nt=o.useRef(null),jt=o.useRef({});o.useEffect(()=>{function t(r){const s=document.querySelectorAll("[data-avatar-button]"),i=Array.from(s).some(u=>u.contains(r.target)),n=document.querySelectorAll("[data-voice-button]"),d=Array.from(n).some(u=>u.contains(r.target));i||d||nt.current&&nt.current.contains(r.target)||Object.values(jt.current).some(u=>u&&u.contains(r.target))||r.target.closest(".right, .slider, .thumbnail-slider")||(Se({}),he(null))}return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[]);const cr=async(t,r=null)=>{var d,a,l,u,m,f;const s=r||we;if(!s){console.error("No scene to update");return}const i=v.find(c=>c.id===s),n=i==null?void 0:i.variables.find(c=>c.type==="character");if(n){const c=[];v.forEach(S=>{var g;const x=((g=S==null?void 0:S.variables)==null?void 0:g.filter(C=>C.type==="character"))||[];c.push(...x)});const p=c.findIndex(S=>S.name===n.name);let h=tt[p];h||(h={offset:{x:0,y:0},scale:1});const N=p===c.length-1,A=pe.cloneDeep(b);A[n.name]={...A[n.name],properties:{...(d=A[n.name])==null?void 0:d.properties,character_id:t.avatar_id||t.id,image:t.image_url||t.preview_image_url,offset:((l=(a=A[n.name])==null?void 0:a.properties)==null?void 0:l.offset)??h.offset,scale:((m=(u=A[n.name])==null?void 0:u.properties)==null?void 0:m.scale)??h.scale,...N?{avatar_style:"circle"}:{}}},z(A),j(ve(A));try{await Ne({template_id:T,user_id:(f=B.user)==null?void 0:f.id,deal_id:$.id,variables:A})}catch(S){console.error("Error saving avatar",S)}}},dr=t=>{if(!(t>=Ye&&t<Ye+Ce)){const s=Math.max(0,t-Math.floor(Ce/2)),i=Math.max(0,E.length-Ce),n=Math.min(s,i);qe(n)}};o.useEffect(()=>{dr(ae)},[ae,Ce,E.length]),o.useEffect(()=>{console.log("videoVariables updated",b)},[b]);const ur=async t=>{try{const s=await(await fetch("https://api.heygen.com/v2/avatar_group.list?include_public=true",{method:"GET",headers:{"Content-Type":"application/json","X-API-KEY":"sk_V2_hgu_kFHRWykcXEd_oisfR7mnYitgiX8vwtraF2NoDtg3J73V"}})).json();j(Vr(s.data.avatar_group_list))}catch(r){console.error("API error:",r)}finally{}};o.useEffect(()=>{ur()},[]);const[Ur,_t]=o.useState(!1),[Xr,Nt]=o.useState(null),pr=async t=>{var r;try{_t(!0),Nt(null);const s=await fetch(`https://api.heygen.com/v2/avatar_group/${t}/avatars`,{method:"GET",headers:{"X-Api-Key":"sk_V2_hgu_kFHRWykcXEd_oisfR7mnYitgiX8vwtraF2NoDtg3J73V"}});if(!s.ok)throw new Error(`API call failed: ${s.status}`);const n=((r=(await s.json()).data)==null?void 0:r.avatar_list)||[];W(n)}catch(s){console.error("Error fetching avatar group:",s),Nt(s.message)}finally{_t(!1)}},kt=async()=>{var t,r;try{ie(!0);const s={userId:(t=B.user)==null?void 0:t.id,dealId:$.id},n=(r=(await $r(s)).data)==null?void 0:r.data;if(!n)return;De(d=>d.map(a=>{const l=a.scripts.map(u=>({...u,value:n[u.name]||u.value}));return{...a,scripts:l}}))}catch(s){console.error("Error fetching scripts:",s)}finally{ie(!1)}},[it,mr]=o.useState([]);return o.useEffect(()=>{if(we){const t=["PUBLIC_PHOTO","PUBLIC","COMMUNITY_PHOTO"],s=te.filter(i=>{var n;return t.includes((n=i.group_type)==null?void 0:n.trim().toUpperCase())}).sort(()=>Math.random()-.5).slice(0,4);mr(s)}},[we,te]),o.useEffect(()=>{console.log("avatarTransforms state changed:",oe)},[oe]),o.useEffect(()=>{var t;console.log("currentIndex changed to:",ae),console.log("Active scene:",E[ae]),console.log("Active transform:",oe[(t=E[ae])==null?void 0:t.id])},[ae,E,oe]),e.jsxs(e.Fragment,{children:[e.jsx(Mr,{loading:ye}),e.jsxs("div",{className:"flex items-center justify-between bg-white dark:bg-[#121212] text-white px-4 py-3 shadow-md rounded-lg mb-1 container mx-auto hide-in-landscape",children:[e.jsxs("button",{onClick:()=>V("/deal-view-ai-video-generator"),className:"flex items-center gap-2 text-lg font-semibold text-black dark:text-white  transition",children:[e.jsx(Ir,{className:"text-xl"}),e.jsx("span",{children:"Back"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-around gap-3 md:gap-8 relative",children:[e.jsx(_r,{}),e.jsx("button",{className:"bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition",onClick:Ht,children:"Reset"}),e.jsx("button",{className:"bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition",onClick:Xt,children:"Generate"}),e.jsx(Dr,{show:_,onClose:()=>k(!1),modalTitle:Ke,modalMessage:He,showProgress:X})]})]}),e.jsxs("div",{className:"app-root",children:[e.jsx("style",{children:`
            :root{
          --slide-radius: 18px;
          --gap: 10px;
          --card-bg: #ffffff;
          --app-bg: #0f1220;
          --shadow: 0 10px 30px rgba(0,0,0,.35);
          --text-soft:#6b7280;
          --text-strong:#111827;
        }
        .app-root{ min-height:60vh;  align-items:center; justify-content:center; padding:24px; box-sizing:border-box; background: #FDFDFD; }
       
        .dark .app-root{
        background:#121212
        }
          font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
          color:var(--text-strong);
        }
           .app-root {
          var(--app-bg);
          font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
          color:var(--text-strong);
          }
        .layout{ width:100%; max-width:1200px; display:flex; background-color:#FDFDFD }
        textarea{ width: 100%; }
        // .left{ color:#fff; width: 100%; min-width: 400px; background:white; box-shadow: var(--shadow); border-radius:15px; }
          .left{ color:#fff; width: 100%; min-width: 400px;}
        .right{ flex:1; display:flex; align-items:center; justify-content:center; }
        .slider{ position:relative; width: min(92vw, 700px); aspect-ratio: 12 / 6; background: var(--card-bg); border-radius: var(--slide-radius); overflow:hidden; margin: auto; }
        .scene-root{height:100% ; background: #F3F3F3; }
        .slide{ position:absolute; inset:0; opacity:0; pointer-events:none; transition: opacity .45s ease;  box-sizing:border-box; }
        .slide.active{ opacity:1; pointer-events:auto; }
        .grid{ display:grid; grid-template-columns: repeat(12, 1fr); grid-template-rows: repeat(6, 1fr);  width:100%; height:100%; }
        .area-wrapper{ display:grid; grid-auto-rows: 1fr; width:100%; height:100%; border-radius: 12px; overflow:hidden; position:relative; }
        .sceneblock{ display:flex; align-items:center; justify-content:center; width:100%; height:100%; box-sizing:border-box; position:relative; margin:4px; max-width: 100%; max-height: 100%; overflow: hidden; text-align: center; z-index: 9; }
        .text{ padding: 12px 14px; color: var(--text-strong); width: calc(100% - 4px); height: calc(100% - 4px); margin: 2px; display:flex; align-items:center; justify-content:center; text-align:center; font-size: 14px; line-height: 1.4; color: #222; word-wrap: break-word; word-break: break-word; white-space: normal; overflow: hidden; text-overflow: ellipsis; max-width: 100%; max-height: 100%; }
        .text:focus { outline: none; border: none;}
        .text.header{ font-weight: 800; font-size: clamp(16px, 2vw, 22px); }
        .text.subtitle{ font-weight: 600; font-size: clamp(14px, 1.6vw, 18px); color: var(--text-soft); }
        .text.title{ font-weight: 700; font-size: clamp(15px, 1.8vw, 20px); }
        .text.callout{ font-weight: 700; font-size: clamp(14px, 1.6vw, 18px); border-color:#ffe6b3; }
        .image{ width:100%; height:100%; overflow:hidden; border-radius: 12px; }
        .image > img{ width:100%; height:100%; object-fit: cover; display:block; }
        .avatar{ width: 100%; display: contents; }
        .avatar img{ height: 100%; }
        .circle-frame, .circle-frame > img{ border-radius: 50% !important; width: 100%; height: 100%; object-position: top; background-color: #fff; object-fit: cover; }
       .nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 50%;
    background: rgba(0, 0, 0, .55);
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    z-index: 20;
}
        .nav.prev{ left:14px; }
        .nav.next{ right:14px; }
        .scene-badge{ position:absolute; right:16px; top:14px; background: rgba(17,24,39,.75); color:#fff; font-size:12px; padding:6px 10px; border-radius:999px; z-index: 20; }
        .line-wrapper { display:flex; align-items:center; justify-content:stretch; pointer-events:none; z-index:20; }
        .error{ color:#fecaca; background:#7f1d1d; border:1px solid #fecaca33; padding:8px 10px; margin:8px 0; border-radius:8px; font-size:12px; }
        .controls{ display:flex; gap:8px; align-items:center; margin-top:8px; }
        .btn{ background:#111827; color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; box-shadow: 0 6px 16px rgba(0,0,0,.25); }
        .btn:active{ transform: translateY(1px); }
        textarea{color:#000}
        .thumbnail .avatar img { pointer-events: none; cursor: default; }
 .thumbnail .image,
.thumbnail .image img {
  pointer-events: none;
  cursor: default;
}
  /* Add these new rules to your existing CSS */
.thumbnail .text {
  padding: 6px 7px;
  font-size: 7px;
  line-height: 1.2;
}

.thumbnail .text.header {
  font-size: clamp(8px, 1vw, 11px);
}

.thumbnail .text.subtitle {
  font-size: clamp(7px, 0.8vw, 9px);
}

.thumbnail .text.title {
  font-size: clamp(7.5px, 0.9vw, 10px);
}

.thumbnail .text.callout {
  font-size: clamp(7px, 0.8vw, 9px);
}

.thumbnail .sceneblock {
  margin: 2px;
}
  @media (max-width: 768px) {
    .layout {
      flex-direction: column;
    }
    .left {
      min-width: 100%;
      margin-bottom: 20px;
    }
    .right {
      width: 100%;
      margin-top: 20px;
    }
  } 
    @media(max-width:579px){
    .app-root {
    padding: 94px}
    }
     @media(max-width:768px){
    .app-root {
    padding: 94px}
    }

    @media (orientation: landscape) and (max-width:579px) {
  .hide-in-landscape {
    display: none;
  }


}
  @media (max-width: 820px) {
  .app-root {
   padding: 147px 24px;
  }

  @media (max-width: 768px) {
  .scene-root {
    font-size: 13px;
  }

}

 @media (max-width:579px) {
  .scene-root {
    font-size: 7px;
  }

  .scene-badge {
    font-size: 7px;
    padding: 4px 8px;
  }

  .slider .text {
  padding: 6px 7px;
  font-size: 7px;
  line-height: 1.2;
}
}


@media (max-width: 768px) {
  /* General text inside the main scene */
  .slider .text {
    font-size: 10px;
    line-height: 1.3;
    padding: 8px 10px;
  }


  .slider .text.header {
    font-size: clamp(11px, 2vw, 14px);
  }

  .slider .text.subtitle {
    font-size: clamp(10px, 1.8vw, 13px);
  }

  .slider .text.title {
    font-size: clamp(10.5px, 1.9vw, 13.5px);
  }

  .slider .text.callout {
    font-size: clamp(10px, 1.8vw, 12.5px);
  }

  .scene-badge {
    font-size: 10px;
    padding: 4px 8px;
  }
}


@media (max-width: 579px) {
  .slider .text {
    font-size: 8.5px;
    line-height: 1.3;
  }

  .slider .text.header {
    font-size: clamp(9px, 2.2vw, 12px);
  }

  .slider .text.subtitle,
  .slider .text.title,
  .slider .text.callout {
    font-size: clamp(8px, 2vw, 11px);
  }

  .scene-badge {
    font-size: 8px;
  }
}


.sceneblock {
  overflow: visible !important; /* Critical: stops clipping */
}
.area-wrapper {
  overflow: visible !important;
}
.grid {
  overflow: visible !important;
}
.scene-root {
  overflow: visible !important;
}
.slider {
  overflow: visible !important; /* Allows avatar to move outside slide bounds */
}

.grid,
.area-wrapper,
.sceneblock,
.scene-root,
.slider {
  overflow: visible !important;
}

.sceneblock img {
  max-width: none !important; /* Already have this, but reinforce */
}
  /* Add these rules at the end of your style block */
.slider,
.scene-root,
.grid,
.area-wrapper,
.sceneblock {
  overflow: visible !important;
}

.sceneblock img {
  max-width: none !important;
}

      `}),e.jsxs("div",{className:"layout container mx-auto",children:[e.jsx("button",{onClick:()=>pt(!Me),className:"lg:hidden fixed bottom-6 right-6 z-50 bg-[#6C5DD3] text-white p-3 px-5 rounded-md shadow-lg hover:bg-[#5a4bc4] transition-all duration-200","aria-label":"Toggle Script Panel",children:Me?e.jsx(Fr,{className:"w-6 h-6"}):"Scripts"}),e.jsxs("div",{className:`
        lg:hidden fixed inset-x-0 bottom-0 w-full h-full max-h-[85vh]
        bg-white dark:bg-gray-900 rounded-t-3xl shadow-2xl z-40 overflow-y-auto
        transform transition-transform duration-300 ease-in-out
        ${Me?"translate-y-0":"translate-y-full"}
      `,children:[e.jsx("div",{className:"sticky top-0 pt-4 pb-3 flex justify-center bg-inherit z-10",children:e.jsx("div",{className:"w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full"})}),e.jsxs("div",{className:"p-4 pb-24",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h4",{className:"text-black font-semibold text-lg",children:"Script"}),e.jsx("button",{onClick:kt,disabled:J,className:`bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition flex items-center gap-2 ${J?"opacity-70 cursor-not-allowed":"hover:bg-[#5a4bc4]"}`,children:J?"Generating...":"Generate Scripts"})]}),e.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"62vh"},children:Re.map((t,r)=>e.jsx("div",{className:"mb-6 border border-gray-200 dark:border-gray-700 rounded-xl p-4 shadow-sm bg-white dark:bg-gray-800",children:t.scripts.map(s=>{const i=`${t.id}-${s.name}`;return e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"flex gap-3 items-start flex-col",children:[(()=>{var m,f,c,p;const n=v.find(h=>h.id===t.id),d=n==null?void 0:n.variables.find(h=>h.type==="character");if(!d)return null;const a=b[d.name],l=(m=a==null?void 0:a.properties)==null?void 0:m.character_id,u=((c=(f=Ge[l])==null?void 0:f.data)==null?void 0:c.preview_image_url)||((p=ee.find(h=>h.avatar_id===l))==null?void 0:p.preview_image_url)||ne;return e.jsxs("button",{onClick:()=>wt(t.id),className:"flex items-center gap-2 px-3 py-2 border rounded-lg hover:shadow-md transition",children:[e.jsx("img",{src:u,alt:"Avatar",className:"w-8 h-8 rounded-full object-cover"}),e.jsx(ot,{className:"text-sm"})]})})(),e.jsx("div",{className:"flex-1 space-y-3 w-full"})]})},i)})},t.id))})]})]}),e.jsx("div",{className:`
  hidden lg:block lg:relative h-full lg:w-auto w-full left fixed
  bg-white dark:bg-[#121212] z-40
  overflow-y-auto
`,children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h4",{className:"text-black dark:text-[#F8F8F8]",children:"Script"}),e.jsx("button",{className:`bg-[#6C5DD3] text-white px-5 py-3 rounded-xl transition flex items-center justify-center gap-2 mb-4 ${J?"opacity-70 cursor-not-allowed":""}`,onClick:kt,disabled:J,children:J?"Generating...":"Generate Scripts"})]}),e.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"70vh",padding:"10px"},children:Re.map((t,r)=>{var i;return(((i=v[r])==null?void 0:i.variables)||[]).filter(n=>n.type==="character"),e.jsx("div",{"data-scene-id":t.id,onFocus:()=>xe(r),className:"mb-6 border border-gray-200 dark:border-[#181818] rounded-xl p-4 shadow-sm bg-white dark:bg-[#121212] focus-within:ring-2 focus-within:ring-[#6C5DD3] focus-within:outline-none",children:t.scripts.map((n,d)=>{const a=`${t.id}-${n.name}`,l=dt[a];return ut[a],e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 justify-start",children:[(()=>{const u=v.find(c=>c.id===t.id),m=u==null?void 0:u.variables.find(c=>c.type==="character");return m&&b[m.name]?e.jsxs("div",{className:"relative inline-block",children:[e.jsxs("button",{"data-avatar-button":"true",onClick:()=>wt(t.id),className:"flex items-center justify-between px-4 py-2 border border-gray-300 bg-white text-black dark: font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 w-auto",children:[(()=>{var x,g,C;const c=v.find(y=>y.id===t.id),p=c==null?void 0:c.variables.find(y=>y.type==="character");if(!p)return e.jsx("span",{className:"text-sm",children:"No Character"});const h=b[p.name],N=(x=h==null?void 0:h.properties)==null?void 0:x.character_id,A=ee.find(y=>y.avatar_id===N),S=((C=(g=Ge[N])==null?void 0:g.data)==null?void 0:C.preview_image_url)||(A==null?void 0:A.preview_image_url)||ne;return e.jsx("img",{src:S,alt:"Avatar",className:"w-6 h-6 rounded-full object-cover",onError:y=>{y.target.src=ne}})})(),e.jsx(ot,{className:"ml-2 text-black flex-shrink-0"})]}),we===t.id&&e.jsxs("div",{ref:nt,className:"absolute left-0 mt-2 w-80 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl z-50",children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-200 dark:border-gray-700",children:F&&F.length>0?e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("button",{onClick:()=>{O?je(null):W([])},className:"flex items-center gap-1 text-sm font-medium text-purple-600 hover:text-purple-800 transition-colors duration-200",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"Back"]})}):e.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Select Avatar"})}),e.jsx("div",{className:"flex items-center justify-center my-4",children:e.jsx("div",{className:`flex justify-center gap-3 ${F&&F.length>0&&!O?"overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent":""}`,children:F&&F.length>0&&O?e.jsxs("div",{className:"flex flex-col items-center justify-center w-full px-4",children:[e.jsx("div",{className:"relative w-24 h-24 rounded-full overflow-hidden border-2 border-purple-500 ring-2 ring-purple-200",children:e.jsx("img",{src:O.preview_image_url??O.image_url??O.image,alt:"Selected avatar",className:"w-full h-full object-cover",onError:c=>c.currentTarget.src=ne})}),e.jsxs("div",{className:"mt-3 text-center",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:O.name||O.avatar_name||`Avatar ${O.avatar_id??O.id}`}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Ready to apply"})]})]}):F&&F.length>0?F.map((c,p)=>{const h=v.find(S=>S.id===t.id);if(!(h==null?void 0:h.variables.find(S=>S.type==="character")))return null;const A=(c==null?void 0:c.image_url)||(c==null?void 0:c.preview_image_url);return e.jsx("div",{className:"flex flex-col items-center flex-shrink-0",children:e.jsx("button",{onClick:()=>{je(c)},className:"relative w-16 h-16 rounded-full overflow-hidden border-2 border-gray-200 hover:border-purple-300 hover:ring-2 hover:ring-purple-100 transition-all duration-200 flex-shrink-0",children:A?e.jsx("img",{src:A,alt:`Avatar ${p+1}`,className:"w-full h-full object-cover",onError:()=>console.error("Failed to load avatar image:",A)}):e.jsx("div",{className:"w-full h-full bg-gray-100 flex items-center justify-center text-gray-400",children:e.jsx("svg",{className:"w-8 h-8",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z",clipRule:"evenodd"})})})})},`modal_${p}`)}):it&&it.length>0?it.map((c,p)=>{var C;const h=v.find(y=>y.id===t.id),N=h==null?void 0:h.variables.find(y=>y.type==="character");if(!N)return null;const A=b[N.name],S=(C=A==null?void 0:A.properties)==null?void 0:C.character_id,x=c.preview_image||c.image,g=S===c.avatar_id;return e.jsx("div",{className:"flex flex-col items-center",children:e.jsx("button",{onClick:async()=>{const y=c.id||c.avatar_id;try{await pr(y)}catch(D){console.error("Error fetching avatars:",D)}},className:`relative w-16 h-16 rounded-full overflow-hidden border-2 transition-all duration-200 flex-shrink-0 ${g?"border-purple-500 ring-2 ring-purple-200":"border-gray-200 hover:border-purple-300 hover:ring-2 hover:ring-purple-100"}`,children:x?e.jsx("img",{src:x,alt:c.name||`Avatar ${p+1}`,className:"w-full h-full object-cover",onError:()=>console.error("Failed to load avatar image:",x)}):e.jsx("div",{className:"w-full h-full bg-gray-100 flex items-center justify-center text-gray-400",children:e.jsx("svg",{className:"w-8 h-8",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z",clipRule:"evenodd"})})})})},c.avatar_id||c.id||p)}):e.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:[e.jsx("div",{className:"text-2xl mb-2",children:"ðŸ‘¤"}),e.jsx("p",{className:"text-sm",children:"No avatars available"})]})})}),e.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 p-3",children:F&&F.length>0&&O?e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:async()=>{await cr(O,t.id),he(null),W([]),je(null)},className:"flex-1 px-4 py-2 text-sm font-medium text-[#6C5DD3] bg-white rounded-md transition-colors duration-200 border border-purple-200 hover:border-purple-300 flex items-center justify-center gap-2",children:"Apply One"}),e.jsx("button",{onClick:async()=>{var h,N;if(!O)return;const c={avatar_id:O.avatar_id??O.id,preview_image_url:O.preview_image_url??O.image_url},p=pe.cloneDeep(b);for(const A of v){const S=A.variables.find(x=>x.type==="character");S&&(p[S.name]={...p[S.name],properties:{...(h=p[S.name])==null?void 0:h.properties,character_id:c.avatar_id,image:c.preview_image_url}})}z(p),j(ve(p)),await Ne({template_id:T,user_id:(N=B.user)==null?void 0:N.id,deal_id:$.id,variables:p}),he(null),W([]),je(null)},className:"flex-1 px-4 py-2 text-sm font-medium text-white bg-[#6C5DD3] rounded-md transition-colors duration-200 flex items-center justify-center gap-2",children:"Apply to All"})]}):F&&F.length>0?e.jsx("p",{className:"text-xs text-center text-gray-500 dark:text-gray-400 py-2",children:"Select an avatar above to continue"}):e.jsx("button",{onClick:()=>{const c=v.find(h=>h.id===t.id),p=c==null?void 0:c.variables.find(h=>h.type==="character");ke(p?p.name:t.id),Te(!0),he(null)},className:"w-full px-4 py-2 text-sm font-medium text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-md transition-colors duration-200 border border-purple-200 hover:border-purple-300",children:"View All Avatars"})})]})]}):null})(),(()=>{var p,h;const u=a.match(/scene_(\d+)_script/);if(!u)return null;const f=`voice_id_${u[1]}`;return((h=(p=b[f])==null?void 0:p.properties)==null?void 0:h.voice_id)?e.jsxs("div",{className:"relative inline-block w-1/2",children:[e.jsxs("button",{"data-voice-button":"true",onClick:()=>lr(a,a),className:"flex items-center justify-between px-4 py-2 border dark:border-[#181818] rounded-lg dark:bg-[#121212] shadow-md transition text-left text-black dark:text-white w-full",children:[e.jsx("span",{className:"truncate max-w-[70%]",children:(()=>{var C,y;const N=a.match(/scene_(\d+)_script/);if(!N)return(l==null?void 0:l.name)||"Select AI Voice";const S=`voice_id_${N[1]}`,x=(y=(C=b[S])==null?void 0:C.properties)==null?void 0:y.voice_id,g=Ae.find(D=>D.voice_id===x)||l;return(g==null?void 0:g.name)||"Select AI Voice"})()}),e.jsx(ot,{className:"ml-2 text-gray-500 shrink-0"})]}),ut[a]&&l&&e.jsxs("div",{ref:N=>jt.current[a]=N,className:"absolute mt-2 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg z-50 p-2 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center justify-around my-1",children:[e.jsx("button",{onClick:()=>yt(l),className:"px-3 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 rounded-lg transition flex items-center justify-center",children:Ze===(l==null?void 0:l.voice_id)?e.jsx(Et,{className:"text-lg text-purple-600"}):e.jsx(Vt,{className:"text-lg text-purple-600"})}),e.jsx("span",{className:"text-sm text-center text-black font-medium",children:(()=>{var C,y;const N=a.match(/scene_(\d+)_script/);if(!N)return l==null?void 0:l.name;const S=`voice_id_${N[1]}`,x=(y=(C=b[S])==null?void 0:C.properties)==null?void 0:y.voice_id,g=Ae.find(D=>D.voice_id===x)||l;return(g==null?void 0:g.name)||"Select AI Voice"})()})]}),e.jsx("button",{onClick:()=>{Pt(a),Se(N=>({...N,[a]:!1}))},className:"w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition",children:"View All"})]})]}):null})()]}),(()=>{var u;return(u=n.value)!=null&&u.trim().split(/\s+/).filter(Boolean).length,e.jsxs(e.Fragment,{children:[e.jsx("textarea",{rows:4,value:n.value,onFocus:()=>xe(r),onChange:m=>Jt(t.id,n.name,m.target.value),placeholder:"Write your script here...",className:`w-full p-3 rounded-lg shadow-sm resize-none focus:outline-none transition
          dark:border-gray-600 dark:bg-gray-800 text-black dark:text-white
          ${Le[n.name]?"border border-red-500":""}`}),Le[n.name]&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:Le[n.name]}),e.jsxs("p",{className:`text-xs mt-1 ${et(n.value)>Be?"text-red-500":"text-gray-400"}`,children:[et(n.value)," / ",Be," words"]})]})})()]},a)})},t.id)})})]})}),Me&&e.jsx("div",{className:"lg:hidden fixed inset-0 bg-black bg-opacity-50 z-30",onClick:()=>pt(!1)}),e.jsx("div",{className:"right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"flex-1 flex items-center justify-center lg:block",children:e.jsx("div",{className:"w-full px-4 lg:px-0",children:e.jsxs("div",{className:"slider",children:[e.jsx("button",{className:"nav prev",onClick:()=>E.length&&xe(t=>(t-1+E.length)%E.length),"aria-label":"Previous",children:"â®"}),e.jsx("button",{className:"nav next",onClick:()=>E.length&&xe(t=>(t+1)%E.length),"aria-label":"Next",children:"â¯"}),E.map((t,r)=>e.jsx("div",{className:`slide ${r===ae?"active":""}`,children:e.jsx(bt,{scene:t,index:r})},t.id||r))]})})}),e.jsx("div",{className:"fixed bottom-20 left-0 right-0 lg:relative lg:bottom-auto lg:left-auto lg:right-auto lg:mt-3 hide-in-landscape",children:e.jsxs("div",{className:"thumbnail-slider flex items-center justify-center relative px-4 lg:px-0 bg-white dark:bg-[#121212] lg:py-0 lg:bg-transparent",children:[e.jsx("button",{className:"thumb-nav prev",onClick:()=>qe(t=>Math.max(t-1,0)),children:"â®"}),e.jsx("div",{className:"thumbnails-wrapper overflow-hidden w-full sm:w-[750px]",children:e.jsx("div",{className:"thumbnails-track flex transition-transform duration-300",style:{transform:`translateX(-${Ye*It}px)`},children:E.map((t,r)=>e.jsx("div",{className:`thumbnail ${r===ae?"active":""} 
                w-[100px] h-[60px] sm:w-[140px] sm:h-[80px] mr-2`,onClick:s=>{var i;s.stopPropagation(),xe(r),(i=document.getElementById(`textarea-${t.id}`))==null||i.scrollIntoView({behavior:"smooth",block:"center"})},children:e.jsx(bt,{scene:t,index:r,isThumbnail:!0})},t.id||r))})}),e.jsx("button",{className:"thumb-nav next",onClick:()=>qe(t=>Math.min(t+1,E.length-Ce)),children:"â¯"})]})}),e.jsx("div",{className:"mt-4 flex justify-center z-40 relative",children:Ee&&(console.log("Rendering controls for:",{activeSceneId:Ee,activeTransform:Pe,allTransforms:oe}),e.jsx(Pr,{x:Pe.x,y:Pe.y,scale:Pe.scale,onMove:t=>{console.log("onMove called with:",t),ft(Ee,t)},onScale:t=>{console.log("onScale called with:",t),ft(Ee,{scale:t})}}))})]})})]}),ct&&e.jsx(zr,{show:ct,onClose:()=>{Te(!1),ke(null)},avatars:Ot,VideoScenes:v,activeBlock:$t,videoVariables:b,onSelect:async(t,r)=>{var d;const s=pe.cloneDeep(b),i=[];v.forEach(a=>{var u;const l=((u=a==null?void 0:a.variables)==null?void 0:u.filter(m=>m.type==="character"))||[];i.push(...l)});const n=a=>{var N,A,S,x,g,C;const l=a==null?void 0:a.trim();let u=v.find(y=>y.id===l);if(u||(u=v.find(y=>y.variables.some(D=>D.name===l||D.name.startsWith(l)))),!u){if(b[l]){s[l]={...s[l],properties:{...(N=s[l])==null?void 0:N.properties,character_id:t.avatar_id,image:t.preview_image_url}};return}console.error("[Parent] Could not find scene or variable for:",l);return}const m=u.variables.find(y=>y.type==="character");if(!m){console.warn(`[Parent] No character variable in scene ${u.id}`);return}const f=m.name,c=i.findIndex(y=>y.name===f);let p=tt[c];p||(p={offset:{x:0,y:0},scale:1});const h=c===i.length-1;s[f]={...s[f],properties:{...(A=s[f])==null?void 0:A.properties,character_id:t.avatar_id,image:t.preview_image_url,offset:((x=(S=s[f])==null?void 0:S.properties)==null?void 0:x.offset)??p.offset,scale:((C=(g=s[f])==null?void 0:g.properties)==null?void 0:C.scale)??p.scale,...h?{avatar_style:"circle"}:{}}}};r==="ALL"?v.forEach(a=>{a.variables.find(u=>u.type==="character")&&n(a.id)}):r&&n(r),z(s),j(ve(s));try{await Ne({template_id:T,user_id:(d=B.user)==null?void 0:d.id,deal_id:$.id,variables:s})}catch(a){console.error("[Parent] Error saving avatar to API",a)}Te(!1),ke(null)}}),e.jsx(Rr,{isModalOpen:Tt,setIsModalOpen:Qe,voices:ar,heygenVoiceIds:nr,loading:or,voiceKey:R,videoVariables:b,playingAudioId:Ze,handlePlayAudio:yt,handleVoiceSelect:Lt})]})]})}export{Qr as default};
